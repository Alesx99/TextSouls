<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TextSouls - Il Viaggio dell'Anima Perduta</title>
    <style>
        /* Import Google Fonts per Dark Souls */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        /* Palette colori Dark Souls - Versione Avanzata */
        :root {
            /* Oro antico - per elementi sacri */
            --ds-gold: #D4AF37;
            --ds-gold-dark: #B8860B;
            --ds-gold-light: #FFD700;
            --ds-gold-glow: #FFD700;
            
            /* Rosso sangue - per pericolo e morte */
            --ds-blood: #8B0000;
            --ds-blood-light: #DC143C;
            --ds-blood-dark: #4B0082;
            --ds-blood-glow: #FF0000;
            
            /* Grigio pietra - per strutture */
            --ds-stone: #696969;
            --ds-stone-light: #808080;
            --ds-stone-dark: #2F4F4F;
            --ds-stone-texture: #444444;
            
            /* Verde putrefazione - per veleno/maledizioni */
            --ds-poison: #228B22;
            --ds-poison-light: #32CD32;
            --ds-poison-dark: #006400;
            --ds-poison-glow: #00FF00;
            
            /* Blu profondo - per magia */
            --ds-magic: #191970;
            --ds-magic-light: #4169E1;
            --ds-magic-dark: #000080;
            --ds-magic-glow: #4169E1;
            
            /* Nero assoluto - per sfondo */
            --ds-black: #000000;
            --ds-black-light: #1a1a1a;
            --ds-black-dark: #0a0a0a;
            --ds-black-transparent: rgba(0, 0, 0, 0.8);
            
            /* Ombre e profondità */
            --ds-shadow-light: rgba(212, 175, 55, 0.3);
            --ds-shadow-dark: rgba(0, 0, 0, 0.7);
            --ds-shadow-glow: rgba(212, 175, 55, 0.5);
        }
        
        /* Texture pietra SVG avanzate - Versione Migliorata */
        .stone-texture {
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stone' patternUnits='userSpaceOnUse' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23333'/%3E%3Cpath d='M0,0 L100,0 L100,100 L0,100 Z' fill='none' stroke='%23444' stroke-width='1'/%3E%3Ccircle cx='20' cy='20' r='2' fill='%23555'/%3E%3Ccircle cx='80' cy='30' r='1.5' fill='%23444'/%3E%3Ccircle cx='40' cy='70' r='2.5' fill='%23555'/%3E%3Ccircle cx='70' cy='80' r='1' fill='%23444'/%3E%3Cpath d='M10,50 L30,50 L30,70 L10,70 Z' fill='%23444'/%3E%3Cpath d='M60,20 L80,20 L80,40 L60,40 Z' fill='%23555'/%3E%3Ccircle cx='50' cy='50' r='3' fill='%23666'/%3E%3Cpath d='M15,15 L25,15 L25,25 L15,25 Z' fill='%23555'/%3E%3Cpath d='M75,75 L85,75 L85,85 L75,85 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stone)'/%3E%3C/svg%3E");
        }
        
        /* Texture pietra alternativa per varietà */
        .stone-texture-alt {
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stoneAlt' patternUnits='userSpaceOnUse' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23222'/%3E%3Cpath d='M0,0 L100,0 L100,100 L0,100 Z' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='30' cy='30' r='4' fill='%23444'/%3E%3Ccircle cx='70' cy='70' r='3' fill='%23555'/%3E%3Cpath d='M20,60 L40,60 L40,80 L20,80 Z' fill='%23333'/%3E%3Cpath d='M60,20 L80,20 L80,40 L60,40 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stoneAlt)'/%3E%3C/svg%3E");
        }
        
        /* Effetti particellari fluttuanti - Versione Avanzata */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--ds-gold);
            border-radius: 50%;
            animation: float 6s infinite linear;
            opacity: 0.6;
            box-shadow: 0 0 4px var(--ds-gold-glow);
        }
        
        .particle:nth-child(odd) {
            background: var(--ds-gold-light);
            animation-duration: 8s;
            box-shadow: 0 0 6px var(--ds-gold-light);
        }
        
        .particle:nth-child(even) {
            background: var(--ds-gold-dark);
            animation-duration: 10s;
            box-shadow: 0 0 3px var(--ds-gold-dark);
        }
        
        /* Particelle per fuochi sacri */
        .sacred-fire-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--ds-gold-glow);
            border-radius: 50%;
            animation: sacredFloat 4s infinite ease-in-out;
            opacity: 0.8;
            box-shadow: 0 0 8px var(--ds-gold-glow);
        }
        
        .sacred-fire-particle:nth-child(3n) {
            background: var(--ds-gold-light);
            animation-duration: 3s;
            box-shadow: 0 0 10px var(--ds-gold-light);
        }
        
        .sacred-fire-particle:nth-child(3n+1) {
            background: var(--ds-gold);
            animation-duration: 5s;
            box-shadow: 0 0 6px var(--ds-gold);
        }
        
        @keyframes sacredFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 0.8;
                transform: scale(1);
            }
            80% {
                opacity: 0.8;
                transform: scale(1);
            }
            100% {
                transform: translateY(-10vh) translateX(50px) scale(0.5);
                opacity: 0;
            }
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-10vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* Effetti di nebbia atmosferica - Versione Avanzata */
        .fog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(105, 105, 105, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 0%, rgba(0, 0, 0, 0.05) 50%, transparent 100%);
            pointer-events: none;
            animation: fogDrift 20s ease-in-out infinite;
        }
        
        @keyframes fogDrift {
            0%, 100% { 
                opacity: 0.3;
                transform: translateX(0) translateY(0);
            }
            25% { 
                opacity: 0.5;
                transform: translateX(10px) translateY(-5px);
            }
            50% { 
                opacity: 0.4;
                transform: translateX(-5px) translateY(10px);
            }
            75% { 
                opacity: 0.6;
                transform: translateX(15px) translateY(5px);
            }
        }
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: fog-move 20s infinite ease-in-out;
        }
        
        @keyframes fog-move {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(0) translateY(0);
            }
            50% {
                opacity: 0.5;
                transform: translateX(-10px) translateY(-5px);
            }
        }
        
        /* Animazioni di transizione avanzate */
        .scene-transition {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        
        .fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease-in-out;
        }
        
        /* Effetto ripple per pulsanti */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: 
                linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2d1b3d 50%, #1a1a1a 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.4) 0%, transparent 70%);
            background-attachment: fixed;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            font-size: 16px; /* Base font size per responsive */
        }
        
        /* Aggiungi particelle al body */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(212, 175, 55, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(139, 0, 0, 0.1) 0%, transparent 40%);
            pointer-events: none;
            animation: background-shift 15s infinite ease-in-out;
        }
        
        @keyframes background-shift {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.05);
            }
        }

        /* Responsive design per diversi display */
        
        /* Tablet e schermi medi */
        @media (max-width: 1024px) {
            #game-container {
                width: 95%;
                max-width: 900px;
                height: 85vh;
            }
            
            #story-panel {
                flex: 2;
                min-width: 0;
            }
            
            #status-panel {
                flex: 1;
                min-width: 280px;
                max-width: 320px;
            }
            
            #title {
                font-size: 2em;
            }
            
            #text {
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            #game-container {
                width: 95%;
                height: 90vh;
                flex-direction: column;
                padding: 10px;
            }
            
            #story-panel {
                flex: 1;
                border-right: none;
                border-bottom: 1px solid #444;
                padding: 15px;
                min-height: 60vh;
            }
            
            #status-panel {
                flex: 0 0 auto;
                padding: 15px;
                max-height: 30vh;
                overflow-y: auto;
                min-height: 200px;
            }
            
            #title {
                font-size: 1.8em;
            }
            
            #text {
                font-size: 1em;
            }
            
            .choice-button {
                padding: 15px 20px;
                font-size: 1.1em;
                min-height: 50px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 12px;
            }
            
            #game-container {
                width: 98%;
                height: 95vh;
                padding: 5px;
            }
            
            #story-panel {
                min-height: 50vh;
            }
            
            #status-panel {
                max-height: 25vh;
                min-height: 150px;
            }
            
            #title {
                font-size: 1.5em;
            }
            
            #text {
                font-size: 0.9em;
            }
            
            .choice-button {
                padding: 12px 15px;
                font-size: 1em;
                min-height: 45px;
            }
        }

        @media (min-width: 1200px) {
            #game-container {
                max-width: 1200px;
                height: 85vh;
            }
            
            #story-panel {
                flex: 3;
            }
            
            #status-panel {
                flex: 1;
                min-width: 300px;
            }
            
            #title {
                font-size: 2.5em;
            }
            
            #text {
                font-size: 1.2em;
            }
        }

        #game-container {
            display: none; /* Nascondi all'inizio, verrà mostrato da JS */
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: 
                linear-gradient(145deg, #2b2b2b 0%, #1a1a1a 100%),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(212, 175, 55, 0.1) 10px,
                    rgba(212, 175, 55, 0.1) 20px
                ),
                radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
            border: 3px solid var(--ds-gold);
            border-radius: 8px;
            box-shadow: 
                0 0 20px rgba(212, 175, 55, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(139, 0, 0, 0.2);
            display: flex;
            flex-direction: row;
            overflow: hidden;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            align-items: stretch;
        }
        
        /* Aggiungi texture pietra al container */
        #game-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stone-detail' patternUnits='userSpaceOnUse' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23222'/%3E%3Cpath d='M0,0 L200,0 L200,200 L0,200 Z' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='40' cy='40' r='3' fill='%23444'/%3E%3Ccircle cx='160' cy='60' r='2' fill='%23333'/%3E%3Ccircle cx='80' cy='140' r='4' fill='%23444'/%3E%3Ccircle cx='140' cy='160' r='1.5' fill='%23333'/%3E%3Cpath d='M20,100 L60,100 L60,140 L20,140 Z' fill='%23333'/%3E%3Cpath d='M120,40 L160,40 L160,80 L120,80 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stone-detail)' opacity='0.1'/%3E%3C/svg%3E");
            pointer-events: none;
            border-radius: 8px;
            opacity: 0.3;
        }

        #game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            border-radius: 8px;
        }

        #story-panel {
            flex: 3;
            padding: 20px;
            background: 
                linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%);
            border-right: 2px solid var(--ds-gold);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            min-width: 0;
        }

        #story-panel::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, var(--ds-gold) 0%, transparent 50%, var(--ds-gold) 100%);
            box-shadow: 0 0 10px var(--ds-gold);
        }

        #title {
            font-family: 'Cinzel', serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--ds-gold-light);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 2px solid var(--ds-gold);
            padding-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #text {
            font-family: 'Crimson Text', serif;
            font-size: 1.1em;
            font-weight: 400;
            line-height: 1.8;
            margin-bottom: 25px;
            text-align: justify;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto; /* Spinge le scelte in basso */
        }

        .choice-button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%),
                radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
            color: var(--ds-gold-light);
            padding: 12px 20px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .choice-button:hover::before {
            left: 100%;
        }
        
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 5px 15px rgba(212, 175, 55, 0.4),
                0 0 20px rgba(212, 175, 55, 0.2);
            border-color: var(--ds-gold-light);
        }
        
        .choice-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(212, 175, 55, 0.3),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .choice-button {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            white-space: normal;
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            transition: left 0.5s ease;
        }

        /* Pulsanti specifici per la sidebar */
        #status-panel .choice-button {
            padding: 8px 12px;
            font-size: 0.85em;
            margin-bottom: 6px;
            min-height: 35px;
            line-height: 1.2;
        }

        .choice-button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 20px var(--ds-gold-glow),
                0 0 30px rgba(212, 175, 55, 0.4),
                inset 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
            text-shadow: 0 0 8px var(--ds-gold-glow);
        }

        .choice-button:hover::before {
            left: 100%;
        }

        #status-panel {
            flex: 1;
            padding: 15px;
            background: 
                linear-gradient(180deg, #3a3a3a 0%, #2b2b2b 100%);
            border-left: 2px solid var(--ds-gold);
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 1em;
            min-width: 300px;
            max-width: 350px;
            overflow-y: auto;
            justify-content: flex-start;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }

        #status-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, var(--ds-gold) 0%, transparent 50%, var(--ds-gold) 100%);
            box-shadow: 0 0 10px var(--ds-gold);
        }

        .status-section h3 {
            color: var(--ds-gold);
            font-family: 'Cinzel', serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0;
            margin-bottom: 8px;
            border-bottom: 2px solid var(--ds-gold);
            padding-bottom: 3px;
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Garantisce che i pulsanti siano sempre visibili */
        #status-panel {
            scrollbar-width: thin;
            scrollbar-color: #555 #3a3a3a;
        }

        #status-panel::-webkit-scrollbar {
            width: 8px;
        }

        #status-panel::-webkit-scrollbar-track {
            background: #3a3a3a;
        }

        #status-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        #status-panel::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        #inventory-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #inventory-list li {
            margin-bottom: 2px;
            font-size: 0.9em;
        }

        #sacred-fire-status {
            color: var(--ds-gold-light);
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            text-shadow: 0 0 10px var(--ds-gold);
            animation: firePulse 2s ease-in-out infinite;
        }

        @keyframes firePulse {
            0%, 100% { text-shadow: 0 0 10px var(--ds-gold); }
            50% { text-shadow: 0 0 20px var(--ds-gold), 0 0 30px var(--ds-gold); }
        }

        /* Schermata di avvio */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2d1b3d 50%, #1a1a1a 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.2) 0%, transparent 50%);
            background-attachment: fixed;
            color: #eee;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1001; /* Sopra tutto il resto */
        }

        #start-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5em;
            font-weight: 700;
            color: var(--ds-gold-light);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 30px var(--ds-gold); }
            to { text-shadow: 0 0 40px var(--ds-gold), 0 0 50px var(--ds-gold); }
        }

        /* Effetti particellari avanzati */
        .particle-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle-effect .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--ds-gold);
            border-radius: 50%;
            animation: particleFloat 8s infinite linear;
            opacity: 0.7;
            box-shadow: 0 0 6px var(--ds-gold-glow);
        }

        .particle-effect .particle:nth-child(odd) {
            background: var(--ds-gold-light);
            animation-duration: 10s;
            box-shadow: 0 0 8px var(--ds-gold-light);
        }

        .particle-effect .particle:nth-child(even) {
            background: var(--ds-gold-dark);
            animation-duration: 12s;
            box-shadow: 0 0 4px var(--ds-gold-dark);
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 0.7;
                transform: scale(1);
            }
            80% {
                opacity: 0.7;
                transform: scale(1);
            }
            100% {
                transform: translateY(-100px) translateX(100px) scale(0.5);
                opacity: 0;
            }
        }

        /* Effetti di combattimento */
        .combat-effect {
            position: fixed;
            font-family: 'Cinzel', serif;
            font-size: 2em;
            font-weight: bold;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: all 0.5s ease-in-out;
        }

        .combat-effect.damage {
            color: var(--ds-blood);
            text-shadow: 0 0 10px var(--ds-blood-glow);
        }

        .combat-effect.heal {
            color: var(--ds-poison-light);
            text-shadow: 0 0 10px var(--ds-poison-glow);
        }

        .combat-effect.souls {
            color: var(--ds-gold);
            text-shadow: 0 0 10px var(--ds-gold-glow);
        }

        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #start-screen button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%);
            color: var(--ds-gold-light);
            padding: 15px 30px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        #start-screen button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 15px rgba(212, 175, 55, 0.5),
                inset 0 0 10px rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        /* Schermata di morte */
        #death-screen {
            display: none; /* MODIFICA QUI: Inizialmente nascosta */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #000000 0%, #8B0000 25%, #DC143C 50%, #8B0000 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.4) 0%, transparent 50%);
            color: var(--ds-blood-light);
            font-family: 'Cinzel', serif;
            font-size: 3em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000; /* Sopra il gioco, sotto la schermata di avvio */
            text-shadow: 0 0 20px var(--ds-blood-light);
            animation: deathPulse 2s ease-in-out infinite;
        }

        @keyframes deathPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        #death-screen h2 {
            font-size: 1.5em;
            margin-top: 20px;
            color: var(--ds-gold);
            text-shadow: 0 0 15px var(--ds-gold);
            animation: deathGlow 3s ease-in-out infinite;
        }

        @keyframes deathGlow {
            0%, 100% { text-shadow: 0 0 15px var(--ds-gold); }
            50% { text-shadow: 0 0 25px var(--ds-gold), 0 0 35px var(--ds-gold); }
        }

        /* Schermata di vittoria */
        #victory-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #000000 0%, #2d1b3d 25%, #4B0082 50%, #2d1b3d 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.3) 0%, transparent 50%);
            color: #e0e0e0;
            font-size: 2em;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1002; /* Sopra tutto il resto */
        }

        #victory-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3em;
            color: var(--ds-gold-light);
            margin-bottom: 20px;
            text-shadow: 0 0 30px var(--ds-gold);
            animation: victoryGlow 3s ease-in-out infinite alternate;
        }

        @keyframes victoryGlow {
            from { 
                text-shadow: 0 0 30px var(--ds-gold); 
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px var(--ds-gold), 0 0 50px var(--ds-gold); 
                transform: scale(1.05);
            }
        }

        #victory-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.6;
        }

        #victory-stats {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 0.8em;
        }

        #victory-screen button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%);
            color: var(--ds-gold-light);
            padding: 15px 30px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        #victory-screen button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 25px var(--ds-gold-glow),
                0 0 35px rgba(212, 175, 55, 0.6),
                inset 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-3px);
            text-shadow: 0 0 10px var(--ds-gold-glow);
        }

        /* ANIMAZIONI E TRANSIZIONI - FASE 3 */
        
        /* Transizioni tra scene - Versione Avanzata */
        .scene-transition {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.6s ease-in-out;
            filter: blur(2px);
        }

        .scene-transition.fade-in {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0px);
        }
        
        /* Transizione speciale per combattimenti */
        .combat-transition {
            opacity: 0;
            transform: scale(1.1) rotate(2deg);
            transition: all 0.4s ease-out;
            filter: brightness(1.2) contrast(1.1);
        }
        
        .combat-transition.fade-in {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            filter: brightness(1) contrast(1);
        }
        
        /* Transizione per fuochi sacri */
        .sacred-transition {
            opacity: 0;
            transform: translateY(-10px) scale(0.9);
            transition: all 0.8s ease-in-out;
            filter: sepia(0.3) brightness(1.1);
        }
        
        .sacred-transition.fade-in {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: sepia(0) brightness(1);
        }

        /* Pulsazione per oggetti importanti */
        .important-item {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Effetti particellari per fuochi sacri - Versione Avanzata */
        .sacred-fire-effect {
            position: relative;
            overflow: hidden;
        }

        .sacred-fire-effect::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%),
                radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 50%);
            animation: sacredFireGlow 3s ease-in-out infinite;
            filter: blur(1px);
        }
        
        .sacred-fire-effect::after {
            content: '';
            position: absolute;
            top: -30%;
            left: -30%;
            width: 160%;
            height: 160%;
            background: 
                radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 60%);
            animation: sacredFireGlow 4s ease-in-out infinite reverse;
            filter: blur(2px);
        }

        @keyframes sacredFireGlow {
            0%, 100% { 
                opacity: 0.3; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2) rotate(180deg); 
            }
        }

        /* Animazioni per pulsanti */
        .choice-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .choice-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Effetto ripple per pulsanti */
        .choice-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .choice-button:active::after {
            width: 300px;
            height: 300px;
        }

        /* Animazioni per inventario */
        #inventory-list li {
            margin-bottom: 3px;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
        }

        #inventory-list li:hover {
            background-color: rgba(138, 255, 138, 0.1);
            transform: translateX(5px);
        }

        /* Animazione per nuovi oggetti */
        .new-item {
            animation: newItemGlow 1s ease-in-out;
        }

        @keyframes newItemGlow {
            0% { background-color: rgba(138, 255, 138, 0.5); transform: scale(1.1); }
            100% { background-color: transparent; transform: scale(1); }
        }

        /* Effetti per schermata di morte */
        #death-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: red;
            font-size: 3em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            animation: deathScreenFade 0.5s ease-in;
        }

        @keyframes deathScreenFade {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Animazioni per statistiche */
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            background-color: rgba(138, 255, 138, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Effetti per fuoco sacro */
        #sacred-fire-status {
            color: #8aff8a;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            animation: sacredFireText 2s ease-in-out infinite;
        }

        @keyframes sacredFireText {
            0%, 100% { text-shadow: 0 0 5px #8aff8a; }
            50% { text-shadow: 0 0 15px #8aff8a, 0 0 25px #8aff8a; }
        }

        /* Animazioni per achievement */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1003;
            animation: achievementSlide 0.5s ease-out, achievementGlow 2s ease-in-out infinite;
            max-width: 300px;
        }

        @keyframes achievementSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes achievementGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(76, 175, 80, 0.5); }
        }

        /* Animazioni per crafting */
        .crafting-success {
            animation: craftingSuccess 1s ease-in-out;
        }

        @keyframes craftingSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: rgba(138, 255, 138, 0.3); }
            100% { transform: scale(1); }
        }

        /* Responsive design migliorato */
        @media (max-width: 768px) {
            #game-container {
                width: 95%;
                height: 90vh;
                flex-direction: column;
            }

            #story-panel {
                flex: 1;
                border-right: none;
                border-bottom: 1px solid #444;
            }

            #status-panel {
                flex: 0 0 auto;
                max-height: 200px;
                overflow-y: auto;
            }

            .choice-button {
                padding: 15px 20px;
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            #title {
                font-size: 1.8em;
            }

            #text {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            #start-screen h1 {
                font-size: 2.5em;
            }

            #victory-screen h1 {
                font-size: 2em;
            }

            .choice-button {
                padding: 18px 20px;
                font-size: 1.2em;
            }
        }

        /* Sistema di Notifiche In-Game */
        .game-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, rgba(43, 43, 43, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
            border: 2px solid var(--ds-gold);
            border-radius: 8px;
            padding: 15px 20px;
            color: var(--ds-gold-light);
            font-family: 'Cinzel', serif;
            font-size: 1em;
            box-shadow: 0 0 20px var(--ds-gold-glow);
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.5s ease-in-out;
            max-width: 300px;
            opacity: 0;
        }

        .game-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .game-notification.achievement {
            border-color: var(--ds-gold-light);
            box-shadow: 0 0 25px var(--ds-gold-glow);
        }

        .game-notification.damage {
            border-color: var(--ds-blood);
            box-shadow: 0 0 25px var(--ds-blood-glow);
        }

        .game-notification.heal {
            border-color: var(--ds-poison-light);
            box-shadow: 0 0 25px var(--ds-poison-glow);
        }

        .game-notification.item {
            border-color: var(--ds-magic-light);
            box-shadow: 0 0 25px var(--ds-magic-glow);
        }

        .game-notification.souls {
            border-color: var(--ds-gold);
            box-shadow: 0 0 25px var(--ds-gold-glow);
        }
    </style>
</head>
<body>
    <!-- Elementi particellari fluttuanti -->
    <div class="particles" id="particles-container">
        <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
        <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
        <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
        <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
        <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
        <div class="particle" style="left: 90%; animation-delay: 8s;"></div>
        <div class="particle" style="left: 15%; animation-delay: 9s;"></div>
        <div class="particle" style="left: 25%; animation-delay: 10s;"></div>
        <div class="particle" style="left: 35%; animation-delay: 11s;"></div>
        <div class="particle" style="left: 45%; animation-delay: 12s;"></div>
        <div class="particle" style="left: 55%; animation-delay: 13s;"></div>
        <div class="particle" style="left: 65%; animation-delay: 14s;"></div>
        <div class="particle" style="left: 75%; animation-delay: 15s;"></div>
        <div class="particle" style="left: 85%; animation-delay: 16s;"></div>
        <div class="particle" style="left: 95%; animation-delay: 17s;"></div>
    </div>
    
    <!-- Overlay nebbia atmosferica -->
    <div class="fog-overlay"></div>
    
    <div id="start-screen">
        <h1>Il Viaggio dell'Anima Perduta</h1>
        <p>Ti risvegli in una cella umida e buia, senza memoria di come tu sia arrivato qui, o di chi tu sia. Una maledizione ti lega a vagare per l'eternità, a meno che tu non riesca a spezzarla. Questo è il tuo viaggio. Questo è il tuo destino.</p>
        <button onclick="startGame()">INIZIA IL VIAGGIO</button>
        <button onclick="loadGame()">CARICA PARTITA</button>
    </div>

    <div id="game-container">
        <!-- Elementi particellari per il gioco -->
        <div class="particles" id="game-particles">
            <div class="particle" style="left: 5%; animation-delay: 0s;"></div>
            <div class="particle" style="left: 15%; animation-delay: 2s;"></div>
            <div class="particle" style="left: 25%; animation-delay: 4s;"></div>
            <div class="particle" style="left: 35%; animation-delay: 6s;"></div>
            <div class="particle" style="left: 45%; animation-delay: 8s;"></div>
            <div class="particle" style="left: 55%; animation-delay: 10s;"></div>
            <div class="particle" style="left: 65%; animation-delay: 12s;"></div>
            <div class="particle" style="left: 75%; animation-delay: 14s;"></div>
            <div class="particle" style="left: 85%; animation-delay: 16s;"></div>
            <div class="particle" style="left: 95%; animation-delay: 18s;"></div>
        </div>
        
        <div id="story-panel">
            <h1 id="title"></h1>
            <p id="text"></p>
            <div id="choices"></div>
        </div>
        <div id="status-panel">
            <div class="status-section">
                <h3>Stato</h3>
                <div class="status-item">
                    <span>Salute:</span> <span id="health-display"></span>
                </div>
                <div class="status-item">
                    <span>Anime:</span> <span id="souls-display"></span>
                </div>
            </div>
            <div class="status-section">
                <h3>Inventario</h3>
                <ul id="inventory-list">
                    </ul>
            </div>
            <div class="status-section">
                <h3>Progressione</h3>
                <div class="status-item">
                    <span>Punto di Respawn:</span> <span id="last-sacred-fire-display"></span>
                </div>
                <div id="sacred-fire-status"></div>
            </div>
            <button class="choice-button" onclick="saveGame()">SALVA PARTITA</button>
            <button class="choice-button" onclick="confirmReset()">NUOVA PARTITA</button>
            <button class="choice-button" onclick="showAchievements()">🏆 ACHIEVEMENT</button>
            <button class="choice-button" onclick="showCraftingMenu()">⚗️ CRAFTING</button>
        </div>
    </div>

    <div id="notification-container"></div>

    <div id="death-screen">
        <!-- Particelle rosse per la schermata di morte -->
        <div class="particles" id="death-particles">
            <div class="particle" style="left: 10%; animation-delay: 0s; background: var(--ds-blood);"></div>
            <div class="particle" style="left: 30%; animation-delay: 1s; background: var(--ds-blood-light);"></div>
            <div class="particle" style="left: 50%; animation-delay: 2s; background: var(--ds-blood);"></div>
            <div class="particle" style="left: 70%; animation-delay: 3s; background: var(--ds-blood-light);"></div>
            <div class="particle" style="left: 90%; animation-delay: 4s; background: var(--ds-blood);"></div>
        </div>
        <h1>SEI MORTO</h1>
        <h2>Premi un tasto per tornare all'ultimo Fuoco Sacro...</h2>
    </div>

    <div id="victory-screen">
        <!-- Particelle dorate per la schermata di vittoria -->
        <div class="particles" id="victory-particles">
            <div class="particle" style="left: 10%; animation-delay: 0s; background: var(--ds-gold-light);"></div>
            <div class="particle" style="left: 30%; animation-delay: 1s; background: var(--ds-gold);"></div>
            <div class="particle" style="left: 50%; animation-delay: 2s; background: var(--ds-gold-light);"></div>
            <div class="particle" style="left: 70%; animation-delay: 3s; background: var(--ds-gold);"></div>
            <div class="particle" style="left: 90%; animation-delay: 4s; background: var(--ds-gold-light);"></div>
        </div>
        <h1>🎉 VITTORIA! 🎉</h1>
        <p>Hai spezzato la maledizione che ti legava a questo luogo! La tua memoria ritorna, e con essa, un senso di pace e libertà. Il viaggio è compiuto.</p>
        <div id="victory-stats">
            <h3>Statistiche Finali</h3>
            <p>Anime raccolte: <span id="final-souls">0</span></p>
            <p>Oggetti trovati: <span id="final-items">0</span></p>
            <p>Fuochi sacri accesi: <span id="final-fires">0</span></p>
        </div>
        <button onclick="newGame()">NUOVA PARTITA</button>
        <button onclick="returnToMenu()">TORNA AL MENU</button>
    </div>

    <script>
        // Funzioni per effetti particellari avanzati
        function createParticle(x, y, color, duration = 6) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + '%';
            particle.style.top = y + '%';
            particle.style.background = color;
            particle.style.animationDuration = duration + 's';
            return particle;
        }
        
        function addSacredFireParticles() {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                const particles = gameContainer.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-gold-light)';
                    particle.style.boxShadow = '0 0 10px var(--ds-gold-light)';
                });
            }
        }
        
        function addBloodParticles() {
            const deathScreen = document.getElementById('death-screen');
            if (deathScreen) {
                const particles = deathScreen.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-blood)';
                    particle.style.boxShadow = '0 0 10px var(--ds-blood)';
                });
            }
        }
        
        function addVictoryParticles() {
            const victoryScreen = document.getElementById('victory-screen');
            if (victoryScreen) {
                const particles = victoryScreen.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-gold-light)';
                    particle.style.boxShadow = '0 0 15px var(--ds-gold-light)';
                });
            }
        }
        
        // Funzione per animazioni di transizione avanzate
        function animateSceneTransition() {
            const storyPanel = document.getElementById('story-panel');
            if (storyPanel) {
                storyPanel.style.opacity = '0';
                storyPanel.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    storyPanel.style.transition = 'all 0.5s ease-in-out';
                    storyPanel.style.opacity = '1';
                    storyPanel.style.transform = 'translateY(0)';
                }, 100);
            }
        }
        
        // Variabili di stato del gioco
        let playerHealth;
        const maxHealth = 100;
        let souls;
        let inventory;
        let currentScene;
        let lastSacredFire;

        // Sistema di Notifiche In-Game
        let notificationQueue = [];
        let isShowingNotification = false;

        function showNotification(message, type = 'info', duration = 3000) {
            notificationQueue.push({ message, type, duration });
            if (!isShowingNotification) {
                processNotificationQueue();
            }
        }

        function processNotificationQueue() {
            if (notificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }
            
            isShowingNotification = true;
            const notification = notificationQueue.shift();
            displayNotification(notification.message, notification.type, notification.duration);
        }

        function displayNotification(message, type, duration) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            notification.className = `game-notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Animazione di entrata
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Rimozione automatica
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                    processNotificationQueue();
                }, 500);
            }, duration);
        }

        // Funzioni specifiche per tipo di notifica
        function showAchievementNotification(achievementName) {
            const message = `🏆 ACHIEVEMENT: ${achievementName}`;
            showNotification(message, 'achievement', 4000);
        }

        function showDamageNotification(damage, enemyType = '') {
            const message = `⚔️ Hai subito ${damage} danni${enemyType ? ` da ${enemyType}` : ''}`;
            showNotification(message, 'damage', 2500);
        }

        function showHealNotification(healAmount) {
            const message = `💚 Hai recuperato ${healAmount} HP`;
            showNotification(message, 'heal', 2500);
        }

        function showItemNotification(itemName, isNew = true) {
            const prefix = isNew ? '🎁 Nuovo oggetto:' : '📦 Oggetto:';
            const message = `${prefix} ${itemName}`;
            showNotification(message, 'item', 3000);
        }

        function showSoulsNotification(soulsAmount) {
            const message = `💀 +${soulsAmount} anime`;
            showNotification(message, 'souls', 2000);
        }

        // Sistema barre stato avanzate
        function updateHealthBar() {
            const healthBar = document.getElementById('health-bar');
            if (healthBar) {
                const healthPercentage = (playerHealth / maxHealth) * 100;
                
                healthBar.style.width = healthPercentage + '%';
                
                if (healthPercentage < 25) {
                    healthBar.style.backgroundColor = 'var(--ds-blood)';
                    healthBar.style.boxShadow = '0 0 10px var(--ds-blood-glow)';
                } else if (healthPercentage < 50) {
                    healthBar.style.backgroundColor = 'var(--ds-gold-dark)';
                    healthBar.style.boxShadow = '0 0 5px var(--ds-gold-glow)';
                } else {
                    healthBar.style.backgroundColor = 'var(--ds-gold)';
                    healthBar.style.boxShadow = 'none';
                }
            }
        }

        function updateSoulsBar() {
            const soulsBar = document.getElementById('souls-bar');
            if (soulsBar) {
                const soulsPercentage = Math.min((souls / 1000) * 100, 100); // Max 1000 anime
                soulsBar.style.width = soulsPercentage + '%';
                
                if (soulsPercentage > 80) {
                    soulsBar.style.backgroundColor = 'var(--ds-gold-light)';
                    soulsBar.style.boxShadow = '0 0 15px var(--ds-gold-glow)';
                } else if (soulsPercentage > 50) {
                    soulsBar.style.backgroundColor = 'var(--ds-gold)';
                    soulsBar.style.boxShadow = '0 0 8px var(--ds-gold-glow)';
                } else {
                    soulsBar.style.backgroundColor = 'var(--ds-gold-dark)';
                    soulsBar.style.boxShadow = 'none';
                }
            }
        }

        // Effetti combattimento avanzati
        function showCombatEffect(type, damage) {
            const effect = document.createElement('div');
            effect.className = `combat-effect ${type}`;
            effect.textContent = type === 'damage' ? `-${damage}` : `+${damage}`;
            
            // Posizione casuale sullo schermo
            effect.style.left = Math.random() * 80 + 10 + '%';
            effect.style.top = Math.random() * 60 + 20 + '%';
            
            document.body.appendChild(effect);
            
            // Animazione di entrata
            setTimeout(() => {
                effect.style.opacity = '1';
                effect.style.transform = 'translateY(-50px) scale(1.2)';
            }, 100);
            
            // Rimozione automatica
            setTimeout(() => {
                effect.style.opacity = '0';
                effect.style.transform = 'translateY(-100px) scale(0.8)';
                setTimeout(() => {
                    if (document.body.contains(effect)) {
                        document.body.removeChild(effect);
                    }
                }, 500);
            }, 1500);
        }

        function showScreenShake(intensity = 5) {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                gameContainer.style.animation = `screenShake ${intensity * 0.1}s ease-in-out`;
                setTimeout(() => {
                    gameContainer.style.animation = '';
                }, intensity * 100);
            }
        }

        // Sistema difficoltà dinamico
        let gameDifficulty = 1.0; // Moltiplicatore di difficoltà
        let difficultyLevel = 'Normale';

        function updateDifficulty() {
            // La difficoltà aumenta con il progresso del giocatore
            const progressFactor = (souls / 100) + (inventory.length * 0.1);
            gameDifficulty = Math.min(2.0, 1.0 + (progressFactor * 0.1));
            
            if (gameDifficulty >= 1.8) {
                difficultyLevel = 'Estrema';
            } else if (gameDifficulty >= 1.5) {
                difficultyLevel = 'Difficile';
            } else if (gameDifficulty >= 1.2) {
                difficultyLevel = 'Media';
            } else {
                difficultyLevel = 'Normale';
            }
            
            // Aggiorna l'UI con la difficoltà
            const difficultyDisplay = document.getElementById('difficulty-display');
            if (difficultyDisplay) {
                difficultyDisplay.textContent = `Difficoltà: ${difficultyLevel}`;
                difficultyDisplay.style.color = gameDifficulty >= 1.5 ? 'var(--ds-blood)' : 'var(--ds-gold)';
            }
        }

        function calculateDamage(baseDamage, enemyType = '') {
            let finalDamage = baseDamage * gameDifficulty;
            
            // Bonus di difficoltà per nemici specifici
            if (enemyType.includes('Golem')) {
                finalDamage *= 1.2;
            } else if (enemyType.includes('mummia')) {
                finalDamage *= 1.1;
            }
            
            return Math.floor(finalDamage);
        }

        // Flag per eventi specifici
        let hasKey = false;
        let hasMap = false;
        let foundSecretTunnel = false;
        let foughtGolem = false;
        let exploredDeepCrypt = false; // Nuovo flag per l'esplorazione profonda della cripta
        let hasPartialMemory = false; // Nuovo flag per ricordi parziali
        let hasAlertedGuards = false; // Nuovo flag per guardie allertate
        let hasDefeatedMummy = false; // Nuovo flag per mummia sconfitta
        
        // Variabili per Multiple Ending
        let playerChoices = {
            hasHelpedAlchemist: false,
            hasCollectedAllArtifacts: false,
            hasUsedDarkMagic: false,
            hasEscapedWithoutCure: false,
            hasAcceptedCurse: false
        };
        
        // Sistema Achievement
        let achievements = {
            firstDeath: false,
            golemSlayer: false,
            treasureHunter: false,
            memoryRecovery: false,
            curseBreaker: false,
            alchemistHelper: false,
            libraryScholar: false,
            secretExplorer: false
        };

        // Oggetto che definisce le scene del gioco
        const scenes = {
            cellaIniziale: {
                title: "Cella Umida",
                text: "Ti risvegli su un giaciglio di paglia bagnata. Le pareti sono di pietra grezza, l'aria è fredda e pesante di umidità e muffa. Una piccola grata in alto lascia intravedere un cielo grigio. Non ricordi nulla.",
                choices: [
                    { text: "Esplora la cella", nextScene: "esploraCella" },
                    { text: "Prova a ricordare", nextScene: "ricordaPassato" },
                    { text: "Grida aiuto", nextScene: "gridaAiuto" }
                ]
            },
            esploraCella: {
                title: "Esplorazione",
                text: "Scivoli lungo le pareti, sentendo la pietra fredda e scivolosa sotto le dita. In un angolo, dietro un mucchio di detriti, noti una fessura nel muro, quasi impercettibile. Potrebbe essere un passaggio...",
                choices: [
                    { text: "Tenta di allargare la fessura", nextScene: "tunnelSegreto" },
                    { text: "Cerca qualcos'altro nella cella", nextScene: "cercaNellaCella" }
                ]
            },
            tunnelSegreto: {
                title: "Tunnel Segreto",
                text: "Con fatica, riesci ad allargare la fessura quel tanto che basta per passarci attraverso. Ti ritrovi in un tunnel buio e stretto. L'aria è ancora più viziata.",
                onEnter: () => {
                    if (!foundSecretTunnel) {
                        foundSecretTunnel = true;
                        saveGame(); // Salva dopo aver trovato il tunnel
                        showAchievementNotification("Tunnel Segreto Scoperto");
                        showNotification("Progressi salvati!", "achievement", 3000);
                    }
                },
                choices: [
                    { text: "Procedi nel tunnel", nextScene: "cunicoloBuio" },
                    { text: "Torna alla cella", nextScene: "esploraCella" } // Aggiunta opzione di ritorno
                ]
            },
            cercaNellaCella: {
                title: "Cerca nella Cella",
                text: "Rovisti tra i detriti e la paglia. Tra la sporcizia, i tuoi occhi si posano su qualcosa che luccica debolmente. Una chiave arrugginita!",
                onEnter: () => {
                    if (!inventory.includes("Chiave Arrugginita")) {
                        inventory.push("Chiave Arrugginita");
                        hasKey = true;
                        updateUI();
                        showItemNotification("Chiave Arrugginita", true);
                    } else {
                        showNotification("Non trovi nulla di nuovo qui.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Tenta di aprire la porta con la chiave", nextScene: "tentativoPorta" },
                    { text: "Torna a esplorare la fessura", nextScene: "esploraCella" }
                ]
            },
            tentativoPorta: {
                title: "La Porta della Cella",
                text: "La vecchia porta di ferro è massiccia e arrugginita.",
                requiredItems: ["Chiave Arrugginita"],
                choices: [
                    { text: "Avanza nel corridoio", nextScene: "corridoioOscuro" }
                ],
                failedText: "La porta è chiusa a chiave. Ti serve qualcosa per aprirla."
            },
            corridoioOscuro: {
                title: "Corridoio Oscuro",
                text: "Il corridoio si estende davanti a te, illuminato solo da sporadiche fiaccole morenti. L'aria è ferma. Senti un debole ronzio provenire da una direzione.",
                choices: [
                    { text: "Segui il ronzio", nextScene: "salaGolem" },
                    { text: "Procedi cautamente in avanti", nextScene: "biforcazione" }
                ]
            },
            biforcazione: { // Nuova scena per spezzare il ciclo e dare più scelte
                title: "Bivio nel Corridoio",
                text: "Il corridoio si biforca. A sinistra, senti un leggero fruscio d'acqua e un sentore di umidità. A destra, il buio è più denso e profondo.",
                onEnter: () => {
                    // 35% di probabilità di scelta sbagliata
                    if (Math.random() < 0.35) {
                        const damage = Math.floor(Math.random() * 16) + 10; // Danno 10-25 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "percorso pericoloso");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Prendi il passaggio a sinistra", nextScene: "passaggioUmidito" },
                    { text: "Prendi il passaggio a destra", nextScene: "passaggioProfondo" },
                    { text: "Torna indietro", nextScene: "corridoioOscuro" }
                ]
            },
            passaggioUmidito: {
                title: "Pozza d'Acqua",
                text: "Il passaggio conduce a una piccola pozza d'acqua sotterranea. L'acqua è fresca e potabile. Trovi alcune vecchie monete sul bordo.",
                onEnter: () => {
                    // 50% di probabilità di malattia
                    if (Math.random() < 0.5) {
                        const damage = Math.floor(Math.random() * 8) + 3; // Danno 3-10 HP
                        playerHealth -= damage;
                        // Riduzione temporanea della salute massima
                        maxHealth = Math.max(80, maxHealth - 5);
                        showDamageNotification(damage, "acqua contaminata");
                        showNotification("Salute massima ridotta!", "damage", 3000);
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    } else {
                        souls += 10;
                        playerHealth = Math.min(maxHealth, playerHealth + 10); // Piccolo recupero salute
                        updateUI();
                        showHealNotification(10);
                        showSoulsNotification(10);
                    }
                },
                choices: [
                    { text: "Torna al bivio", nextScene: "biforcazione" }
                ]
            },
            passaggioProfondo: {
                title: "Nido di Ratti",
                text: "Il passaggio buio porta a un piccolo nido di ratti giganti. Ti attaccano non appena ti avvicini!",
                onEnter: () => {
                    const damage = Math.floor(Math.random() * 10) + 5; // Danno tra 5 e 14
                    playerHealth -= damage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(damage, "ratti");
                    }
                },
                choices: [
                    { text: "Scappa e torna al bivio", nextScene: "biforcazione" },
                    { text: "Continua ad esplorare", nextScene: "nidoRattiProfondo" }
                ]
            },
            nidoRattiProfondo: { // Nuova scena di progressione
                title: "Dietro il Nido",
                text: "Con cautela, superi il nido. Dietro di esso, trovi una piccola nicchia con una vecchia Sacca di Cuoio.",
                onEnter: () => {
                    if (!inventory.includes("Sacca di Cuoio")) {
                        inventory.push("Sacca di Cuoio");
                        souls += 20; // Contiene 20 anime
                        updateUI();
                        showItemNotification("Sacca di Cuoio", true);
                        showSoulsNotification(20);
                    } else {
                        showNotification("Non c'è più nulla da trovare qui.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Torna indietro al bivio", nextScene: "biforcazione" }
                ]
            },
            salaGolem: {
                title: "La Sala del Golem",
                text: "Il ronzio si fa più forte. Entri in una grande sala. Al centro, un imponente Golem di pietra, ricoperto di muschio, blocca il passaggio principale. I suoi occhi di giada si accendono al tuo arrivo.",
                onEnter: () => {
                    if (!foughtGolem) {
                        text.textContent += "\nIl Golem ti carica!";
                        const initialDamage = Math.floor(Math.random() * 10) + 5; // Danno tra 5 e 14
                        playerHealth -= initialDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(initialDamage, "Golem");
                        }
                    } else {
                        text.textContent = "Il Golem sconfitto giace inerte, il passaggio è libero.";
                    }
                },
                choices: [
                    { text: "Attacca il Golem", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Cerca un punto debole", nextScene: "cercaPuntoDebole", condition: () => !foughtGolem },
                    { text: "Tenta di aggirarlo", nextScene: "tentaAggiramento", condition: () => !foughtGolem },
                    { text: "Prosegui oltre il Golem", nextScene: "dopoGolem", condition: () => foughtGolem }
                ]
            },
            combattiGolem: {
                title: "Scontro con il Golem",
                text: "Il Golem carica con un ruggito roccioso. È un colosso di pietra, ogni suo pugno è come un macigno. Continui a combattere.",
                onEnter: () => {
                    if (!foughtGolem) {
                        // Aumento danni da 10-24 a 15-34
                        const damage = Math.floor(Math.random() * 20) + 15; // Danno tra 15 e 34
                        
                        // 30% di probabilità di attacco speciale (danno extra)
                        const specialAttack = Math.random() < 0.3;
                        let totalDamage = damage;
                        let message = `Hai subito ${damage} danni.`;
                        
                        if (specialAttack) {
                            const extraDamage = Math.floor(Math.random() * 10) + 5; // Danno extra 5-14
                            totalDamage += extraDamage;
                            message = `Il Golem sferra un attacco speciale! Hai subito ${damage} + ${extraDamage} = ${totalDamage} danni totali.`;
                        }
                        
                        playerHealth -= totalDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(totalDamage, "Golem");
                        }
                    }
                },
                choices: [
                    { text: "Colpisci ancora", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Usa Mappa Rudimentale", onSelect: () => useItem("Mappa Rudimentale", "sconfiggiGolem", "Non hai la Mappa Rudimentale."), condition: () => !foughtGolem && inventory.includes("Mappa Rudimentale") },
                    { text: "Cerca di fuggire", nextScene: "corridoioOscuro", condition: () => !foughtGolem && playerHealth > 25 }
                ]
            },
            cercaPuntoDebole: {
                title: "Ricerca del Punto Debole",
                text: "Studi i movimenti del Golem, cercando una falla nella sua corazza di pietra. Noti una crepa nel suo braccio destro e un'anomalia nel suo petto, dove una runa brilla debolmente.",
                choices: [
                    { text: "Attacca il braccio", nextScene: "attaccaBraccioGolem", condition: () => !foughtGolem },
                    { text: "Tocca la runa sul petto", nextScene: "toccaRunaGolem", condition: () => !foughtGolem },
                    { text: "Torna a combattere", nextScene: "combattiGolem", condition: () => !foughtGolem }
                ]
            },
            attaccaBraccioGolem: {
                title: "Attacco al Braccio",
                text: "Sferri un colpo deciso al braccio crepato del Golem. Con un sonoro 'CRACK', il braccio si stacca parzialmente, rallentando le sue mosse. È il momento di finirlo!",
                onEnter: () => {
                    if (!foughtGolem) {
                        showNotification("Il Golem è stato indebolito!", "achievement", 3000);
                    }
                },
                choices: [
                    { text: "Sferra il colpo finale!", nextScene: "sconfiggiGolem" }
                ]
            },
            toccaRunaGolem: {
                title: "La Runa sul Petto",
                text: "Con audacia, allunghi la mano e tocchi la runa brillante sul petto del Golem. Una scarica di energia ti attraversa, ma il Golem barcolla e la sua aura si affievolisce. Sembra un punto vitale!",
                onEnter: () => {
                    if (!foughtGolem) {
                        alert("Il Golem è stato significativamente indebolito!");
                    }
                },
                choices: [
                    { text: "Sferra il colpo finale!", nextScene: "sconfiggiGolem" }
                ]
            },
            sconfiggiGolem: {
                title: "Vittoria sul Golem",
                text: "Il Golem, indebolito, crolla a terra con un boato che fa tremare la sala. La runa sul suo petto si spegne. Il passaggio è libero. Trovi anche un piccolo sacchetto di tela con alcune anime.",
                onEnter: () => {
                    if (!foughtGolem) {
                        souls += 50;
                        foughtGolem = true;
                        updateUI();
                        saveGame();
                        showAchievementNotification("Golem Sconfitto");
                        showSoulsNotification(50);
                    }
                },
                choices: [
                    { text: "Prosegui oltre il Golem", nextScene: "dopoGolem" }
                ]
            },
            tentaAggiramento: {
                title: "Tenta di Aggirare",
                text: "Cerchi di muoverti furtivamente lungo le pareti della sala, sperando di non attirare l'attenzione del Golem. Ma fa un rumore, e il Golem si gira!",
                onEnter: () => {
                    const damage = Math.floor(Math.random() * 15) + 5; // Danno minore
                    playerHealth -= damage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(damage, "Golem");
                    }
                },
                choices: [
                    { text: "Attacca il Golem", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Cerca un punto debole", nextScene: "cercaPuntoDebole", condition: () => !foughtGolem },
                    { text: "Prova a fuggire", nextScene: "corridoioOscuro", condition: () => !foughtGolem }
                ]
            },
            dopoGolem: {
                title: "Passaggio Libero",
                text: "Oltre la sala del Golem, il corridoio prosegue, rivelando un'uscita verso l'esterno. La luce fioca del crepuscolo filtra attraverso le rocce. Sei libero dalla prigione!",
                onEnter: () => {
                    updateSacredFire("fuocoSacroPrigione");
                },
                choices: [
                    { text: "Esci nella natura selvaggia", nextScene: "terreSelvagge" }
                ]
            },
            terreSelvagge: {
                title: "Terre Selvagge",
                text: "Il vento ti accarezza il viso mentre esci all'aperto. Ti trovi in un vasto altopiano roccioso, costellato di arbusti secchi e imponenti formazioni rocciose. All'orizzonte, vedi le luci di quella che sembra una piccola città.",
                onEnter: () => {
                    // 40% di probabilità di incontro con predatori
                    if (Math.random() < 0.4) {
                        const damage = Math.floor(Math.random() * 13) + 8; // Danno 8-20 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "predatori");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                    
                    if (lastSacredFire !== "fuocoSacroTerre") {
                        updateSacredFire("fuocoSacroTerre");
                    }
                },
                choices: [
                    { text: "Dirigiti verso la città", nextScene: "ingressoCitta" },
                    { text: "Esplora le rovine vicine", nextScene: "rovineTempio" },
                    { text: "Cerca risorse nelle terre selvagge", nextScene: "cercaRisorseSelvaggie" } // Nuova opzione
                ]
            },
            cercaRisorseSelvaggie: { // Nuova scena
                title: "Cerca Risorse",
                text: "Rovisti tra gli arbusti e le rocce. Trovi alcune bacche commestibili e un piccolo gruppo di anime.",
                onEnter: () => {
                    // 25% di probabilità di piante velenose
                    if (Math.random() < 0.25) {
                        const damage = Math.floor(Math.random() * 8) + 5; // Danno 5-12 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "piante velenose");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                    
                    souls += 15;
                    playerHealth = Math.min(maxHealth, playerHealth + 5); // Piccolo recupero salute
                    
                    // Possibilità di trovare ingredienti di crafting
                    const randomChance = Math.random();
                    if (randomChance < 0.3 && !inventory.includes("Erba Curativa")) {
                        inventory.push("Erba Curativa");
                        showItemNotification("Erba Curativa", true);
                        showHealNotification(5);
                        showSoulsNotification(15);
                    } else if (randomChance < 0.5 && !inventory.includes("Erba di Forza")) {
                        inventory.push("Erba di Forza");
                        showItemNotification("Erba di Forza", true);
                        showHealNotification(5);
                        showSoulsNotification(15);
                    } else if (randomChance < 0.7 && !inventory.includes("Acqua Pura")) {
                        inventory.push("Acqua Pura");
                        showItemNotification("Acqua Pura", true);
                        showHealNotification(5);
                        showSoulsNotification(15);
                    } else {
                        showSoulsNotification(15);
                        showHealNotification(5);
                    }
                    
                    updateUI();
                },
                choices: [
                    { text: "Continua a esplorare le terre selvagge", nextScene: "terreSelvagge" },
                    { text: "Dirigiti verso la città", nextScene: "ingressoCitta" }
                ]
            },
            ingressoCitta: {
                title: "Ingresso della Città",
                text: "Ti avvicini a quella che sembra una città di frontiera, circondata da un muro di legno. Dalle strade, senti le voci della gente e il rumore di attrezzi. Sembra un luogo sicuro.",
                onEnter: () => {
                    // 20% di probabilità di guardie sospettose
                    if (Math.random() < 0.2) {
                        const damage = Math.floor(Math.random() * 6) + 3; // Danno 3-8 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "guardie sospettose");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Entra in città", nextScene: "distrettoMercantile" },
                    { text: "Cerca un Fuoco Sacro", nextScene: "cercaFuocoSacro" },
                    { text: "Torna alle Terre Selvagge", nextScene: "terreSelvagge" }
                ]
            },
            distrettoMercantile: {
                title: "Distretto Mercantile",
                text: "Le strade sono affollate di mercanti che espongono le loro merci. L'odore di spezie e cuoio riempie l'aria. Vedi bancarelle di armi, armature, pozioni e curiosità.",
                choices: [
                    { text: "Visita il mercante di pozioni", nextScene: "mercantePozioni" },
                    { text: "Cerca informazioni", nextScene: "informazioniMercantili" },
                    { text: "Torna all'ingresso della città", nextScene: "ingressoCitta" }
                ]
            },
            informazioniMercantili: {
                title: "Informazioni dal Mercato",
                text: "Parlare con i mercanti ti rivela informazioni preziose. Un vecchio mercante ti racconta di un alchimista che vive nelle Terre Selvagge, mentre un altro menziona un antico tempio con tesori nascosti. 'Se cerchi conoscenza antica', dice uno, 'dovresti visitare la biblioteca della città.'",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    showSoulsNotification(20);
                },
                choices: [
                    { text: "Cerca l'alchimista nelle Terre Selvagge", nextScene: "laboratorioAlchimista" },
                    { text: "Visita la biblioteca della città", nextScene: "bibliotecaAntica" },
                    { text: "Torna al distretto mercantile", nextScene: "distrettoMercantile" }
                ]
            },
            mercantePozioni: {
                title: "Mercante di Pozioni",
                text: "Un anziano con un naso aquilino e occhi acuti ti accoglie dietro un tavolo pieno di fiale luccicanti. 'Salute, straniero! Cosa ti serve?'",
                choices: [
                    { text: "Compra Pozione di Salute (35 anime)", onSelect: () => buyItem("Pozione di Salute", 35, "mercantePozioni") },
                    { text: "Lascia il negozio", nextScene: "distrettoMercantile" }
                ]
            },
            ricordaPassato: {
                title: "Tentativo di Ricordo Fallito",
                text: "Chiudi gli occhi e ti concentri. Immagini sfocate di una foresta, un simbolo su una lapide, un volto sconosciuto. Nulla di chiaro, solo frustrazione.",
                onEnter: () => {
                    if (!hasPartialMemory) {
                        hasPartialMemory = true;
                        souls += 5; // Piccola ricompensa per il tentativo
                        updateUI();
                        showAchievementNotification("Frammento di Memoria");
                        showSoulsNotification(5);
                    }
                },
                choices: [
                    { text: "Continua a concentrarti", nextScene: "ricordoParziale" },
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            ricordoParziale: {
                title: "Frammenti di Memoria",
                text: "Concentrandoti ulteriormente, alcuni frammenti emergono dalla nebbia della tua mente. Vedi una foresta di alberi giganti, un antico tempio in rovina, e una figura vestita di nero che ti guarda. Il ricordo è doloroso ma illuminante.",
                onEnter: () => {
                    if (hasPartialMemory && !inventory.includes("Frammento di Memoria")) {
                        inventory.push("Frammento di Memoria");
                        souls += 15;
                        updateUI();
                        showItemNotification("Frammento di Memoria", true);
                        showSoulsNotification(15);
                    }
                },
                choices: [
                    { text: "Segui il ricordo del tempio", nextScene: "sogniRicordi" },
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            gridaAiuto: {
                title: "Grida Inascoltate",
                text: "Le tue grida echeggiano nella cella, ma nessuno risponde. Solo il silenzio e il gocciolio dell'acqua. La solitudine ti avvolge.",
                onEnter: () => {
                    if (!hasAlertedGuards) {
                        hasAlertedGuards = true;
                        const damage = Math.floor(Math.random() * 5) + 1; // Danno minore per il rumore
                        playerHealth -= damage;
                        updateUI();
                        showDamageNotification(damage, "rumore");
                    }
                },
                choices: [
                    { text: "Aspetta una risposta", nextScene: "guardieArrivano" },
                    { text: "Riprova a esplorare", nextScene: "esploraCella" }
                ]
            },
            sogniRicordi: {
                title: "Sogni del Passato",
                text: "Il ricordo ti porta in un sogno vivido. Sei nel tempio che hai visto, ma è intatto e splendente. Una figura vestita di nero ti guarda con occhi che brillano di energia arcana. 'La maledizione ti lega a questo luogo', dice la voce. 'Solo gli antichi artefatti possono spezzarla.'",
                onEnter: () => {
                    if (!inventory.includes("Conoscenza del Passato")) {
                        inventory.push("Conoscenza del Passato");
                        souls += 25;
                        updateUI();
                        showItemNotification("Conoscenza del Passato", true);
                        showSoulsNotification(25);
                    }
                },
                choices: [
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            cunicoloBuio: {
                title: "Nel Cunicolo",
                text: "Strisci nel buio per quello che sembra un'eternità. Il tunnel si apre in una piccola grotta. Sul fondo, vedi una luce flebile e un oggetto che luccica.",
                onEnter: () => {
                    // 30% di probabilità di danno casuale
                    if (Math.random() < 0.3) {
                        const damage = Math.floor(Math.random() * 5) + 1; // Danno 1-5 HP
                        playerHealth -= damage;
                        
                        // 20% di probabilità di perdere oggetti casuali
                        if (Math.random() < 0.2 && inventory.length > 0) {
                            const lostItem = inventory[Math.floor(Math.random() * inventory.length)];
                            inventory = inventory.filter(item => item !== lostItem);
                            showDamageNotification(damage, "cunicolo pericoloso");
                            showNotification(`Oggetto perso: ${lostItem}`, "damage", 3000);
                        } else {
                            showDamageNotification(damage, "cunicolo pericoloso");
                        }
                        
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Raggiungi la luce", nextScene: "grottaLuminosa" },
                    { text: "Torna indietro", nextScene: "tunnelSegreto" }
                ]
            },
            grottaLuminosa: {
                title: "Grotta della Luce",
                text: "La luce proviene da un cristallo incastonato nella roccia. Accanto ad esso, trovi una Mappa Rudimentale, disegnata su una pergamena invecchiata.",
                onEnter: () => {
                    // 20% di probabilità di incontro con creature
                    if (Math.random() < 0.2) {
                        const damage = Math.floor(Math.random() * 11) + 5; // Danno 5-15 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "creature oscure");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                    
                    if (!inventory.includes("Mappa Rudimentale")) {
                        inventory.push("Mappa Rudimentale");
                        hasMap = true;
                        updateUI();
                        showItemNotification("Mappa Rudimentale", true);
                    } else {
                        showNotification("Hai già preso la mappa. Il cristallo brilla.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Cerca un'altra uscita", nextScene: "uscitaGrotta" },
                    { text: "Torna nel cunicolo", nextScene: "cunicoloBuio" } // Opzione di ritorno
                ]
            },
            uscitaGrotta: {
                title: "Uscita della Grotta",
                text: "Seguendo un'altra galleria, emergi in un'area più ampia, che sembra una vecchia sezione delle prigioni, ma in disuso. Vedi una porta in legno che sembra portare all'esterno.",
                onEnter: () => {
                    // 15% di probabilità di trappola
                    if (Math.random() < 0.15) {
                        const damage = Math.floor(Math.random() * 6) + 3; // Danno 3-8 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "trappola");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Apri la porta", nextScene: "uscitaPrigione" },
                    { text: "Torna alla grotta", nextScene: "grottaLuminosa" } // Opzione di ritorno
                ]
            },
            uscitaPrigione: {
                title: "Uscita dalle Prigioni",
                text: "Apri la porta con cautela. Ti ritrovi in un cortile diroccato, con alte mura. Un sentiero sterrato si snoda verso l'orizzonte. Finalmente libero!",
                choices: [
                    { text: "Prendi il sentiero", nextScene: "terreSelvagge" }
                ]
            },
            rovineTempio: {
                title: "Rovine del Tempio",
                text: "Un antico tempio in rovina sorge maestoso contro il cielo. Colonne spezzate e muri coperti di edera raccontano storie di un'epoca passata. Senti una strana energia emanare dalle rovine.",
                onEnter: () => {
                    // 30% di probabilità di crollo
                    if (Math.random() < 0.3) {
                        const damage = Math.floor(Math.random() * 16) + 15; // Danno 15-30 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "crollo");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Entra nel tempio", nextScene: "internoTempio" },
                    { text: "Cerca manufatti tra le macerie", nextScene: "cercaManufatti" },
                    { text: "Torna alle Terre Selvagge", nextScene: "terreSelvagge" }
                ]
            },
            internoTempio: {
                title: "Interno del Tempio",
                text: "L'interno è silenzioso, rotto solo dal fruscio del vento tra le pietre. Al centro, un altare scheggiato reca incisioni indecifrabili. Una luce fioca illumina un'apertura nel pavimento.",
                onEnter: () => {
                    // 40% di probabilità di trappole antiche
                    if (Math.random() < 0.4) {
                        const damage = Math.floor(Math.random() * 11) + 10; // Danno 10-20 HP
                        playerHealth -= damage;
                        alert(`Una trappola antica si attiva! Hai perso ${damage} HP!`);
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Scendi nell'apertura", nextScene: "criptaAntica" },
                    { text: "Esamina l'altare", nextScene: "esaminaAltare" },
                    { text: "Esci dal tempio", nextScene: "rovineTempio" }
                ]
            },
            criptaAntica: {
                title: "Cripta Antica",
                text: "Un'atmosfera gelida ti accoglie nella cripta. Le pareti sono decorate con affreschi sbiaditi di figure spettrali. Al centro, un sarcofago di pietra sembra emanare un'aura maligna.",
                onEnter: () => {
                    // 60% di probabilità di maledizione
                    if (Math.random() < 0.6) {
                        const damage = Math.floor(Math.random() * 11) + 5; // Danno 5-15 HP
                        playerHealth -= damage;
                        // Effetti negativi permanenti
                        maxHealth = Math.max(70, maxHealth - 10);
                        alert(`Una maledizione antica ti avvolge! Hai perso ${damage} HP e la tua salute massima è ridotta permanentemente!`);
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Apri il sarcofago", nextScene: "apriSarcofago" },
                    { text: "Cerca tesori nascosti", nextScene: "cercaTesoriCripta" },
                    { text: "Prosegui più in profondità", nextScene: "criptaProfonda", condition: () => !exploredDeepCrypt },
                    { text: "Torna all'ingresso del tempio", nextScene: "internoTempio" }
                ]
            },
            criptaProfonda: { // Nuova scena di progressione
                title: "Passaggio Segreto della Cripta",
                text: "Trovi un passaggio nascosto dietro un falso muro. Ti porta a una stanza più profonda della cripta, dove l'aria è densa di magia. C'è un pilastro con una runa brillante e un'antica pergamena.",
                onEnter: () => {
                    if (!exploredDeepCrypt) {
                        exploredDeepCrypt = true;
                        if (!inventory.includes("Pergamena di Rune")) {
                            inventory.push("Pergamena di Rune");
                            showItemNotification("Pergamena di Rune", true);
                        }
                        souls += 40;
                        lastSacredFire = "fuocoSacroTempio";
                        updateUI();
                        saveGame();
                        showSoulsNotification(40);
                        showAchievementNotification("Cripta Profonda Esplorata");
                        showNotification("Salvato al Fuoco Sacro del Tempio!", "achievement", 3000);
                    } else {
                        showNotification("Sei già stato qui. La runa brilla fiocamente.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Tocca la runa", onSelect: () => touchRune("criptaProfonda") },
                    { text: "Torna alla cripta principale", nextScene: "criptaAntica" }
                ]
            },
            apriSarcofago: {
                title: "Il Sarcofago",
                text: "Sollevi il pesante coperchio del sarcofago. All'interno, un'antica mummia giace, con un amuleto luccicante stretto nella mano scheletrica. Mentre lo afferri, la mummia si anima!",
                onEnter: () => {
                    if (!hasDefeatedMummy) {
                        const mummyDamage = Math.floor(Math.random() * 20) + 10; // Danno tra 10 e 29
                        playerHealth -= mummyDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            if (!inventory.includes("Amuleto Antico")) {
                                inventory.push("Amuleto Antico");
                                updateUI();
                                showDamageNotification(mummyDamage, "mummia");
                                showItemNotification("Amuleto Antico", true);
                            } else {
                                showDamageNotification(mummyDamage, "mummia");
                            }
                        }
                    }
                },
                choices: [
                    { text: "Combatti la mummia", nextScene: "combattiMummia", condition: () => !hasDefeatedMummy },
                    { text: "Fuggi dalla cripta", nextScene: "criptaAntica", condition: () => !hasDefeatedMummy },
                    { text: "Esamina il sarcofago vuoto", nextScene: "criptaAntica", condition: () => hasDefeatedMummy }
                ]
            },
            combattiMummia: {
                title: "Combattimento con la Mummia",
                text: "La mummia si alza dal sarcofago con movimenti innaturali. I suoi occhi brillano di energia maligna. Devi combattere per sopravvivere!",
                onEnter: () => {
                    if (!hasDefeatedMummy) {
                        // Aumento danni da 10-24 a 12-28
                        const mummyDamage = Math.floor(Math.random() * 17) + 12; // Danno tra 12 e 28
                        
                        // 25% di probabilità di maledizione (riduzione salute massima)
                        const curse = Math.random() < 0.25;
                        let message = `La mummia ti attacca! Hai subito ${mummyDamage} danni.`;
                        
                        if (curse) {
                            maxHealth = Math.max(50, maxHealth - 5); // Riduzione salute massima di 5 punti
                            message = `La mummia ti attacca con una maledizione! Hai subito ${mummyDamage} danni e la tua salute massima è stata ridotta di 5 punti.`;
                        }
                        
                        playerHealth -= mummyDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(mummyDamage, "mummia");
                            if (curse) {
                                showNotification("Salute massima ridotta!", "damage", 3000);
                            }
                        }
                    }
                },
                choices: [
                    { text: "Attacca con la spada", nextScene: "combattiMummia", condition: () => !hasDefeatedMummy && inventory.includes("Spada Arrugginita") },
                    { text: "Usa l'Amuleto Antico", onSelect: () => useAmulet("combattiMummia"), condition: () => !hasDefeatedMummy && inventory.includes("Amuleto Antico") },
                    { text: "Tenta di fuggire", nextScene: "fugaMummia", condition: () => !hasDefeatedMummy && playerHealth > 30 },
                    { text: "Finisci la mummia", nextScene: "sconfiggiMummia", condition: () => !hasDefeatedMummy && playerHealth > 20 }
                ]
            },
            cercaTesoriCripta: {
                title: "Tesori Nascosti",
                text: "Rovistando negli angoli bui della cripta, trovi un piccolo forziere di legno. Contiene 30 anime e una pergamena con rune misteriose.",
                onEnter: () => {
                    if (!inventory.includes("Pergamena di Rune")) { // Assicurati di non aggiungerla due volte se trovata altrove
                        inventory.push("Pergamena di Rune");
                        souls += 30;
                        updateUI();
                        showSoulsNotification(30);
                        showItemNotification("Pergamena di Rune", true);
                    } else {
                        souls += 30; // Solo anime se hai già la pergamena
                        updateUI();
                        showSoulsNotification(30);
                    }
                },
                choices: [
                    { text: "Torna all'apertura", nextScene: "criptaAntica" }
                ]
            },
            fugaMummia: {
                title: "Fuga dalla Mummia",
                text: "Decidi di fuggire dalla mummia. Corri attraverso la cripta mentre la creatura ti insegue con movimenti innaturali. La fuga è rischiosa!",
                onEnter: () => {
                    // Fuga disponibile solo con salute > 20 e 50% di probabilità di fallimento
                    if (playerHealth <= 20) {
                        alert("Sei troppo debole per fuggire! Salute insufficiente.");
                        loadScene("criptaAntica");
                        return;
                    }
                    
                    const escapeSuccess = Math.random();
                    if (escapeSuccess < 0.5) {
                        // Fuga fallita
                        const failedDamage = Math.floor(Math.random() * 15) + 10;
                        playerHealth -= failedDamage;
                        showDamageNotification(failedDamage, "fuga fallita");
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            loadScene("criptaAntica");
                        }
                    } else {
                        // Fuga riuscita
                        const escapeDamage = Math.floor(Math.random() * 8) + 3;
                        playerHealth -= escapeDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(escapeDamage, "fuga");
                        }
                    }
                },
                choices: [
                    { text: "Torna alla cripta", nextScene: "criptaAntica" },
                    { text: "Esci dal tempio", nextScene: "internoTempio" }
                ]
            },
            sconfiggiMummia: {
                title: "Vittoria sulla Mummia",
                text: "Con un ultimo sforzo, riesci a sconfiggere la mummia! La creatura crolla a terra, tornando polvere. Il sarcofago è ora sicuro da esplorare.",
                onEnter: () => {
                    hasDefeatedMummy = true;
                    souls += 40;
                    updateUI();
                    saveGame();
                    alert("Hai sconfitto la mummia e ottenuto 40 anime!");
                },
                choices: [
                    { text: "Esplora il sarcofago", nextScene: "criptaAntica" },
                    { text: "Torna alla cripta", nextScene: "criptaAntica" }
                ]
            },
            esaminaAltare: {
                title: "Esamina Altare",
                text: "Le incisioni sull'altare sono complesse e aliene. Senti un debole richiamo, come un sussurro nella tua mente. Potrebbe essere legato alla maledizione.",
                choices: [
                    { text: "Medita sull'altare", onSelect: () => meditateAltare("internoTempio") },
                    { text: "Torna indietro", nextScene: "internoTempio" }
                ]
            },
            cercaManufatti: {
                title: "Ricerca di Manufatti",
                text: "Cerchi tra le rovine all'esterno. Tra le macerie, trovi 10 anime. Una vecchia spada arrugginita giace rotta a terra, ma noti che potrebbe essere riparata.",
                onEnter: () => {
                    souls += 10;
                    if (!inventory.includes("Spada Arrugginita")) {
                        inventory.push("Spada Arrugginita");
                        updateUI();
                        alert("Hai trovato 10 anime e una Spada Arrugginita!");
                    } else {
                        alert("Hai trovato 10 anime.");
                    }
                    
                    // Possibilità di trovare ingredienti di crafting
                    const randomChance = Math.random();
                    if (randomChance < 0.4 && !inventory.includes("Cristallo di Potenza")) {
                        inventory.push("Cristallo di Potenza");
                        alert("Hai trovato un Cristallo di Potenza nelle rovine!");
                    } else if (randomChance < 0.6 && !inventory.includes("Cristallo di Anima")) {
                        inventory.push("Cristallo di Anima");
                        alert("Hai trovato un Cristallo di Anima nelle rovine!");
                    }
                    
                    updateUI();
                },
                choices: [
                    { text: "Esamina la spada più da vicino", nextScene: "manufattiTrovati" },
                    { text: "Torna alle Terre Selvagge", nextScene: "rovineTempio" }
                ]
            },
            manufattiTrovati: {
                title: "Manufatti Trovati",
                text: "Esamini la spada arrugginita più da vicino. Nonostante l'aspetto trasandato, riconosci i segni di un'antica forgiatura. Potrebbe essere riparata da un fabbro esperto. Inoltre, trovi un passaggio nascosto dietro una colonna crollata.",
                onEnter: () => {
                    if (!inventory.includes("Spada Arrugginita")) {
                        alert("Non hai la spada da esaminare.");
                        return;
                    }
                    souls += 15;
                    updateUI();
                    alert("Hai trovato un passaggio segreto e ottenuto 15 anime!");
                },
                choices: [
                    { text: "Esplora il passaggio segreto", nextScene: "passaggioSegreto" },
                    { text: "Torna alle rovine", nextScene: "rovineTempio" }
                ]
            },
            cercaFuocoSacro: {
                title: "Cerca Fuoco Sacro",
                text: "Mentre cerchi un luogo per riposare, trovi un antico Fuoco Sacro, le cui fiamme danzano pigramente. Tuttavia, noti che le fiamme sembrano più deboli del solito e richiedono un'offerta per essere attivate.",
                onEnter: () => {
                    // Il fuoco sacro della città è stato rimosso per aumentare la sfida
                    alert("Questo Fuoco Sacro è stato spento. Devi trovare un altro punto di riposo.");
                },
                choices: [
                    { text: "Continua a esplorare", nextScene: "ingressoCitta" },
                    { text: "Cerca un altro rifugio", nextScene: "distrettoMercantile" }
                ]
            },
            // Le scene per il "finale" o per l'avanzamento della trama sulla maledizione andrebbero aggiunte qui
            // esempio:
            santuarioFinale: {
                title: "Santuario della Maledizione",
                text: "Giungi in un santuario nascosto, dove l'aria vibra di energia arcana. Al centro, un'antica maledizione si manifesta come una nebbia oscura e pulsante. La tua scelta qui determinerà il destino della tua anima.",
                onEnter: () => {
                    // Controlla se il giocatore ha tutti gli artefatti
                    playerChoices.hasCollectedAllArtifacts = inventory.includes("Amuleto Antico") && 
                                                           inventory.includes("Pergamena di Rune") && 
                                                           inventory.includes("Gemma Preziosa") &&
                                                           inventory.includes("Corona dell'Anima");
                    
                    souls += 50;
                    updateUI();
                    alert("Hai raggiunto il Santuario della Maledizione! +50 anime.");
                },
                choices: [
                    { text: "Spezza la maledizione", nextScene: "finaleBuono", condition: () => playerChoices.hasCollectedAllArtifacts },
                    { text: "Accetta la maledizione per potere", nextScene: "sceltaOscura" },
                    { text: "Fuggi senza spezzare la maledizione", nextScene: "sceltaNeutrale" },
                    { text: "Torna indietro", nextScene: "terreSelvagge" }
                ]
            },
            passaggioSegreto: {
                title: "Passaggio Segreto",
                text: "Il passaggio nascosto ti porta in una stanza segreta delle rovine. L'aria è densa di polvere antica. Su un altare di pietra, trovi un antico amuleto che brilla di energia arcana.",
                onEnter: () => {
                    if (!inventory.includes("Amuleto delle Rovine")) {
                        inventory.push("Amuleto delle Rovine");
                        souls += 30;
                        updateUI();
                        alert("Hai trovato un Amuleto delle Rovine e ottenuto 30 anime!");
                    }
                },
                choices: [
                    { text: "Torna alle rovine", nextScene: "rovineTempio" },
                    { text: "Esplora ulteriormente", nextScene: "cameraTesori" }
                ]
            },
            finaleBuono: {
                title: "La Redenzione Completa - Finale Buono",
                text: "Un silenzio sacro avvolge il santuario mentre posizioni gli antichi artefatti nei loro luoghi sacri. L'Amuleto Antico brilla con luce purificatrice, la Pergamena di Rune si illumina con rune dorate, la Gemma Preziosa pulsa di energia vitale, e la Corona dell'Anima emana un'aura di saggezza millenaria.\n\nUn coro di voci antiche risuona dalle pareti del santuario mentre la maledizione si dissolve in una cascata di luce cristallina. Ogni frammento della tua memoria perduta ritorna, non come un'inondazione caotica, ma come un fiume di consapevolezza che ti riempie di pace profonda.\n\nLa nebbia oscura si trasforma in una pioggia di stelle dorate che danzano nell'aria. Il santuario stesso sembra respirare, liberato dal peso della maledizione. La tua anima, ora completamente integra, risplende di una luce interiore che non si spegnerà mai più.\n\nHai non solo spezzato la maledizione, ma hai anche guarito le ferite che aveva inflitto al mondo. Il tuo viaggio è compiuto con onore, saggezza e un amore profondo per la vita che hai riconquistato.",
                onEnter: () => {
                    playerChoices.hasHelpedAlchemist = true;
                    achievements.curseBreaker = true;
                    showVictoryScreen("BUONO");
                },
                choices: []
            },
            finaleOscuro: {
                title: "L'Ascensione delle Tenebre - Finale Oscuro",
                text: "La maledizione ti parla con una voce che sembra provenire dalle profondità del tempo stesso. 'Accettami,' sussurra, 'e diventerai più di quello che sei mai stato.' Il suo potere oscuro fluisce attraverso di te come un fiume di ombra liquida, trasformando ogni cellula del tuo essere.\n\nLa nebbia non ti avvolge più - tu DIVENTI la nebbia. La tua memoria ritorna, ma ora è filtrata attraverso la lente della maledizione, rivelando verità che gli altri non possono vedere. Il dolore del mondo, la futilità della speranza, la bellezza del caos - tutto ti è chiaro.\n\nIl santuario trema mentre il tuo nuovo potere si manifesta. Le pareti si ricoprono di rune oscure che pulsano al ritmo del tuo cuore trasformato. La maledizione non ti controlla più - tu la controlli, la modelli, la espandi.\n\nHai ottenuto un potere immenso, accesso a conoscenze proibite che risalgono all'alba del tempo. La tua anima è ora una fusione di luce e ombra, umano e divino, mortale e immortale. Sei diventato qualcosa di nuovo, qualcosa di terribilmente bello.",
                onEnter: () => {
                    playerChoices.hasAcceptedCurse = true;
                    playerChoices.hasUsedDarkMagic = true;
                    showVictoryScreen("OSCURO");
                },
                choices: []
            },
            sceltaOscura: {
                title: "La Scelta Oscura",
                text: "La maledizione ti parla direttamente nella mente, la sua voce un sussurro che risuona nelle profondità della tua anima: 'Vedo la tua essenza, viaggiatore. Sei più di quello che credi di essere. Accettami, e ti rivelerò i segreti che gli dei stessi hanno dimenticato. Diventerai parte di me, e io parte di te - una fusione perfetta di potere e conoscenza. La tua anima sarà trasformata, ma avrai accesso a verità che risalgono all'alba del tempo, a poteri arcani che pochi hanno osato sognare.'\n\nIl suo richiamo è come una melodia ipnotica che risuona in ogni fibra del tuo essere, promettendo non solo potere, ma comprensione assoluta.",
                onEnter: () => {
                    souls += 100;
                    updateUI();
                    alert("La maledizione ti offre potere in cambio della tua anima!");
                },
                choices: [
                    { text: "Accetta il potere della maledizione", nextScene: "finaleOscuro" },
                    { text: "Rifiuta e torna indietro", nextScene: "santuarioFinale" }
                ]
            },
            sceltaNeutrale: {
                title: "La Scelta di Fuggire",
                text: "Guardando la maledizione pulsante nel santuario, una realizzazione profonda ti travolge. Non è paura quella che senti, ma una saggezza antica che parla attraverso i secoli. La sfida che ti si presenta non è solo fisica o magica - è filosofica.\n\nA volte la vera forza non sta nell'affrontare ogni battaglia con spada in pugno, ma nel sapere quale battaglia vale la pena combattere e quando è il momento di ritirarsi per prepararsi meglio. La maledizione continuerà a esistere, ma forse non è il tuo destino combatterla ora.\n\nForse la vera saggezza sta nel riconoscere i propri limiti, nel comprendere che ogni scelta ha il suo momento, e che la pazienza può essere la più grande delle virtù.",
                onEnter: () => {
                    souls += 25;
                    updateUI();
                    alert("Decidi che la sopravvivenza è più importante della gloria.");
                },
                choices: [
                    { text: "Conferma la fuga", nextScene: "finaleNeutrale" },
                    { text: "Ripensa e torna indietro", nextScene: "santuarioFinale" }
                ]
            },
            finaleNeutrale: {
                title: "La Saggezza della Sopravvivenza - Finale Neutrale",
                text: "Guardando la maledizione pulsante nel santuario, una realizzazione profonda ti travolge. Non è codardia quella che senti, ma saggezza antica. A volte la vera forza non sta nell'affrontare ogni battaglia, ma nel sapere quale battaglia vale la pena combattere.\n\nLa maledizione continua a pulsare, ma ora la guardi con occhi diversi. Non è più una minaccia da sconfiggere o un potere da conquistare, ma semplicemente una parte del mondo, come la pioggia o il vento. La tua memoria ritorna parzialmente, ma è sufficiente per comprendere che la perfezione non esiste.\n\nMentre ti allontani dal santuario, senti la nebbia che si dissolve alle tue spalle, ma non come una sconfitta. È come se il mondo stesso ti stesse dando il permesso di scegliere il tuo destino. La maledizione rimane, ma ora la vedi per quello che è: una sfida da affrontare quando sarai pronto, non una prigione da cui fuggire.\n\nHai scelto la via della saggezza, della pazienza, della comprensione. Il tuo viaggio non è finito - è solo iniziato in modo diverso. A volte la vera vittoria sta nel sapere quando è il momento di ritirarsi e prepararsi per la prossima battaglia.",
                onEnter: () => {
                    playerChoices.hasEscapedWithoutCure = true;
                    showVictoryScreen("NEUTRALE");
                },
                choices: []
            },
            finaleVittoria: {
                title: "La Maledizione Spezzata!",
                text: "Con gli antichi artefatti al loro posto, un'onda di luce purificatrice esplode dal santuario, disperdendo la nebbia. La maledizione è spezzata. La tua memoria ritorna, e con essa, un senso di pace. Il viaggio è compiuto.",
                onEnter: () => {
                    showVictoryScreen();
                },
                choices: []
            },
            // NUOVE SCENE FASE 2 - ESPANSIONE CONTENUTI
            ricordoParziale: {
                title: "Ricordi Frammentari",
                text: "Un'ondata di ricordi frammentari ti travolge. Vedi immagini confuse: una torre antica, un rituale, una maledizione. I pezzi del puzzle iniziano a combaciare, ma manca ancora qualcosa di fondamentale.",
                onEnter: () => {
                    hasPartialMemory = true;
                    souls += 25;
                    updateUI();
                    alert("Hai recuperato ricordi parziali! +25 anime.");
                },
                choices: [
                    { text: "Continua a meditare", nextScene: "sogniRicordi" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            sogniRicordi: {
                title: "Sogni e Ricordi",
                text: "I tuoi sogni si mescolano con i ricordi. Vedi un antico alchimista che lavora su una pozione, un rituale che va male, e la nascita della maledizione. Ora capisci meglio la tua missione.",
                onEnter: () => {
                    souls += 30;
                    updateUI();
                    alert("I sogni ti hanno rivelato la verità! +30 anime.");
                },
                choices: [
                    { text: "Cerca l'alchimista", nextScene: "laboratorioAlchimista" },
                    { text: "Torna alle terre selvagge", nextScene: "terreSelvagge" }
                ]
            },
            guardieArrivano: {
                title: "Le Guardie Arrivano",
                text: "Le tue grida hanno attirato l'attenzione delle guardie! Sentono rumori di passi pesanti che si avvicinano. Devi decidere rapidamente cosa fare.",
                onEnter: () => {
                    hasAlertedGuards = true;
                    const guardDamage = Math.floor(Math.random() * 10) + 5;
                    playerHealth -= guardDamage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(guardDamage, "guardie");
                    }
                },
                choices: [
                    { text: "Combatti le guardie", nextScene: "combattiGuardie" },
                    { text: "Fuggi rapidamente", nextScene: "fugaGuardie" },
                    { text: "Nasconditi", nextScene: "nasconditiGuardie" }
                ]
            },
            combattiGuardie: {
                title: "Combattimento con le Guardie",
                text: "Tre guardie in armatura pesante ti circondano. Sono ben addestrate e coordinate. Il combattimento sarà difficile!",
                onEnter: () => {
                    // Aumento danni da 5-14 a 8-18
                    const guardDamage = Math.floor(Math.random() * 11) + 8; // Danno tra 8 e 18
                    
                    // 20% di probabilità di chiamata rinforzi (danno extra)
                    const reinforcements = Math.random() < 0.2;
                    let totalDamage = guardDamage;
                    let message = `Le guardie ti attaccano! Hai subito ${guardDamage} danni.`;
                    
                    if (reinforcements) {
                        const extraDamage = Math.floor(Math.random() * 8) + 3; // Danno extra 3-10
                        totalDamage += extraDamage;
                        message = `Le guardie chiamano rinforzi! Hai subito ${guardDamage} + ${extraDamage} = ${totalDamage} danni totali.`;
                    }
                    
                    playerHealth -= totalDamage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(totalDamage, "guardie");
                    }
                },
                choices: [
                    { text: "Attacca con la spada", nextScene: "combattiGuardie", condition: () => inventory.includes("Spada Arrugginita") },
                    { text: "Usa l'Amuleto Antico", onSelect: () => useAmulet("combattiGuardie"), condition: () => inventory.includes("Amuleto Antico") },
                    { text: "Tenta di fuggire", nextScene: "fugaGuardie" }
                ]
            },
            fugaGuardie: {
                title: "Fuga dalle Guardie",
                text: "Decidi di fuggire! Corri attraverso i corridoi bui, sentendo le grida delle guardie dietro di te. La fuga è rischiosa!",
                onEnter: () => {
                    // Fuga disponibile solo con salute > 20 e 50% di probabilità di fallimento
                    if (playerHealth <= 20) {
                        alert("Sei troppo debole per fuggire! Salute insufficiente.");
                        loadScene("combattiGuardie");
                        return;
                    }
                    
                    const escapeSuccess = Math.random();
                    if (escapeSuccess < 0.5) {
                        // Fuga fallita
                        const failedDamage = Math.floor(Math.random() * 12) + 8;
                        playerHealth -= failedDamage;
                        showDamageNotification(failedDamage, "fuga fallita");
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            loadScene("combattiGuardie");
                        }
                    } else {
                        // Fuga riuscita
                        const escapeDamage = Math.floor(Math.random() * 8) + 2;
                        playerHealth -= escapeDamage;
                        souls += 15;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(escapeDamage, "fuga");
                            showSoulsNotification(15);
                        }
                    }
                },
                choices: [
                    { text: "Torna alla cella", nextScene: "cellaIniziale" },
                    { text: "Esplora nuovi corridoi", nextScene: "corridoiNascosti" }
                ]
            },
            nasconditiGuardie: {
                title: "Nascondersi dalle Guardie",
                text: "Ti nascondi abilmente in un angolo buio. Le guardie passano di corsa senza notarti. Hai evitato il combattimento, ma ora devi essere più cauto.",
                onEnter: () => {
                    // 40% di probabilità di essere scoperti
                    const discovered = Math.random() < 0.4;
                    
                    if (discovered) {
                        const damage = Math.floor(Math.random() * 10) + 5; // Danno 5-14
                        playerHealth -= damage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(damage, "guardie");
                        }
                    } else {
                        souls += 10;
                        updateUI();
                        alert("Ti sei nascosto con successo! +10 anime.");
                    }
                },
                choices: [
                    { text: "Torna alla cella", nextScene: "cellaIniziale" },
                    { text: "Esplora silenziosamente", nextScene: "corridoiNascosti" }
                ]
            },
            corridoiNascosti: {
                title: "Corridoi Nascosti",
                text: "Hai scoperto una rete di corridoi nascosti nella prigione. Sono bui e pericolosi, ma potrebbero portarti a luoghi interessanti. L'aria è densa di mistero.",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    alert("Hai trovato corridoi nascosti! +20 anime.");
                },
                choices: [
                    { text: "Esplora più a fondo", nextScene: "cameraSegreta" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            cameraSegreta: {
                title: "Camera Segreta",
                text: "In una camera segreta trovi un antico libro di incantesimi e una pozione misteriosa. Sembrano essere stati lasciati qui da un prigioniero precedente.",
                onEnter: () => {
                    // Riduzione disponibilità pozioni del 50%
                    const potionChance = Math.random();
                    if (potionChance < 0.5 && !inventory.includes("Pozione di Forza")) {
                        inventory.push("Pozione di Forza");
                        souls += 25;
                        updateUI();
                        alert("Hai trovato un libro di incantesimi e una Pozione di Forza! +25 anime.");
                    } else {
                        souls += 25;
                        updateUI();
                        alert("Hai trovato un libro di incantesimi! +25 anime.");
                    }
                },
                choices: [
                    { text: "Torna ai corridoi", nextScene: "corridoiNascosti" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            laboratorioAlchimista: {
                title: "Laboratorio dell'Alchimista",
                text: "Trovi un antico laboratorio alchemico. Bottiglie, alambicchi e ingredienti strani riempiono gli scaffali. Un vecchio alchimista sta lavorando su una pozione.",
                onEnter: () => {
                    souls += 30;
                    updateUI();
                    alert("Hai trovato il laboratorio dell'alchimista! +30 anime.");
                },
                choices: [
                    { text: "Parla con l'alchimista", nextScene: "dialogoAlchimista" },
                    { text: "Esamina le pozioni", nextScene: "esaminaPozioni" },
                    { text: "Usa il laboratorio per crafting", nextScene: "craftingMenu" },
                    { text: "Torna indietro", nextScene: "sogniRicordi" }
                ]
            },
            dialogoAlchimista: {
                title: "Dialogo con l'Alchimista",
                text: "L'alchimista ti riconosce! 'Sei tu quello della maledizione...' dice. 'Ho lavorato per anni per trovare una cura. Posso aiutarti, ma avrò bisogno di ingredienti rari.'",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    alert("L'alchimista può aiutarti! +20 anime.");
                },
                choices: [
                    { text: "Accetta l'aiuto", nextScene: "ricettaCura" },
                    { text: "Chiedi informazioni", nextScene: "infoMaledizione" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            ricettaCura: {
                title: "La Ricetta della Cura",
                text: "L'alchimista ti mostra una ricetta complessa. 'Avrai bisogno di: 3 erbe rare, 50 anime, e l'Amuleto Antico. Se riesci a trovare questi ingredienti, posso creare la pozione che spezzerà la maledizione.'",
                onEnter: () => {
                    souls += 15;
                    updateUI();
                    alert("Hai ottenuto la ricetta della cura! +15 anime.");
                },
                choices: [
                    { text: "Cerca le erbe rare", nextScene: "cercaErbe" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            infoMaledizione: {
                title: "Informazioni sulla Maledizione",
                text: "L'alchimista ti racconta: 'La maledizione fu creata da un antico culto. Colpisce la memoria e l'anima. Solo con gli artefatti giusti e la pozione corretta può essere spezzata.'",
                onEnter: () => {
                    souls += 25;
                    updateUI();
                    alert("Hai ottenuto informazioni preziose! +25 anime.");
                },
                choices: [
                    { text: "Chiedi della ricetta", nextScene: "ricettaCura" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            cercaErbe: {
                title: "Cerca delle Erbe Rare",
                text: "L'alchimista ti indica dove trovare le erbe rare: nelle Terre Selvagge, vicino alle rovine del tempio. Dovrai essere attento, sono ben nascoste.",
                onEnter: () => {
                    souls += 10;
                    updateUI();
                    alert("Sai dove cercare le erbe! +10 anime.");
                },
                choices: [
                    { text: "Vai alle Terre Selvagge", nextScene: "terreSelvagge" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            esaminaPozioni: {
                title: "Esamina le Pozioni",
                text: "Esamini le pozioni dell'alchimista. Molte sono pericolose, ma alcune potrebbero essere utili. Vedi una 'Pozione di Forza' che sembra sicura.",
                onEnter: () => {
                    // Riduzione disponibilità pozioni del 50%
                    const potionChance = Math.random();
                    if (potionChance < 0.5 && !inventory.includes("Pozione di Forza")) {
                        inventory.push("Pozione di Forza");
                        souls += 20;
                        updateUI();
                        alert("Hai trovato una Pozione di Forza! +20 anime.");
                    } else {
                        souls += 20;
                        updateUI();
                        alert("Hai esaminato le pozioni! +20 anime.");
                    }
                },
                choices: [
                    { text: "Parla con l'alchimista", nextScene: "dialogoAlchimista" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftingMenu: {
                title: "Menu di Crafting",
                text: "L'alchimista ti permette di usare il suo laboratorio per creare pozioni e oggetti magici. Hai bisogno di ingredienti specifici e anime per ogni ricetta.",
                onEnter: () => {
                    souls += 10;
                    updateUI();
                    showCraftingMenu();
                },
                choices: [
                    { text: "Crea Pozione di Salute", nextScene: "craftPozioneSalute" },
                    { text: "Crea Pozione di Forza", nextScene: "craftPozioneForza" },
                    { text: "Crea Amuleto Potenziato", nextScene: "craftAmuletoPotenziato" },
                    { text: "Crea Pozione della Cura", nextScene: "craftPozioneCura" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            bibliotecaAntica: {
                title: "Biblioteca Antica",
                text: "Una vasta biblioteca piena di tomi polverosi. I libri contengono conoscenze antiche sulla maledizione e sui rituali per spezzarla. Potresti trovare informazioni preziose.",
                onEnter: () => {
                    souls += 35;
                    updateUI();
                    alert("Hai trovato la biblioteca antica! +35 anime.");
                },
                choices: [
                    { text: "Cerca informazioni sulla maledizione", nextScene: "ricercaMaledizione" },
                    { text: "Esplora i libri di incantesimi", nextScene: "libriIncantesimi" },
                    { text: "Torna indietro", nextScene: "terreSelvagge" }
                ]
            },
            craftPozioneSalute: {
                title: "Crea Pozione di Salute",
                text: "Preparati a creare una Pozione di Salute. Hai bisogno di Erba Curativa e Acqua Pura.",
                onEnter: () => {
                    if (craftItem("Pozione di Salute")) {
                        alert("Crafting completato con successo!");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftPozioneForza: {
                title: "Crea Pozione di Forza",
                text: "Preparati a creare una Pozione di Forza. Hai bisogno di Erba di Forza e Cristallo di Potenza.",
                onEnter: () => {
                    if (craftItem("Pozione di Forza")) {
                        alert("Crafting completato con successo!");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftAmuletoPotenziato: {
                title: "Crea Amuleto Potenziato",
                text: "Preparati a creare un Amuleto Potenziato. Hai bisogno di Amuleto Antico, Pergamena di Rune e Gemma Preziosa.",
                onEnter: () => {
                    if (craftItem("Amuleto Potenziato")) {
                        alert("Crafting completato con successo!");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftPozioneCura: {
                title: "Crea Pozione della Cura",
                text: "Preparati a creare la Pozione della Cura. Hai bisogno di Erba Rara, Amuleto Antico e Cristallo di Anima.",
                onEnter: () => {
                    if (craftItem("Pozione della Cura")) {
                        alert("Crafting completato con successo!");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            ricercaMaledizione: {
                title: "Ricerca sulla Maledizione",
                text: "Nei libri antichi trovi informazioni cruciali: la maledizione fu creata usando l'Amuleto Antico e la Pergamena di Rune. Per spezzarla, devi usare gli stessi artefatti in un rituale inverso.",
                onEnter: () => {
                    souls += 40;
                    updateUI();
                    alert("Hai trovato informazioni cruciali! +40 anime.");
                },
                choices: [
                    { text: "Cerca il rituale inverso", nextScene: "ritualeInverso" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            ritualeInverso: {
                title: "Il Rituale Inverso",
                text: "Hai trovato la descrizione del rituale inverso! Richiede: l'Amuleto Antico, la Pergamena di Rune, 100 anime, e deve essere eseguito nel Santuario della Maledizione.",
                onEnter: () => {
                    souls += 50;
                    updateUI();
                    alert("Hai scoperto il rituale inverso! +50 anime.");
                },
                choices: [
                    { text: "Vai al Santuario", nextScene: "santuarioFinale" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            libriIncantesimi: {
                title: "Libri di Incantesimi",
                text: "I libri di incantesimi contengono formule complesse. Alcune potrebbero essere utili per il tuo viaggio. Trovi anche una mappa del tempio antico.",
                onEnter: () => {
                    if (!inventory.includes("Mappa del Tempio")) {
                        inventory.push("Mappa del Tempio");
                        souls += 30;
                        updateUI();
                        alert("Hai trovato una Mappa del Tempio! +30 anime.");
                    } else {
                        souls += 30;
                        updateUI();
                        alert("Hai esaminato i libri di incantesimi! +30 anime.");
                    }
                },
                choices: [
                    { text: "Cerca informazioni sulla maledizione", nextScene: "ricercaMaledizione" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            cameraTesori: {
                title: "Camera dei Tesori",
                text: "Una camera segreta piena di tesori! Oro, gemme e artefatti antichi riempiono la stanza. Al centro, un forziere dorato attira la tua attenzione.",
                onEnter: () => {
                    souls += 100;
                    if (!inventory.includes("Gemma Preziosa")) {
                        inventory.push("Gemma Preziosa");
                        updateUI();
                        alert("Hai trovato una camera dei tesori! +100 anime e una Gemma Preziosa!");
                    } else {
                        updateUI();
                        alert("Hai trovato una camera dei tesori! +100 anime!");
                    }
                },
                choices: [
                    { text: "Apri il forziere dorato", nextScene: "forziereDorato" },
                    { text: "Torna al passaggio segreto", nextScene: "passaggioSegreto" }
                ]
            },
            forziereDorato: {
                title: "Il Forziere Dorato",
                text: "Il forziere dorato contiene un antico artefatto: la 'Corona dell'Anima'. È un oggetto di potere immenso che potrebbe essere la chiave per spezzare definitivamente la maledizione.",
                onEnter: () => {
                    if (!inventory.includes("Corona dell'Anima")) {
                        inventory.push("Corona dell'Anima");
                        souls += 150;
                        updateUI();
                        alert("Hai trovato la Corona dell'Anima! +150 anime!");
                    }
                },
                choices: [
                    { text: "Torna alla camera dei tesori", nextScene: "cameraTesori" },
                    { text: "Vai al Santuario", nextScene: "santuarioFinale" }
                ]
            },
            santuarioIntermedio: {
                title: "Santuario Intermedio",
                text: "Un santuario più piccolo ma comunque sacro. Le fiamme del fuoco sacro danzano dolcemente. Tuttavia, noti che le fiamme sembrano più deboli e richiedono un'offerta per essere attivate.",
                onEnter: () => {
                    // Il santuario intermedio è stato disabilitato per aumentare la sfida
                    alert("Questo santuario è stato disabilitato. Devi trovare un altro punto di riposo.");
                },
                choices: [
                    { text: "Continua il viaggio", nextScene: "terreSelvagge" },
                    { text: "Cerca un altro rifugio", nextScene: "rovineTempio" }
                ]
            }
        };

        // Funzioni di gestione del gioco

        function showDeathScreen() {
            const deathScreen = document.getElementById('death-screen');
            deathScreen.style.display = 'flex';
            deathScreen.style.opacity = '0';
            deathScreen.style.transform = 'scale(0.9)';
            
            // Animazione di entrata per la schermata di morte
            setTimeout(() => {
                deathScreen.style.transition = 'all 0.5s ease-in-out';
                deathScreen.style.opacity = '1';
                deathScreen.style.transform = 'scale(1)';
                
                // Attiva particelle rosse
                addBloodParticles();
            }, 100);
            
            document.addEventListener('keydown', restartFromSacredFire, { once: true });
            checkAchievements(); // Controlla achievement per prima morte
        }

        function hideDeathScreen() {
            document.getElementById('death-screen').style.display = 'none';
            document.removeEventListener('keydown', restartFromSacredFire);
        }

        function restartFromSacredFire() {
            hideDeathScreen();
            playerHealth = maxHealth;
            loadScene(lastSacredFire);
            updateUI();
            alert("Sei rinato al tuo ultimo Fuoco Sacro!");
        }

        function startGame() {
            console.log("Avvio del gioco...");
            hideDeathScreen();
            playerHealth = maxHealth;
            souls = 0;
            inventory = [];
            lastSacredFire = "cellaIniziale";
            hasKey = false;
            hasMap = false;
            foundSecretTunnel = false;
            foughtGolem = false;
            exploredDeepCrypt = false;
            hasPartialMemory = false;
            hasAlertedGuards = false;
            hasDefeatedMummy = false;
            achievements = {
                firstDeath: false,
                golemSlayer: false,
                treasureHunter: false,
                memoryRecovery: false,
                curseBreaker: false,
                alchemistHelper: false,
                libraryScholar: false,
                secretExplorer: false
            };
            currentScene = "cellaIniziale";
            updateUI();
            loadScene(currentScene);
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
        }

        function loadScene(sceneName) {
            const scene = scenes[sceneName];
            if (!scene) {
                console.error("Scena non trovata:", sceneName);
                return;
            }

            // Animazione di transizione avanzata
            const storyPanel = document.getElementById('story-panel');
            storyPanel.style.opacity = '0';
            storyPanel.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                currentScene = sceneName;
                document.getElementById('title').textContent = scene.title;
                document.getElementById('text').textContent = scene.text;

                if (scene.onEnter) {
                    scene.onEnter();
                }

                const choicesDiv = document.getElementById('choices');
                choicesDiv.innerHTML = '';

                scene.choices.forEach((choice, index) => {
                    // Gestione delle condizioni per le scelte (es. item richiesti, flag)
                    if (choice.condition && !choice.condition()) {
                        return; // Salta questa scelta se la condizione non è soddisfatta
                    }

                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choice.text;

                    // Aggiungi animazione di delay per i pulsanti
                    button.style.animationDelay = `${index * 0.1}s`;
                    button.style.opacity = '0';
                    button.style.transform = 'translateY(10px)';

                    if (choice.requiredItems && !choice.requiredItems.every(item => inventory.includes(item))) {
                        button.disabled = true;
                        if (choice.failedText) {
                            button.title = choice.failedText;
                        }
                    }

                    button.onclick = () => {
                        // Aggiungi effetto ripple
                        const ripple = document.createElement('span');
                        ripple.classList.add('ripple');
                        button.appendChild(ripple);
                        
                        setTimeout(() => {
                            if (choice.onSelect) {
                                choice.onSelect();
                            } else if (choice.nextScene) {
                                loadScene(choice.nextScene);
                            }
                        }, 150);
                    };
                    choicesDiv.appendChild(button);
                    
                    // Anima l'apparizione del pulsante
                    setTimeout(() => {
                        button.style.transition = 'all 0.3s ease';
                        button.style.opacity = '1';
                        button.style.transform = 'translateY(0)';
                    }, index * 100);
                });

                // Animazione di fade-in per il pannello
                storyPanel.style.transition = 'all 0.5s ease-in-out';
                storyPanel.style.opacity = '1';
                storyPanel.style.transform = 'translateY(0)';
                
                // Aggiungi effetti particellari per scene speciali
                if (sceneName.includes('fuoco') || sceneName.includes('sacro')) {
                    addSacredFireParticles();
                }
            }, 300);
        }

        function updateUI() {
            // Protezione contro variabili non inizializzate
            if (typeof playerHealth === 'undefined') playerHealth = maxHealth;
            if (typeof souls === 'undefined') souls = 0;
            if (typeof inventory === 'undefined') inventory = [];
            if (typeof lastSacredFire === 'undefined') lastSacredFire = "cellaIniziale";
            
            document.getElementById('health-display').textContent = `${playerHealth}/${maxHealth}`;
            document.getElementById('souls-display').textContent = souls;
            // Mappatura nomi fuochi sacri
            const fuochiSacroNomi = {
                "fuocoSacroPrigione": "Fuoco Sacro: Prigione",
                "fuocoSacroTempio": "Fuoco Sacro: Tempio",
                "fuocoSacroTerre": "Fuoco Sacro: Terre Selvagge",
                "cellaIniziale": "Inizio (Cella)"
            };
            document.getElementById('last-sacred-fire-display').textContent = fuochiSacroNomi[lastSacredFire] || "Nessuno";

            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            if (inventory.length === 0) {
                const li = document.createElement('li');
                li.textContent = "Nessun oggetto";
                inventoryList.appendChild(li);
            } else {
                inventory.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    
                    // Aggiungi classe per oggetti importanti
                    if (item.includes("Amuleto") || item.includes("Corona") || item.includes("Gemma")) {
                        li.classList.add('important-item');
                    }
                    
                    // Aggiungi animazione per nuovi oggetti
                    if (index === inventory.length - 1 && inventory.length > 0) {
                        li.classList.add('new-item');
                        setTimeout(() => li.classList.remove('new-item'), 1000);
                    }
                    
                    inventoryList.appendChild(li);
                });
            }

            if (playerHealth <= 0) {
                showDeathScreen();
            } else {
                hideDeathScreen();
            }
            
            // Controlla achievement basati su inventario e flag
            checkAchievements();
        }

        function saveGame() {
            // SALVATAGGIO GENERALE: Salva tutto lo stato del gioco
            const gameState = {
                playerHealth,
                souls,
                inventory,
                currentScene,
                lastSacredFire,  // Punto di respawn quando muori
                hasKey,
                hasMap,
                foundSecretTunnel,
                foughtGolem,
                exploredDeepCrypt,
                hasPartialMemory,
                hasAlertedGuards,
                hasDefeatedMummy,
                achievements
            };
            localStorage.setItem('soulJourneySave', JSON.stringify(gameState));
            updateUI(); // Aggiorna sempre la visualizzazione dopo il salvataggio
            document.getElementById('sacred-fire-status').textContent = "FUOCO SACRO ACCESO";
            setTimeout(() => document.getElementById('sacred-fire-status').textContent = "", 2000);
            console.log("Gioco salvato!");
        }

        // NUOVA FUNZIONE: Aggiorna solo il punto di respawn (fuoco sacro)
        function updateSacredFire(newFireLocation) {
            lastSacredFire = newFireLocation;
            saveGame(); // Salva automaticamente tutto quando si aggiorna il fuoco sacro
            updateUI(); // Aggiorna la visualizzazione
            showAchievementNotification("Fuoco Sacro Raggiunto");
            showNotification("Progressi salvati!", "achievement", 3000);
        }

        function loadGame() {
            const savedState = localStorage.getItem('soulJourneySave');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                playerHealth = gameState.playerHealth;
                souls = gameState.souls;
                inventory = gameState.inventory;
                currentScene = gameState.currentScene;
                lastSacredFire = gameState.lastSacredFire;
                hasKey = gameState.hasKey;
                hasMap = gameState.hasMap;
                foundSecretTunnel = gameState.foundSecretTunnel;
                foughtGolem = gameState.foughtGolem;
                exploredDeepCrypt = gameState.exploredDeepCrypt || false;
                hasPartialMemory = gameState.hasPartialMemory || false;
                hasAlertedGuards = gameState.hasAlertedGuards || false;
                hasDefeatedMummy = gameState.hasDefeatedMummy || false;
                achievements = gameState.achievements || {
                    firstDeath: false,
                    golemSlayer: false,
                    treasureHunter: false,
                    memoryRecovery: false,
                    curseBreaker: false,
                    alchemistHelper: false,
                    libraryScholar: false,
                    secretExplorer: false
                };

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-container').style.display = 'flex';
                loadScene(currentScene);
                updateUI();
                hideDeathScreen();
                console.log("Gioco caricato!");
            } else {
                showNotification("Nessun salvataggio trovato!", "info", 3000);
            }
        }

        function confirmReset() {
            if (confirm("Sei sicuro di voler iniziare una nuova partita? Perderai tutti i progressi.")) {
                startGame();
            }
        }

        // Funzioni specifiche per azioni di gioco
        function buyItem(item, cost, currentSceneName) {
            if (souls >= cost) {
                souls -= cost;
                inventory.push(item);
                updateUI();
                showItemNotification(item, true);
                loadScene(currentSceneName);
            } else {
                showNotification("Non hai abbastanza anime!", "damage", 3000);
            }
        }

        function restAtSacredFire(returnScene) {
            // Richiede un'offerta per usare i fuochi sacri
            if (souls >= 15) {
                souls -= 15; // Costo per usare il fuoco sacro
                playerHealth = maxHealth;
                updateUI();
                showSoulsNotification(-15);
                showHealNotification(maxHealth - playerHealth);
                loadScene(returnScene);
            } else {
                showNotification("Non hai abbastanza anime (15 richieste) per attivare il Fuoco Sacro!", "damage", 3000);
                loadScene(returnScene);
            }
        }

        function meditateAltare(returnScene) {
            playerHealth = Math.min(maxHealth, playerHealth + 30);
            updateUI();
            showHealNotification(30);
            loadScene(returnScene);
        }

        function useItem(item, nextSceneIfUsed, messageIfNotFound) {
            if (inventory.includes(item)) {
                // Rimuovi l'oggetto dall'inventario se monouso, altrimenti no
                if (item === "Pozione di Salute") {
                    const index = inventory.indexOf(item);
                    if (index > -1) {
                        inventory.splice(index, 1);
                    }
                    playerHealth = Math.min(maxHealth, playerHealth + 50); // Cura la pozione
                    
                    // Effetto collaterale: 30% di probabilità di danno temporaneo
                    const sideEffect = Math.random();
                    if (sideEffect < 0.3) {
                        const damage = Math.floor(Math.random() * 10) + 5;
                        playerHealth -= damage;
                        showHealNotification(50);
                        showDamageNotification(damage, "effetto collaterale");
                    } else {
                        showHealNotification(50);
                    }
                } else if (item === "Mappa Rudimentale") {
                    showNotification("La Mappa Rudimentale ti ha rivelato un punto debole!", "achievement", 3000);
                    // La mappa non viene consumata
                }
                updateUI();
                loadScene(nextSceneIfUsed);
            } else {
                showNotification(messageIfNotFound, "damage", 3000);
            }
        }

        function touchRune(returnScene) {
            showNotification("La runa pulsa sotto il tuo tocco, rilasciando una scarica di energia arcana. Ti senti più forte!", "achievement", 4000);
            playerHealth = Math.min(maxHealth, playerHealth + 20);
            souls += 10;
            updateUI();
            loadScene(returnScene);
        }

        function useAmulet(returnScene) {
            if (inventory.includes("Amuleto Antico")) {
                showHealNotification(20);
                playerHealth = Math.min(maxHealth, playerHealth + 20);
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai l'Amuleto Antico!", "damage", 3000);
            }
        }

        function readScroll(returnScene) {
            if (inventory.includes("Pergamena di Rune")) {
                showSoulsNotification(15);
                souls += 15;
                updateUI();
                loadScene(returnScene);
            } else {
                alert("Non hai la Pergamena di Rune!");
            }
        }

        function useSack(returnScene) {
            if (inventory.includes("Sacca di Cuoio")) {
                alert("Usi la Sacca di Cuoio per aumentare la tua capacità di trasporto! +2 slot inventario.");
                // Implementazione simbolica - in un gioco reale si aumenterebbe il limite inventario
                souls += 10;
                updateUI();
                loadScene(returnScene);
            } else {
                alert("Non hai la Sacca di Cuoio!");
            }
        }

        function useStrengthPotion(returnScene) {
            if (inventory.includes("Pozione di Forza")) {
                const index = inventory.indexOf("Pozione di Forza");
                if (index > -1) {
                    inventory.splice(index, 1);
                }
                playerHealth = Math.min(maxHealth, playerHealth + 30);
                
                // Effetto collaterale: 40% di probabilità di danno temporaneo
                const sideEffect = Math.random();
                if (sideEffect < 0.4) {
                    const damage = Math.floor(Math.random() * 15) + 10;
                    playerHealth -= damage;
                    alert("Hai usato una Pozione di Forza! +30 HP. Salute: " + playerHealth + " (Effetto collaterale: -" + damage + " HP)");
                } else {
                    alert("Hai usato una Pozione di Forza! +30 HP. Salute: " + playerHealth);
                }
                updateUI();
                loadScene(returnScene);
            } else {
                alert("Non hai una Pozione di Forza!");
            }
        }

        function useGem(returnScene) {
            if (inventory.includes("Gemma Preziosa")) {
                souls += 50;
                alert("Hai usato la Gemma Preziosa! +50 anime.");
                updateUI();
                loadScene(returnScene);
            } else {
                alert("Non hai una Gemma Preziosa!");
            }
        }

        function useCrown(returnScene) {
            if (inventory.includes("Corona dell'Anima")) {
                alert("La Corona dell'Anima ti conferisce un potere immenso! +50 HP temporaneo.");
                playerHealth = Math.min(maxHealth, playerHealth + 50);
                updateUI();
                loadScene(returnScene);
            } else {
                alert("Non hai la Corona dell'Anima!");
            }
        }

        // Sistema di Crafting
        let craftingRecipes = {
            "Pozione di Salute": {
                ingredients: ["Erba Curativa", "Acqua Pura"],
                soulsCost: 10,
                description: "Ripristina 50 HP"
            },
            "Pozione di Forza": {
                ingredients: ["Erba di Forza", "Cristallo di Potenza"],
                soulsCost: 20,
                description: "Aumenta temporaneamente la forza"
            },
            "Amuleto Potenziato": {
                ingredients: ["Amuleto Antico", "Pergamena di Rune", "Gemma Preziosa"],
                soulsCost: 50,
                description: "Protezione arcana potenziata"
            },
            "Pozione della Cura": {
                ingredients: ["Erba Rara", "Amuleto Antico", "Cristallo di Anima"],
                soulsCost: 100,
                description: "Cura la maledizione (finale)"
            }
        };

        function canCraft(recipeName) {
            const recipe = craftingRecipes[recipeName];
            if (!recipe) return false;
            
            // Controlla se hai tutti gli ingredienti
            for (let ingredient of recipe.ingredients) {
                if (!inventory.includes(ingredient)) {
                    return false;
                }
            }
            
            // Controlla se hai abbastanza anime
            if (souls < recipe.soulsCost) {
                return false;
            }
            
            return true;
        }

        function craftItem(recipeName) {
            const recipe = craftingRecipes[recipeName];
            if (!recipe) {
                alert("Ricetta non trovata!");
                return false;
            }
            
            if (!canCraft(recipeName)) {
                alert("Non hai gli ingredienti necessari o abbastanza anime!");
                return false;
            }
            
            // Rimuovi gli ingredienti
            for (let ingredient of recipe.ingredients) {
                const index = inventory.indexOf(ingredient);
                if (index > -1) {
                    inventory.splice(index, 1);
                }
            }
            
            // Rimuovi le anime
            souls -= recipe.soulsCost;
            
            // Aggiungi l'oggetto craftato
            inventory.push(recipeName);
            
            // Effetti speciali per oggetti craftati con animazioni
            switch(recipeName) {
                case "Pozione della Cura":
                    showCraftingSuccess("Hai creato la Pozione della Cura! Questa può spezzare la maledizione!");
                    break;
                case "Amuleto Potenziato":
                    showCraftingSuccess("Hai creato l'Amuleto Potenziato! Protezione arcana aumentata!");
                    break;
                default:
                    showCraftingSuccess("Hai creato " + recipeName + "!");
            }
            
            updateUI();
            return true;
        }

        function showCraftingSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">⚗️ Crafting Completato!</div>
                <div style="font-size: 0.9em;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi la notifica dopo 3 secondi
            setTimeout(() => {
                notification.style.animation = 'achievementSlide 0.5s ease-in reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        function showCraftingMenu() {
            let menu = "=== MENU CRAFTING ===\n\n";
            let availableRecipes = 0;
            
            for (let recipeName in craftingRecipes) {
                const recipe = craftingRecipes[recipeName];
                const canCraftThis = canCraft(recipeName);
                
                menu += `${recipeName}:\n`;
                menu += `  Ingredienti: ${recipe.ingredients.join(", ")}\n`;
                menu += `  Costo Anime: ${recipe.soulsCost}\n`;
                menu += `  Effetto: ${recipe.description}\n`;
                menu += `  Stato: ${canCraftThis ? "✅ Disponibile" : "❌ Non disponibile"}\n\n`;
                
                if (canCraftThis) availableRecipes++;
            }
            
            if (availableRecipes === 0) {
                menu += "Non hai ingredienti sufficienti per nessuna ricetta.";
            }
            
            alert(menu);
        }

        // Funzioni per il sistema Achievement
        function checkAchievements() {
            // Achievement: Prima Morte
            if (!achievements.firstDeath && playerHealth <= 0) {
                achievements.firstDeath = true;
                showAchievementNotification("Sopravvissuto", "Hai subito la tua prima morte e sei rinato!");
            }
            
            // Achievement: Cacciatore di Golem
            if (!achievements.golemSlayer && foughtGolem) {
                achievements.golemSlayer = true;
                showAchievementNotification("Cacciatore di Golem", "Hai sconfitto il Golem!");
            }
            
            // Achievement: Cacciatore di Tesori
            if (!achievements.treasureHunter && inventory.length >= 5) {
                achievements.treasureHunter = true;
                showAchievementNotification("Cacciatore di Tesori", "Hai trovato 5 oggetti!");
            }
            
            // Achievement: Ricordi Recuperati
            if (!achievements.memoryRecovery && hasPartialMemory) {
                achievements.memoryRecovery = true;
                showAchievementNotification("Ricordi Recuperati", "Hai recuperato ricordi parziali!");
            }
            
            // Achievement: Spezzamaledizioni
            if (!achievements.curseBreaker && inventory.includes("Amuleto Antico") && inventory.includes("Pergamena di Rune")) {
                achievements.curseBreaker = true;
                showAchievementNotification("Spezzamaledizioni", "Hai trovato gli artefatti per spezzare la maledizione!");
            }
            
            // Achievement: Aiutante dell'Alchimista
            if (!achievements.alchemistHelper && inventory.includes("Pozione di Forza")) {
                achievements.alchemistHelper = true;
                showAchievementNotification("Aiutante dell'Alchimista", "Hai ottenuto una pozione dall'alchimista!");
            }
            
            // Achievement: Studioso della Biblioteca
            if (!achievements.libraryScholar && inventory.includes("Mappa del Tempio")) {
                achievements.libraryScholar = true;
                showAchievementNotification("Studioso della Biblioteca", "Hai trovato la mappa del tempio!");
            }
            
            // Achievement: Esploratore Segreto
            if (!achievements.secretExplorer && foundSecretTunnel) {
                achievements.secretExplorer = true;
                showAchievementNotification("Esploratore Segreto", "Hai scoperto un passaggio segreto!");
            }
        }

        function showAchievementNotification(title, description) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">🏆 ${title}</div>
                <div style="font-size: 0.9em;">${description}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi la notifica dopo 3 secondi
            setTimeout(() => {
                notification.style.animation = 'achievementSlide 0.5s ease-in reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        function showAchievements() {
            let achievementText = "🏆 ACHIEVEMENT SBLOCATI:\n\n";
            let count = 0;
            
            if (achievements.firstDeath) {
                achievementText += "✅ Sopravvissuto - Prima morte e rinascita\n";
                count++;
            }
            if (achievements.golemSlayer) {
                achievementText += "✅ Cacciatore di Golem - Sconfiggere il Golem\n";
                count++;
            }
            if (achievements.treasureHunter) {
                achievementText += "✅ Cacciatore di Tesori - Trovare 5 oggetti\n";
                count++;
            }
            if (achievements.memoryRecovery) {
                achievementText += "✅ Ricordi Recuperati - Completare sequenza ricordi\n";
                count++;
            }
            if (achievements.curseBreaker) {
                achievementText += "✅ Spezzamaledizioni - Completare il gioco\n";
                count++;
            }
            if (achievements.alchemistHelper) {
                achievementText += "✅ Aiutante dell'Alchimista - Ottenere pozione dall'alchimista\n";
                count++;
            }

        // Funzione per verificare lo stato delle route
        function checkRouteStatus() {
            const routeStatus = {
                ricordaPassato: scenes.ricordaPassato && scenes.ricordoParziale && scenes.sogniRicordi,
                gridaAiuto: scenes.gridaAiuto && scenes.guardieArrivano,
                cercaManufatti: scenes.cercaManufatti && scenes.manufattiTrovati,
                apriSarcofago: scenes.apriSarcofago && scenes.combattiMummia && scenes.sconfiggiMummia,
                fuochiSacri: scenes.cercaFuocoSacro && scenes.santuarioIntermedio
            };
            
            console.log("Stato delle route:", routeStatus);
            return routeStatus;
        }
            if (achievements.libraryScholar) {
                achievementText += "✅ Studioso della Biblioteca - Trovare la mappa del tempio\n";
                count++;
            }
            if (achievements.secretExplorer) {
                achievementText += "✅ Esploratore Segreto - Scoprire passaggio segreto\n";
                count++;
            }
            
            if (count === 0) {
                achievementText += "Nessun achievement sbloccato ancora.";
            }
            
            alert(achievementText);
        }

        function showVictoryScreen(endingType = "DEFAULT") {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            
            // Aggiorna statistiche finali
            document.getElementById('final-souls').textContent = souls;
            document.getElementById('final-items').textContent = inventory.length;
            document.getElementById('final-fires').textContent = "3"; // Fuochi sacri implementati
            
            // Personalizza il titolo in base al tipo di finale
            const victoryTitle = document.getElementById('victory-screen').querySelector('h1');
            switch(endingType) {
                case "BUONO":
                    victoryTitle.textContent = "🎉 VITTORIA - Finale Buono";
                    victoryTitle.style.color = "#8aff8a";
                    break;
                case "OSCURO":
                    victoryTitle.textContent = "⚫ VITTORIA - Finale Oscuro";
                    victoryTitle.style.color = "#ff6b6b";
                    break;
                case "NEUTRALE":
                    victoryTitle.textContent = "⚪ VITTORIA - Finale Neutrale";
                    victoryTitle.style.color = "#cccccc";
                    break;
                default:
                    victoryTitle.textContent = "🎉 VITTORIA!";
                    victoryTitle.style.color = "#8aff8a";
            }
            
            const victoryScreen = document.getElementById('victory-screen');
            victoryScreen.style.display = 'flex';
            victoryScreen.style.opacity = '0';
            victoryScreen.style.transform = 'scale(0.9)';
            
            // Animazione di entrata per la schermata di vittoria
            setTimeout(() => {
                victoryScreen.style.transition = 'all 0.8s ease-in-out';
                victoryScreen.style.opacity = '1';
                victoryScreen.style.transform = 'scale(1)';
                
                // Attiva particelle dorate
                addVictoryParticles();
            }, 100);
        }

        function newGame() {
            document.getElementById('victory-screen').style.display = 'none';
            startGame();
        }

        function returnToMenu() {
            document.getElementById('victory-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Pulisci TUTTI i salvataggi per sicurezza
            localStorage.removeItem('soulJourneySave');
            console.log("Tutti i salvataggi rimossi per sicurezza");
            
            // Inizializza le variabili di base per evitare errori
            if (typeof inventory === 'undefined') {
                inventory = [];
            }
            if (typeof souls === 'undefined') {
                souls = 0;
            }
            if (typeof playerHealth === 'undefined') {
                playerHealth = maxHealth;
            }
            
            // Assicurati che la schermata iniziale sia visibile
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('victory-screen').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            
            updateUI();
            hideDeathScreen();
            
            // Aggiungi effetti sonori (simulati con vibrazione su mobile)
            if ('vibrate' in navigator) {
                // Vibrazione per azioni importanti
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('choice-button')) {
                        navigator.vibrate(50);
                    }
                });
            }
            
            // Migliora l'esperienza mobile
            if (window.innerWidth <= 768) {
                // Aumenta la dimensione dei pulsanti su mobile
                const buttons = document.querySelectorAll('.choice-button');
                buttons.forEach(button => {
                    button.style.minHeight = '60px';
                    button.style.fontSize = '1.1em';
                });
            }
            
            // Aggiungi scorciatoie da tastiera
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                        const choiceIndex = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.choice-button');
                        if (buttons[choiceIndex]) {
                            buttons[choiceIndex].click();
                        }
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            saveGame();
                        }
                        break;
                    case 'Escape':
                        // Torna al menu principale
                        if (document.getElementById('game-container').style.display === 'flex') {
                            document.getElementById('start-screen').style.display = 'flex';
                            document.getElementById('game-container').style.display = 'none';
                        }
                        break;
                }
            });
        });
    </script>
</body>
</html>
