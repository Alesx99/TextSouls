<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TextSouls - Il Viaggio dell'Anima Perduta</title>
    <style>
        /* Import Google Fonts per Dark Souls */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        /* Palette colori Dark Souls - Versione Avanzata */
        :root {
            /* Oro antico - per elementi sacri */
            --ds-gold: #D4AF37;
            --ds-gold-dark: #B8860B;
            --ds-gold-light: #FFD700;
            --ds-gold-glow: #FFD700;
            
            /* Rosso sangue - per pericolo e morte */
            --ds-blood: #8B0000;
            --ds-blood-light: #DC143C;
            --ds-blood-dark: #4B0082;
            --ds-blood-glow: #FF0000;
            
            /* Grigio pietra - per strutture */
            --ds-stone: #696969;
            --ds-stone-light: #808080;
            --ds-stone-dark: #2F4F4F;
            --ds-stone-texture: #444444;
            
            /* Verde putrefazione - per veleno/maledizioni */
            --ds-poison: #228B22;
            --ds-poison-light: #32CD32;
            --ds-poison-dark: #006400;
            --ds-poison-glow: #00FF00;
            
            /* Blu profondo - per magia */
            --ds-magic: #191970;
            --ds-magic-light: #4169E1;
            --ds-magic-dark: #000080;
            --ds-magic-glow: #4169E1;
            
            /* Nero assoluto - per sfondo */
            --ds-black: #000000;
            --ds-black-light: #1a1a1a;
            --ds-black-dark: #0a0a0a;
            --ds-black-transparent: rgba(0, 0, 0, 0.8);
            
            /* Ombre e profondità */
            --ds-shadow-light: rgba(212, 175, 55, 0.3);
            --ds-shadow-dark: rgba(0, 0, 0, 0.7);
            --ds-shadow-glow: rgba(212, 175, 55, 0.5);
        }
        
        /* Texture pietra SVG avanzate - Versione Migliorata */
        .stone-texture {
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stone' patternUnits='userSpaceOnUse' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23333'/%3E%3Cpath d='M0,0 L100,0 L100,100 L0,100 Z' fill='none' stroke='%23444' stroke-width='1'/%3E%3Ccircle cx='20' cy='20' r='2' fill='%23555'/%3E%3Ccircle cx='80' cy='30' r='1.5' fill='%23444'/%3E%3Ccircle cx='40' cy='70' r='2.5' fill='%23555'/%3E%3Ccircle cx='70' cy='80' r='1' fill='%23444'/%3E%3Cpath d='M10,50 L30,50 L30,70 L10,70 Z' fill='%23444'/%3E%3Cpath d='M60,20 L80,20 L80,40 L60,40 Z' fill='%23555'/%3E%3Ccircle cx='50' cy='50' r='3' fill='%23666'/%3E%3Cpath d='M15,15 L25,15 L25,25 L15,25 Z' fill='%23555'/%3E%3Cpath d='M75,75 L85,75 L85,85 L75,85 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stone)'/%3E%3C/svg%3E");
        }
        
        /* Texture pietra alternativa per varietà */
        .stone-texture-alt {
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stoneAlt' patternUnits='userSpaceOnUse' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23222'/%3E%3Cpath d='M0,0 L100,0 L100,100 L0,100 Z' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='30' cy='30' r='4' fill='%23444'/%3E%3Ccircle cx='70' cy='70' r='3' fill='%23555'/%3E%3Cpath d='M20,60 L40,60 L40,80 L20,80 Z' fill='%23333'/%3E%3Cpath d='M60,20 L80,20 L80,40 L60,40 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stoneAlt)'/%3E%3C/svg%3E");
        }
        
        /* Effetti particellari fluttuanti - Versione Avanzata */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--ds-gold);
            border-radius: 50%;
            animation: float 6s infinite linear;
            opacity: 0.6;
            box-shadow: 0 0 4px var(--ds-gold-glow);
        }
        
        .particle:nth-child(odd) {
            background: var(--ds-gold-light);
            animation-duration: 8s;
            box-shadow: 0 0 6px var(--ds-gold-light);
        }
        
        .particle:nth-child(even) {
            background: var(--ds-gold-dark);
            animation-duration: 10s;
            box-shadow: 0 0 3px var(--ds-gold-dark);
        }
        
        /* Particelle per fuochi sacri */
        .sacred-fire-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--ds-gold-glow);
            border-radius: 50%;
            animation: sacredFloat 4s infinite ease-in-out;
            opacity: 0.8;
            box-shadow: 0 0 8px var(--ds-gold-glow);
        }
        
        .sacred-fire-particle:nth-child(3n) {
            background: var(--ds-gold-light);
            animation-duration: 3s;
            box-shadow: 0 0 10px var(--ds-gold-light);
        }
        
        .sacred-fire-particle:nth-child(3n+1) {
            background: var(--ds-gold);
            animation-duration: 5s;
            box-shadow: 0 0 6px var(--ds-gold);
        }
        
        @keyframes sacredFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 0.8;
                transform: scale(1);
            }
            80% {
                opacity: 0.8;
                transform: scale(1);
            }
            100% {
                transform: translateY(-10vh) translateX(50px) scale(0.5);
                opacity: 0;
            }
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-10vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* Effetti di nebbia atmosferica - Versione Avanzata */
        .fog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(105, 105, 105, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 0%, rgba(0, 0, 0, 0.05) 50%, transparent 100%);
            pointer-events: none;
            animation: fogDrift 20s ease-in-out infinite;
        }
        
        @keyframes fogDrift {
            0%, 100% { 
                opacity: 0.3;
                transform: translateX(0) translateY(0);
            }
            25% { 
                opacity: 0.5;
                transform: translateX(10px) translateY(-5px);
            }
            50% { 
                opacity: 0.4;
                transform: translateX(-5px) translateY(10px);
            }
            75% { 
                opacity: 0.6;
                transform: translateX(15px) translateY(5px);
            }
        }
        
        /* Effetto nebbia aggiuntivo */
        .fog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: fog-move 20s infinite ease-in-out;
        }
        
        @keyframes fog-move {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(0) translateY(0);
            }
            50% {
                opacity: 0.5;
                transform: translateX(-10px) translateY(-5px);
            }
        }
        
        /* Animazioni di transizione avanzate */
        .scene-transition {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        
        .fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease-in-out;
        }
        
        /* Effetto ripple per pulsanti */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: 
                linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2d1b3d 50%, #1a1a1a 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.4) 0%, transparent 70%);
            background-attachment: fixed;
            color: #e0e0e0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            font-size: 16px; /* Base font size per responsive */
        }
        
        /* Aggiungi particelle al body */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(212, 175, 55, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(139, 0, 0, 0.1) 0%, transparent 40%);
            pointer-events: none;
            animation: background-shift 15s infinite ease-in-out;
        }
        
        @keyframes background-shift {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.05);
            }
        }

        /* Responsive design per diversi display */
        
        /* Tablet e schermi medi */
        @media (max-width: 1024px) {
            #game-container {
                width: 95%;
                max-width: 900px;
                height: 85vh;
            }
            
            #story-panel {
                flex: 2;
                min-width: 0;
            }
            
            #status-panel {
                flex: 1;
                min-width: 280px;
                max-width: 320px;
            }
            
            #title {
                font-size: 2em;
            }
            
            #text {
                font-size: 1.1em;
            }
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            #game-container {
                width: 95%;
                height: 90vh;
                flex-direction: column;
                padding: 10px;
            }
            
            #story-panel {
                flex: 1;
                border-right: none;
                border-bottom: 1px solid #444;
                padding: 15px;
                min-height: 60vh;
            }
            
            #status-panel {
                flex: 0 0 auto;
                padding: 15px;
                max-height: 30vh;
                overflow-y: auto;
                min-height: 200px;
            }
            
            #title {
                font-size: 1.8em;
            }
            
            #text {
                font-size: 1em;
            }
            
            .choice-button {
                padding: 15px 20px;
                font-size: 1.1em;
                min-height: 50px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 12px;
            }
            
            #game-container {
                width: 98%;
                height: 95vh;
                padding: 5px;
            }
            
            #story-panel {
                min-height: 50vh;
            }
            
            #status-panel {
                max-height: 25vh;
                min-height: 150px;
            }
            
            #title {
                font-size: 1.5em;
            }
            
            #text {
                font-size: 0.9em;
            }
            
            .choice-button {
                padding: 12px 15px;
                font-size: 1em;
                min-height: 45px;
            }
        }

        @media (min-width: 1200px) {
            #game-container {
                max-width: 1200px;
                height: 85vh;
            }
            
            #story-panel {
                flex: 3;
            }
            
            #status-panel {
                flex: 1;
                min-width: 300px;
            }
            
            #title {
                font-size: 2.5em;
            }
            
            #text {
                font-size: 1.2em;
            }
        }

        #game-container {
            display: none; /* Nascondi all'inizio, verrà mostrato da JS */
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: 
                linear-gradient(145deg, #2b2b2b 0%, #1a1a1a 100%),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(212, 175, 55, 0.1) 10px,
                    rgba(212, 175, 55, 0.1) 20px
                ),
                radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
            border: 3px solid var(--ds-gold);
            border-radius: 8px;
            box-shadow: 
                0 0 20px rgba(212, 175, 55, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(139, 0, 0, 0.2);
            display: flex;
            flex-direction: row;
            overflow: hidden;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            align-items: stretch;
        }
        
        /* Aggiungi texture pietra al container */
        #game-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='stone-detail' patternUnits='userSpaceOnUse' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23222'/%3E%3Cpath d='M0,0 L200,0 L200,200 L0,200 Z' fill='none' stroke='%23333' stroke-width='2'/%3E%3Ccircle cx='40' cy='40' r='3' fill='%23444'/%3E%3Ccircle cx='160' cy='60' r='2' fill='%23333'/%3E%3Ccircle cx='80' cy='140' r='4' fill='%23444'/%3E%3Ccircle cx='140' cy='160' r='1.5' fill='%23333'/%3E%3Cpath d='M20,100 L60,100 L60,140 L20,140 Z' fill='%23333'/%3E%3Cpath d='M120,40 L160,40 L160,80 L120,80 Z' fill='%23444'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23stone-detail)' opacity='0.1'/%3E%3C/svg%3E");
            pointer-events: none;
            border-radius: 8px;
            opacity: 0.3;
        }

        #game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            border-radius: 8px;
        }

        #story-panel {
            flex: 3;
            padding: 20px;
            background: 
                linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%);
            border-right: 2px solid var(--ds-gold);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            min-width: 0;
        }

        #story-panel::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, var(--ds-gold) 0%, transparent 50%, var(--ds-gold) 100%);
            box-shadow: 0 0 10px var(--ds-gold);
        }

        #title {
            font-family: 'Cinzel', serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--ds-gold-light);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 2px solid var(--ds-gold);
            padding-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #text {
            font-family: 'Crimson Text', serif;
            font-size: 1.1em;
            font-weight: 400;
            line-height: 1.8;
            margin-bottom: 25px;
            text-align: justify;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto; /* Spinge le scelte in basso */
        }

        .choice-button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%),
                radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.1) 0%, transparent 70%);
            color: var(--ds-gold-light);
            padding: 12px 20px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .choice-button:hover::before {
            left: 100%;
        }
        
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 5px 15px rgba(212, 175, 55, 0.4),
                0 0 20px rgba(212, 175, 55, 0.2);
            border-color: var(--ds-gold-light);
        }
        
        .choice-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(212, 175, 55, 0.3),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .choice-button {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            white-space: normal;
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            transition: left 0.5s ease;
        }

        /* Pulsanti specifici per la sidebar */
        #status-panel .choice-button {
            padding: 8px 12px;
            font-size: 0.85em;
            margin-bottom: 6px;
            min-height: 35px;
            line-height: 1.2;
        }

        .choice-button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 20px var(--ds-gold-glow),
                0 0 30px rgba(212, 175, 55, 0.4),
                inset 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
            text-shadow: 0 0 8px var(--ds-gold-glow);
        }

        .choice-button:hover::before {
            left: 100%;
        }

        #status-panel {
            flex: 1;
            padding: 15px;
            background: 
                linear-gradient(180deg, #3a3a3a 0%, #2b2b2b 100%);
            border-left: 2px solid var(--ds-gold);
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 1em;
            min-width: 300px;
            max-width: 350px;
            overflow-y: auto;
            justify-content: flex-start;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }

        #status-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, var(--ds-gold) 0%, transparent 50%, var(--ds-gold) 100%);
            box-shadow: 0 0 10px var(--ds-gold);
        }

        .status-section h3 {
            color: var(--ds-gold);
            font-family: 'Cinzel', serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0;
            margin-bottom: 8px;
            border-bottom: 2px solid var(--ds-gold);
            padding-bottom: 3px;
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Garantisce che i pulsanti siano sempre visibili */
        #status-panel {
            scrollbar-width: thin;
            scrollbar-color: #555 #3a3a3a;
        }

        #status-panel::-webkit-scrollbar {
            width: 8px;
        }

        #status-panel::-webkit-scrollbar-track {
            background: #3a3a3a;
        }

        #status-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        #status-panel::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        #inventory-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #inventory-list li {
            margin-bottom: 2px;
            font-size: 0.9em;
        }

        #sacred-fire-status {
            color: var(--ds-gold-light);
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            text-shadow: 0 0 10px var(--ds-gold);
            animation: firePulse 2s ease-in-out infinite;
        }

        @keyframes firePulse {
            0%, 100% { text-shadow: 0 0 10px var(--ds-gold); }
            50% { text-shadow: 0 0 20px var(--ds-gold), 0 0 30px var(--ds-gold); }
        }

        /* Schermata di avvio */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2d1b3d 50%, #1a1a1a 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.2) 0%, transparent 50%);
            background-attachment: fixed;
            color: #eee;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1001; /* Sopra tutto il resto */
        }

        #start-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5em;
            font-weight: 700;
            color: var(--ds-gold-light);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 30px var(--ds-gold); }
            to { text-shadow: 0 0 40px var(--ds-gold), 0 0 50px var(--ds-gold); }
        }

        /* Effetti particellari avanzati */
        .particle-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle-effect .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--ds-gold);
            border-radius: 50%;
            animation: particleFloat 8s infinite linear;
            opacity: 0.7;
            box-shadow: 0 0 6px var(--ds-gold-glow);
        }

        .particle-effect .particle:nth-child(odd) {
            background: var(--ds-gold-light);
            animation-duration: 10s;
            box-shadow: 0 0 8px var(--ds-gold-light);
        }

        .particle-effect .particle:nth-child(even) {
            background: var(--ds-gold-dark);
            animation-duration: 12s;
            box-shadow: 0 0 4px var(--ds-gold-dark);
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 0.7;
                transform: scale(1);
            }
            80% {
                opacity: 0.7;
                transform: scale(1);
            }
            100% {
                transform: translateY(-100px) translateX(100px) scale(0.5);
                opacity: 0;
            }
        }

        /* Effetti di combattimento */
        .combat-effect {
            position: fixed;
            font-family: 'Cinzel', serif;
            font-size: 2em;
            font-weight: bold;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: all 0.5s ease-in-out;
        }

        .combat-effect.damage {
            color: var(--ds-blood);
            text-shadow: 0 0 10px var(--ds-blood-glow);
        }

        .combat-effect.heal {
            color: var(--ds-poison-light);
            text-shadow: 0 0 10px var(--ds-poison-glow);
        }

        .combat-effect.souls {
            color: var(--ds-gold);
            text-shadow: 0 0 10px var(--ds-gold-glow);
        }

        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #start-screen button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%);
            color: var(--ds-gold-light);
            padding: 15px 30px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        #start-screen button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 15px rgba(212, 175, 55, 0.5),
                inset 0 0 10px rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        /* Schermata di morte */
        #death-screen {
            display: none; /* MODIFICA QUI: Inizialmente nascosta */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #000000 0%, #8B0000 25%, #DC143C 50%, #8B0000 75%, #000000 100%),
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.4) 0%, transparent 50%);
            color: var(--ds-blood-light);
            font-family: 'Cinzel', serif;
            font-size: 3em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000; /* Sopra il gioco, sotto la schermata di avvio */
            text-shadow: 0 0 20px var(--ds-blood-light);
            animation: deathPulse 2s ease-in-out infinite;
        }

        @keyframes deathPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        #death-screen h2 {
            font-size: 1.5em;
            margin-top: 20px;
            color: var(--ds-gold);
            text-shadow: 0 0 15px var(--ds-gold);
            animation: deathGlow 3s ease-in-out infinite;
        }

        @keyframes deathGlow {
            0%, 100% { text-shadow: 0 0 15px var(--ds-gold); }
            50% { text-shadow: 0 0 25px var(--ds-gold), 0 0 35px var(--ds-gold); }
        }

        /* Schermata di vittoria */
        #victory-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.85);
            z-index: 1002;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        .victory-canvas {
            background: linear-gradient(135deg, #181818 0%, #23213a 100%);
            border: 4px solid var(--ds-gold);
            border-radius: 18px;
            box-shadow: 0 0 40px var(--ds-gold-glow), 0 0 0 8px rgba(0,0,0,0.5);
            max-width: 900px;
            width: 95vw;
            max-height: 90vh;
            min-width: 320px;
            min-height: 320px;
            padding: 40px 30px 30px 30px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
        }
        #victory-screen h1, #victory-screen p, #victory-stats, #victory-screen button {
            position: relative;
            z-index: 1;
        }

        #victory-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3em;
            color: var(--ds-gold-light);
            margin-bottom: 20px;
            text-shadow: 0 0 30px var(--ds-gold);
            animation: victoryGlow 3s ease-in-out infinite alternate;
        }

        @keyframes victoryGlow {
            from { 
                text-shadow: 0 0 30px var(--ds-gold); 
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px var(--ds-gold), 0 0 50px var(--ds-gold); 
                transform: scale(1.05);
            }
        }

        #victory-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.6;
        }

        #victory-stats {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 0.8em;
        }

        #victory-screen button {
            background: 
                linear-gradient(145deg, #4a4a4a 0%, #2b2b2b 50%, #1a1a1a 100%);
            color: var(--ds-gold-light);
            padding: 15px 30px;
            border: 2px solid var(--ds-gold);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        #victory-screen button:hover {
            background: 
                linear-gradient(145deg, #5a5a5a 0%, #3b3b3b 50%, #2a2a2a 100%);
            border-color: var(--ds-gold-light);
            box-shadow: 
                0 0 25px var(--ds-gold-glow),
                0 0 35px rgba(212, 175, 55, 0.6),
                inset 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-3px);
            text-shadow: 0 0 10px var(--ds-gold-glow);
        }

        /* ANIMAZIONI E TRANSIZIONI - FASE 3 */
        
        /* Transizioni tra scene - Versione Avanzata */
        .scene-transition {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.6s ease-in-out;
            filter: blur(2px);
        }

        .scene-transition.fade-in {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0px);
        }
        
        /* Transizione speciale per combattimenti */
        .combat-transition {
            opacity: 0;
            transform: scale(1.1) rotate(2deg);
            transition: all 0.4s ease-out;
            filter: brightness(1.2) contrast(1.1);
        }
        
        .combat-transition.fade-in {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            filter: brightness(1) contrast(1);
        }
        
        /* Transizione per fuochi sacri */
        .sacred-transition {
            opacity: 0;
            transform: translateY(-10px) scale(0.9);
            transition: all 0.8s ease-in-out;
            filter: sepia(0.3) brightness(1.1);
        }
        
        .sacred-transition.fade-in {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: sepia(0) brightness(1);
        }

        /* Pulsazione per oggetti importanti */
        .important-item {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Effetti particellari per fuochi sacri - Versione Avanzata */
        .sacred-fire-effect {
            position: relative;
            overflow: hidden;
        }

        .sacred-fire-effect::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, rgba(212, 175, 55, 0.4) 0%, transparent 70%),
                radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 50%);
            animation: sacredFireGlow 3s ease-in-out infinite;
            filter: blur(1px);
        }
        
        .sacred-fire-effect::after {
            content: '';
            position: absolute;
            top: -30%;
            left: -30%;
            width: 160%;
            height: 160%;
            background: 
                radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 60%);
            animation: sacredFireGlow 4s ease-in-out infinite reverse;
            filter: blur(2px);
        }

        @keyframes sacredFireGlow {
            0%, 100% { 
                opacity: 0.3; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2) rotate(180deg); 
            }
        }

        /* Animazioni per pulsanti */
        .choice-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .choice-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Effetto ripple per pulsanti */
        .choice-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .choice-button:active::after {
            width: 300px;
            height: 300px;
        }

        /* Animazioni per inventario */
        #inventory-list li {
            margin-bottom: 3px;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 3px;
        }

        #inventory-list li:hover {
            background-color: rgba(138, 255, 138, 0.1);
            transform: translateX(5px);
        }

        /* Animazione per nuovi oggetti */
        .new-item {
            animation: newItemGlow 1s ease-in-out;
        }

        @keyframes newItemGlow {
            0% { background-color: rgba(138, 255, 138, 0.5); transform: scale(1.1); }
            100% { background-color: transparent; transform: scale(1); }
        }

        /* Effetti per schermata di morte */
        #death-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: red;
            font-size: 3em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            animation: deathScreenFade 0.5s ease-in;
        }

        @keyframes deathScreenFade {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Animazioni per statistiche */
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            background-color: rgba(138, 255, 138, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Effetti per fuoco sacro */
        #sacred-fire-status {
            color: #8aff8a;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            animation: sacredFireText 2s ease-in-out infinite;
        }

        @keyframes sacredFireText {
            0%, 100% { text-shadow: 0 0 5px #8aff8a; }
            50% { text-shadow: 0 0 15px #8aff8a, 0 0 25px #8aff8a; }
        }

        /* Animazioni per achievement */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1003;
            animation: achievementSlide 0.5s ease-out, achievementGlow 2s ease-in-out infinite;
            max-width: 300px;
        }

        @keyframes achievementSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes achievementGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(76, 175, 80, 0.5); }
        }

        /* Animazioni per crafting */
        .crafting-success {
            animation: craftingSuccess 1s ease-in-out;
        }

        @keyframes craftingSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: rgba(138, 255, 138, 0.3); }
            100% { transform: scale(1); }
        }

        /* Responsive design migliorato */
        @media (max-width: 768px) {
            #game-container {
                width: 95%;
                height: 90vh;
                flex-direction: column;
            }

            #story-panel {
                flex: 1;
                border-right: none;
                border-bottom: 1px solid #444;
            }

            #status-panel {
                flex: 0 0 auto;
                max-height: 200px;
                overflow-y: auto;
            }

            .choice-button {
                padding: 15px 20px;
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            #title {
                font-size: 1.8em;
            }

            #text {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            #start-screen h1 {
                font-size: 2.5em;
            }

            #victory-screen h1 {
                font-size: 2em;
            }

            .choice-button {
                padding: 18px 20px;
                font-size: 1.2em;
            }
        }

        /* Sistema di Notifiche In-Game */
        .game-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(145deg, rgba(43, 43, 43, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
            border: 2px solid var(--ds-gold);
            border-radius: 8px;
            padding: 15px 20px;
            color: var(--ds-gold-light);
            font-family: 'Cinzel', serif;
            font-size: 1em;
            box-shadow: 0 0 20px var(--ds-gold-glow);
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.5s ease-in-out;
            max-width: 300px;
            opacity: 0;
        }

        .game-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .game-notification.achievement {
            border-color: var(--ds-gold-light);
            box-shadow: 0 0 25px var(--ds-gold-glow);
        }

        .game-notification.damage {
            border-color: var(--ds-blood);
            box-shadow: 0 0 25px var(--ds-blood-glow);
        }

        .game-notification.heal {
            border-color: var(--ds-poison-light);
            box-shadow: 0 0 25px var(--ds-poison-glow);
        }

        .game-notification.item {
            border-color: var(--ds-magic-light);
            box-shadow: 0 0 25px var(--ds-magic-glow);
        }

        .game-notification.souls {
            border-color: var(--ds-gold);
            box-shadow: 0 0 25px var(--ds-gold-glow);
        }

        @media (max-width: 480px) {
            .victory-canvas {
                padding: 12px 5px 18px 5px;
                min-width: unset;
                min-height: 180px;
                max-width: 99vw;
                max-height: 95vh;
            }
            #victory-screen h1 {
                font-size: 1.2em;
                padding: 0 2px;
            }
            #victory-screen p, #victory-stats {
                font-size: 0.95em;
                padding: 0 2px;
            }
            #victory-screen button {
                font-size: 1em;
                padding: 10px 8px;
                margin: 6px 0;
            }
        }

        /* Stili per inventario migliorato */
        #inventory-list li {
            background: var(--ds-black-light);
            border: 1px solid var(--ds-stone);
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        #inventory-list li:hover {
            background: var(--ds-stone-dark);
            border-color: var(--ds-gold);
            transform: translateX(5px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-name {
            font-weight: bold;
            color: var(--ds-gold);
        }

        .item-type {
            font-size: 0.8em;
            color: var(--ds-stone-light);
            background: var(--ds-stone-dark);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .item-effect {
            color: var(--ds-gold-light);
        }

        .item-rarity {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .rarity-comune { background: var(--ds-stone); color: var(--ds-black); }
        .rarity-raro { background: var(--ds-gold-dark); color: var(--ds-black); }
        .rarity-epico { background: var(--ds-magic); color: white; }
        .rarity-leggendario { background: var(--ds-gold); color: var(--ds-black); }
        .rarity-mito { background: linear-gradient(45deg, var(--ds-gold), var(--ds-magic)); color: white; }

        /* Stili per menu crafting */
        .crafting-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .crafting-menu {
            background: var(--ds-black);
            border: 2px solid var(--ds-gold);
            border-radius: 10px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 0 20px var(--ds-gold-glow);
        }

        .crafting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--ds-gold);
            padding-bottom: 10px;
        }

        .crafting-header h2 {
            color: var(--ds-gold);
            margin: 0;
        }

        .close-button {
            background: var(--ds-blood);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .recipe-item {
            background: var(--ds-black-light);
            border: 1px solid var(--ds-stone);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .recipe-item.available {
            border-color: var(--ds-gold);
            background: var(--ds-black-light);
        }

        .recipe-item.unavailable {
            border-color: var(--ds-stone);
            background: var(--ds-black-dark);
            opacity: 0.7;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recipe-header h3 {
            color: var(--ds-gold);
            margin: 0;
        }

        .recipe-cost {
            color: var(--ds-gold-light);
            font-weight: bold;
        }

        .recipe-ingredients {
            margin: 10px 0;
            color: var(--ds-stone-light);
        }

        .ingredient {
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 2px;
        }

        .ingredient.available {
            background: var(--ds-gold-dark);
            color: var(--ds-black);
        }

        .ingredient.missing {
            background: var(--ds-stone);
            color: var(--ds-black);
            text-decoration: line-through;
        }

        .recipe-effect {
            margin: 10px 0;
            color: var(--ds-gold-light);
            font-style: italic;
        }

        .craft-button {
            background: var(--ds-gold);
            color: var(--ds-black);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .craft-button:hover {
            background: var(--ds-gold-light);
            transform: scale(1.05);
        }

        .crafting-requirements {
            color: var(--ds-blood);
            font-size: 0.9em;
            font-style: italic;
        }

        .crafting-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--ds-stone);
        }

        .crafting-stats h3 {
            color: var(--ds-gold);
            margin-bottom: 10px;
        }

        .crafting-stats p {
            color: var(--ds-stone-light);
            margin: 5px 0;
        }

        .souls-available, .unique-ingredients, .available-recipes {
            color: var(--ds-gold);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Elementi particellari fluttuanti -->
    <div class="particles" id="particles-container">
        <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; animation-delay: 1s;"></div>
        <div class="particle" style="left: 30%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 40%; animation-delay: 3s;"></div>
        <div class="particle" style="left: 50%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
        <div class="particle" style="left: 70%; animation-delay: 6s;"></div>
        <div class="particle" style="left: 80%; animation-delay: 7s;"></div>
        <div class="particle" style="left: 90%; animation-delay: 8s;"></div>
        <div class="particle" style="left: 15%; animation-delay: 9s;"></div>
        <div class="particle" style="left: 25%; animation-delay: 10s;"></div>
        <div class="particle" style="left: 35%; animation-delay: 11s;"></div>
        <div class="particle" style="left: 45%; animation-delay: 12s;"></div>
        <div class="particle" style="left: 55%; animation-delay: 13s;"></div>
        <div class="particle" style="left: 65%; animation-delay: 14s;"></div>
        <div class="particle" style="left: 75%; animation-delay: 15s;"></div>
        <div class="particle" style="left: 85%; animation-delay: 16s;"></div>
        <div class="particle" style="left: 95%; animation-delay: 17s;"></div>
    </div>
    
    <!-- Overlay nebbia atmosferica -->
    <div class="fog-overlay"></div>
    
    <div id="start-screen">
        <h1>Il Viaggio dell'Anima Perduta</h1>
        <p>Ti risvegli in una cella umida e buia, senza memoria di come tu sia arrivato qui, o di chi tu sia. Una maledizione ti lega a vagare per l'eternità, a meno che tu non riesca a spezzarla. Questo è il tuo viaggio. Questo è il tuo destino.</p>
        <button onclick="startGame()">INIZIA IL VIAGGIO</button>
        <button onclick="loadGame()">CARICA PARTITA</button>
    </div>

    <div id="game-container">
        <!-- Elementi particellari per il gioco -->
        <div class="particles" id="game-particles">
            <div class="particle" style="left: 5%; animation-delay: 0s;"></div>
            <div class="particle" style="left: 15%; animation-delay: 2s;"></div>
            <div class="particle" style="left: 25%; animation-delay: 4s;"></div>
            <div class="particle" style="left: 35%; animation-delay: 6s;"></div>
            <div class="particle" style="left: 45%; animation-delay: 8s;"></div>
            <div class="particle" style="left: 55%; animation-delay: 10s;"></div>
            <div class="particle" style="left: 65%; animation-delay: 12s;"></div>
            <div class="particle" style="left: 75%; animation-delay: 14s;"></div>
            <div class="particle" style="left: 85%; animation-delay: 16s;"></div>
            <div class="particle" style="left: 95%; animation-delay: 18s;"></div>
        </div>
        
        <div id="story-panel">
            <h1 id="title"></h1>
            <p id="text"></p>
            <div id="choices"></div>
        </div>
        <div id="status-panel">
            <div class="status-section">
                <h3>Stato</h3>
                <div class="status-item">
                    <span>Salute:</span> <span id="health-display"></span>
                </div>
                <div class="status-item">
                    <span>Anime:</span> <span id="souls-display"></span>
                </div>
                <div class="status-item">
                    <span>Karma:</span> <span id="karma-display"></span>
                </div>
                <div class="status-item">
                    <span>Difficoltà:</span> <span id="difficulty-display"></span>
                </div>
            </div>
            <div class="status-section">
                <h3>Inventario</h3>
                <ul id="inventory-list">
                    </ul>
            </div>
            <div class="status-section">
                <h3>Progressione</h3>
                <div class="status-item">
                    <span>Punto di Respawn:</span> <span id="last-sacred-fire-display"></span>
                </div>
                <div id="sacred-fire-status"></div>
            </div>
            <button class="choice-button" onclick="saveGame()">SALVA PARTITA</button>
            <button class="choice-button" onclick="confirmReset()">NUOVA PARTITA</button>
            <button class="choice-button" onclick="showAchievements()">🏆 ACHIEVEMENT</button>
            <button class="choice-button" onclick="showCraftingMenu()">⚗️ CRAFTING</button>
        </div>
    </div>

    <div id="notification-container"></div>

    <div id="death-screen">
        <!-- Particelle rosse per la schermata di morte -->
        <div class="particles" id="death-particles">
            <div class="particle" style="left: 10%; animation-delay: 0s; background: var(--ds-blood);"></div>
            <div class="particle" style="left: 30%; animation-delay: 1s; background: var(--ds-blood-light);"></div>
            <div class="particle" style="left: 50%; animation-delay: 2s; background: var(--ds-blood);"></div>
            <div class="particle" style="left: 70%; animation-delay: 3s; background: var(--ds-blood-light);"></div>
            <div class="particle" style="left: 90%; animation-delay: 4s; background: var(--ds-blood);"></div>
        </div>
        <h1>SEI MORTO</h1>
        <h2>Premi un tasto per tornare all'ultimo Fuoco Sacro...</h2>
    </div>

    <div id="victory-screen">
        <div class="victory-canvas">
            <!-- Particelle dorate per la schermata di vittoria -->
            <div class="particles" id="victory-particles">
                <div class="particle" style="left: 10%; animation-delay: 0s; background: var(--ds-gold-light);"></div>
                <div class="particle" style="left: 30%; animation-delay: 1s; background: var(--ds-gold);"></div>
                <div class="particle" style="left: 50%; animation-delay: 2s; background: var(--ds-gold-light);"></div>
                <div class="particle" style="left: 70%; animation-delay: 3s; background: var(--ds-gold);"></div>
                <div class="particle" style="left: 90%; animation-delay: 4s; background: var(--ds-gold-light);"></div>
            </div>
            <h1>🎉 VITTORIA! 🎉</h1>
            <p>Hai spezzato la maledizione che ti legava a questo luogo! La tua memoria ritorna, e con essa, un senso di pace e libertà. Il viaggio è compiuto.</p>
            <div id="victory-stats">
                <h3>Statistiche Finali</h3>
                <p>Anime raccolte: <span id="final-souls">0</span></p>
                <p>Oggetti trovati: <span id="final-items">0</span></p>
                <p>Fuochi sacri accesi: <span id="final-fires">0</span></p>
            </div>
            <button onclick="newGame()">NUOVA PARTITA</button>
            <button onclick="returnToMenu()">TORNA AL MENU</button>
        </div>
    </div>

    <script>
        // Funzioni per effetti particellari avanzati
        function createParticle(x, y, color, duration = 6) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + '%';
            particle.style.top = y + '%';
            particle.style.background = color;
            particle.style.animationDuration = duration + 's';
            return particle;
        }
        
        function addSacredFireParticles() {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                const particles = gameContainer.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-gold-light)';
                    particle.style.boxShadow = '0 0 10px var(--ds-gold-light)';
                });
            }
        }
        
        function addBloodParticles() {
            const deathScreen = document.getElementById('death-screen');
            if (deathScreen) {
                const particles = deathScreen.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-blood)';
                    particle.style.boxShadow = '0 0 10px var(--ds-blood)';
                });
            }
        }
        
        function addVictoryParticles() {
            const victoryScreen = document.getElementById('victory-screen');
            if (victoryScreen) {
                const particles = victoryScreen.querySelectorAll('.particle');
                particles.forEach(particle => {
                    particle.style.background = 'var(--ds-gold-light)';
                    particle.style.boxShadow = '0 0 15px var(--ds-gold-light)';
                });
            }
        }
        
        // Funzione per animazioni di transizione avanzate
        function animateSceneTransition() {
            const storyPanel = document.getElementById('story-panel');
            if (storyPanel) {
                storyPanel.style.opacity = '0';
                storyPanel.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    storyPanel.style.transition = 'all 0.5s ease-in-out';
                    storyPanel.style.opacity = '1';
                    storyPanel.style.transform = 'translateY(0)';
                }, 100);
            }
        }
        
        // Variabili di stato del gioco
        let playerHealth;
        const maxHealth = 100;
        let souls;
        let inventory;
        let currentScene;
        let lastSacredFire;
        
        // Sistema di flag per prevenire accumulo infinito
        let visitedScenes = new Set();
        let completedActions = new Set();

        // Sistema di Notifiche In-Game
        let notificationQueue = [];
        let isShowingNotification = false;
        let achievementQueue = [];
        let isShowingAchievement = false;

        // ============================================================================
        // SISTEMI NARRATIVI AVANZATI - AGGIUNTI
        // ============================================================================

        // Sistema di memorie e flashback
        const memorySystem = {
            memories: {
                'cella_iniziale': {
                    trigger: 'explore_cell',
                    flashback: 'memory_awakening',
                    karmaEffect: 0,
                    unlockScene: 'personal_items'
                },
                'frammento_specchio': {
                    trigger: 'find_mirror',
                    flashback: 'memory_golden_armor',
                    karmaEffect: 5,
                    healthEffect: -10,
                    unlockScene: 'guardian_revelation'
                },
                'runa_familiare': {
                    trigger: 'read_rune',
                    flashback: 'memory_council',
                    karmaEffect: 10,
                    unlockScene: 'truth_revelation'
                }
            },
            
            triggeredMemories: new Set(),
            
            triggerMemory: function(memoryId) {
                const memory = this.memories[memoryId];
                if (memory && !this.triggeredMemories.has(memoryId)) {
                    this.triggeredMemories.add(memoryId);
                    this.showFlashback(memory.flashback);
                    
                    if (memory.karmaEffect) {
                        karmaSystem.addKarma(memory.karmaEffect);
                    }
                    if (memory.healthEffect) {
                        playerHealth = Math.max(0, playerHealth + memory.healthEffect);
                        updateUI();
                    }
                }
            },
            
            showFlashback: function(flashbackId) {
                // Controllo di sicurezza
                if (!flashbackId) {
                    console.error('Flashback ID non valido');
                    return;
                }
                
                const flashbacks = {
                    'memory_awakening': {
                        title: "Frammento di Memoria",
                        text: "Un'immagine ti attraversa la mente: sei in una sala maestosa, circondato da altri Guardiani delle Anime. 'Devo farlo,' dici a te stesso, 'anche se significa condannare tutti noi a questo ciclo infinito.'",
                        choices: [
                            {
                                text: "Concentrati sul ricordo",
                                action: function() {
                                    if (typeof karmaSystem !== 'undefined') {
                                        karmaSystem.addKarma(5);
                                    }
                                    // Torna alla scena precedente
                                    if (window.sceneHistory && window.sceneHistory.length > 0) {
                                        const previousScene = window.sceneHistory.pop();
                                        const storyText = document.getElementById('story-text');
                                        if (storyText) {
                                            storyText.innerHTML = previousScene.text;
                                        }
                                        // Ripristina le scelte precedenti
                                        restoreChoices(previousScene.choices);
                                    }
                                }
                            },
                            {
                                text: "Respingi il dolore",
                                action: function() {
                                    if (typeof karmaSystem !== 'undefined') {
                                        karmaSystem.addKarma(-5);
                                    }
                                    if (typeof playerHealth !== 'undefined') {
                                        playerHealth -= 10;
                                        if (typeof updateUI === 'function') {
                                            updateUI();
                                        }
                                    }
                                    // Torna alla scena precedente
                                    if (window.sceneHistory && window.sceneHistory.length > 0) {
                                        const previousScene = window.sceneHistory.pop();
                                        const storyText = document.getElementById('story-text');
                                        if (storyText) {
                                            storyText.innerHTML = previousScene.text;
                                        }
                                        restoreChoices(previousScene.choices);
                                    }
                                }
                            }
                        ]
                    },
                    'memory_golden_armor': {
                        title: "L'Armatura Dorata",
                        text: "Nel frammento di specchio vedi un uomo in armatura dorata, con il volto segnato dalla determinazione e dal dolore. Ricordi il momento in cui hai preso la decisione più difficile della tua vita.",
                        choices: [
                            {
                                text: "Accetta la verità",
                                action: function() {
                                    if (typeof karmaSystem !== 'undefined') {
                                        karmaSystem.addKarma(15);
                                    }
                                    if (window.sceneHistory && window.sceneHistory.length > 0) {
                                        const previousScene = window.sceneHistory.pop();
                                        const storyText = document.getElementById('story-text');
                                        if (storyText) {
                                            storyText.innerHTML = previousScene.text;
                                        }
                                        restoreChoices(previousScene.choices);
                                    }
                                }
                            },
                            {
                                text: "Rifiuta il ricordo",
                                action: function() {
                                    if (typeof karmaSystem !== 'undefined') {
                                        karmaSystem.addKarma(-10);
                                    }
                                    if (window.sceneHistory && window.sceneHistory.length > 0) {
                                        const previousScene = window.sceneHistory.pop();
                                        const storyText = document.getElementById('story-text');
                                        if (storyText) {
                                            storyText.innerHTML = previousScene.text;
                                        }
                                        restoreChoices(previousScene.choices);
                                    }
                                }
                            }
                        ]
                    }
                };
                
                const flashback = flashbacks[flashbackId];
                if (flashback) {
                    showMemoryScene(flashback);
                } else {
                    console.error(`Flashback non trovato: ${flashbackId}`);
                }
            }
        };

        // Sistema di karma dinamico - BILANCIATO FASE 4
        const karmaSystem = {
            currentKarma: 0,
            maxKarma: 50,        // Ridotto da 100 per bilanciamento
            minKarma: -50,       // Ridotto da -100 per bilanciamento
            
            addKarma: function(amount) {
                // Limita incrementi massimi per bilanciamento
                const maxIncrement = 10;
                const limitedAmount = Math.max(-maxIncrement, Math.min(maxIncrement, amount));
                
                const oldKarma = this.currentKarma;
                this.currentKarma = Math.max(this.minKarma, 
                                            Math.min(this.maxKarma, 
                                            this.currentKarma + limitedAmount));
                
                this.updateWorldState();
                this.showKarmaChange(limitedAmount);
                
                console.log(`Karma cambiato: ${oldKarma} → ${this.currentKarma} (${limitedAmount > 0 ? '+' : ''}${limitedAmount})`);
            },
            
            updateWorldState: function() {
                // Cambia reazioni NPC basato su karma
                if (this.currentKarma > 50) {
                    window.npcAttitude = 'friendly';
                } else if (this.currentKarma < -50) {
                    window.npcAttitude = 'hostile';
                } else {
                    window.npcAttitude = 'neutral';
                }
            },
            
            showKarmaChange: function(amount) {
                // Mostra un indicatore visivo del cambiamento di karma
                const karmaIndicator = document.createElement('div');
                karmaIndicator.className = 'karma-change';
                karmaIndicator.textContent = amount > 0 ? `+${amount} Karma` : `${amount} Karma`;
                karmaIndicator.style.cssText = `
                    color: ${amount > 0 ? '#8aff8a' : '#ff6b6b'};
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px;
                    background: rgba(0,0,0,0.8);
                    border-radius: 5px;
                    z-index: 1000;
                    font-family: 'Cinzel', serif;
                    font-weight: bold;
                    text-shadow: 0 0 10px currentColor;
                `;
                
                document.body.appendChild(karmaIndicator);
                
                setTimeout(() => {
                    karmaIndicator.remove();
                }, 2000);
            }
        };

        // ============================================================================
        // SISTEMA DI CONSEGUENZE DINAMICHE - FASE 3
        // ============================================================================
        
        const consequenceSystem = {
            // Scene sbloccate/bloccate in base alle scelte
            unlockedScenes: new Set(),
            blockedScenes: new Set(),
            
            // Dialoghi che cambiano in base al karma
            npcDialogues: {
                'veggente': {
                    friendly: "Ti vedo, figlio mio. Il tuo cuore è puro e la tua anima risplende come una stella nel buio. Il destino ti ha scelto per una missione sacra.",
                    neutral: "Un viandante... Interessante. Il tuo karma è in equilibrio, come la bilancia della giustizia. Scegli saggiamente il tuo cammino.",
                    hostile: "Un'anima macchiata dal male si avvicina. Le tue azioni parlano più forte delle tue parole. Pentiti, prima che sia troppo tardi."
                },
                'mercante': {
                    friendly: "Ah, un cliente di valore! Il tuo karma positivo mi dice che sei degno di fiducia. Ho oggetti speciali per anime pure come la tua.",
                    neutral: "Benvenuto, viandante. Il mio negozio è aperto a tutti, purché abbiano qualcosa da offrire in cambio.",
                    hostile: "Hmm... Il tuo karma è oscuro. Non so se dovrei fidarmi di te. Forse dovresti cercare altrove."
                },
                'guardiano': {
                    friendly: "Un fratello! Il tuo karma risplende come l'oro antico. Sei degno di conoscere i segreti più profondi di questo luogo.",
                    neutral: "Un viandante... Il tuo karma è in equilibrio. Forse un giorno sarai degno di conoscere la verità.",
                    hostile: "Un'anima corrotta! Il tuo karma oscuro ti preclude l'accesso ai segreti sacri. Pentiti o perisci."
                }
            },
            
            // Scelte con conseguenze complesse
            choices: {
                'libera_anima': {
                    text: "Libero l'anima, anche se mi costa",
                    karmaEffect: 15,
                    healthEffect: -20,
                    unlockScenes: ['spirito_alleato', 'veggente_friendly'],
                    blockScenes: ['spiriti_ostili', 'mercante_hostile'],
                    dialogChanges: {
                        'veggente': 'friendly',
                        'guardiano': 'friendly'
                    },
                    achievement: 'soul_liberator'
                },
                'bevi_acqua': {
                    text: "Bevo l'acqua per sopravvivere",
                    karmaEffect: -10,
                    healthEffect: 15,
                    unlockScenes: ['spiriti_ostili', 'mercante_hostile'],
                    blockScenes: ['spirito_alleato', 'veggente_friendly'],
                    dialogChanges: {
                        'veggente': 'hostile',
                        'guardiano': 'hostile'
                    }
                },
                'studia_rune': {
                    text: "Studio le rune per comprendere",
                    karmaEffect: 10,
                    healthEffect: -5,
                    unlockScenes: ['conoscenza_antica', 'veggente_neutral'],
                    blockScenes: ['ignoranza_volontaria'],
                    dialogChanges: {
                        'veggente': 'neutral',
                        'guardiano': 'neutral'
                    },
                    achievement: 'rune_scholar'
                },
                'comunica_golem': {
                    text: "Cerco di comunicare con il golem",
                    karmaEffect: 20,
                    healthEffect: -10,
                    unlockScenes: ['golem_alleato', 'veggente_friendly'],
                    blockScenes: ['golem_ostile'],
                    dialogChanges: {
                        'veggente': 'friendly',
                        'guardiano': 'friendly'
                    },
                    achievement: 'golem_friend'
                },
                'sacrifica_memoria': {
                    text: "Sacrifico un ricordo per il potere",
                    karmaEffect: -15,
                    healthEffect: 25,
                    unlockScenes: ['potere_oscuro', 'mercante_hostile'],
                    blockScenes: ['memoria_completa', 'veggente_friendly'],
                    dialogChanges: {
                        'veggente': 'hostile',
                        'guardiano': 'hostile'
                    }
                }
            },
            
            applyChoice: function(choiceId) {
                const choice = this.choices[choiceId];
                if (choice) {
                    // Applica effetti karma e salute
                    if (choice.karmaEffect) {
                        karmaSystem.addKarma(choice.karmaEffect);
                    }
                    if (choice.healthEffect) {
                        playerHealth = Math.max(0, Math.min(maxHealth, playerHealth + choice.healthEffect));
                        updateUI();
                    }
                    
                    // Sblocca/blocca scene
                    if (choice.unlockScenes) {
                        choice.unlockScenes.forEach(scene => {
                            this.unlockedScenes.add(scene);
                            console.log(`Scena sbloccata: ${scene}`);
                        });
                    }
                    if (choice.blockScenes) {
                        choice.blockScenes.forEach(scene => {
                            this.blockedScenes.add(scene);
                            console.log(`Scena bloccata: ${scene}`);
                        });
                    }
                    
                    // Cambia dialoghi NPC
                    if (choice.dialogChanges) {
                        Object.keys(choice.dialogChanges).forEach(npc => {
                            this.updateNPCDialog(npc, choice.dialogChanges[npc]);
                        });
                    }
                    
                    // Sblocca achievement
                    if (choice.achievement) {
                        this.unlockAchievement(choice.achievement);
                    }
                    
                    console.log(`Conseguenza applicata per scelta: ${choiceId}`);
                }
            },
            
            updateNPCDialog: function(npcId, attitude) {
                if (this.npcDialogues[npcId] && this.npcDialogues[npcId][attitude]) {
                    window[`${npcId}_dialog`] = this.npcDialogues[npcId][attitude];
                    console.log(`Dialogo ${npcId} aggiornato a: ${attitude}`);
                }
            },
            
            unlockAchievement: function(achievementId) {
                const achievements = {
                    'soul_liberator': {
                        title: "Liberatore di Anime",
                        description: "Hai liberato un'anima intrappolata",
                        karmaBonus: 10
                    },
                    'rune_scholar': {
                        title: "Studioso delle Rune",
                        description: "Hai studiato le rune antiche",
                        karmaBonus: 5
                    },
                    'golem_friend': {
                        title: "Amico dei Golem",
                        description: "Hai comunicato con un golem",
                        karmaBonus: 15
                    }
                };
                
                const achievement = achievements[achievementId];
                if (achievement && !window.unlockedAchievements) {
                    window.unlockedAchievements = new Set();
                }
                
                if (achievement && !window.unlockedAchievements.has(achievementId)) {
                    window.unlockedAchievements.add(achievementId);
                    karmaSystem.addKarma(achievement.karmaBonus);
                    showNotification(`🏆 Achievement: ${achievement.title}`, 'achievement', 5000);
                    console.log(`Achievement sbloccato: ${achievement.title}`);
                }
            },
            
            isSceneUnlocked: function(sceneId) {
                return this.unlockedScenes.has(sceneId);
            },
            
            isSceneBlocked: function(sceneId) {
                return this.blockedScenes.has(sceneId);
            },
            
            getNPCDialog: function(npcId) {
                const attitude = karmaSystem.currentKarma > 50 ? 'friendly' : 
                               karmaSystem.currentKarma < -50 ? 'hostile' : 'neutral';
                return this.npcDialogues[npcId] ? this.npcDialogues[npcId][attitude] : null;
            }
        };

        // ============================================================================
        // SISTEMA DI MEMORIA DELLE SCELTE - PRIORITÀ CRITICA
        // ============================================================================
        
        const choiceMemory = {
            // Mappa delle scelte fatte dal giocatore
            choices: new Map(),
            
            // Storia delle scelte per analisi
            choiceHistory: [],
            
            // Record delle scelte con timestamp e conseguenze
            recordChoice: function(sceneId, choiceId, karmaEffect, additionalData = {}) {
                const choiceKey = `${sceneId}_${choiceId}`;
                const choiceRecord = {
                    sceneId: sceneId,
                    choiceId: choiceId,
                    karmaEffect: karmaEffect,
                    timestamp: Date.now(),
                    consequences: [],
                    additionalData: additionalData
                };
                
                this.choices.set(choiceKey, choiceRecord);
                this.choiceHistory.push(choiceRecord);
                
                console.log(`Scelta registrata: ${sceneId} -> ${choiceId} (Karma: ${karmaEffect})`);
                
                // Applica conseguenze immediate
                this.applyChoiceConsequences(choiceRecord);
            },
            
            // Verifica se una scelta è stata fatta
            hasMadeChoice: function(sceneId, choiceId) {
                const choiceKey = `${sceneId}_${choiceId}`;
                return this.choices.has(choiceKey);
            },
            
            // Ottieni la storia completa delle scelte
            getChoiceHistory: function() {
                return Array.from(this.choices.entries());
            },
            
            // Ottieni scelte per una scena specifica
            getChoicesForScene: function(sceneId) {
                const sceneChoices = [];
                this.choices.forEach((choice, key) => {
                    if (choice.sceneId === sceneId) {
                        sceneChoices.push(choice);
                    }
                });
                return sceneChoices;
            },
            
            // Applica conseguenze delle scelte
            applyChoiceConsequences: function(choiceRecord) {
                // Sblocca scene basate su scelte precedenti
                this.checkChoiceUnlocks(choiceRecord);
                
                // Modifica dialoghi NPC basati su scelte
                this.updateNPCDialogs(choiceRecord);
                
                // Evolvi oggetti basati su uso
                this.evolveItems(choiceRecord);
            },
            
            // Controlla sblocchi basati su scelte
            checkChoiceUnlocks: function(choiceRecord) {
                const unlockRules = {
                    'cellaIniziale_explore_cell': {
                        unlocks: ['personal_items', 'guardian_revelation'],
                        blocks: ['ignorance_path']
                    },
                    'esploraCella_study_runes': {
                        unlocks: ['ancient_knowledge', 'rune_mastery'],
                        blocks: ['ignorance_voluntary']
                    },
                    'salaGolem_communicate': {
                        unlocks: ['golem_ally', 'ancient_secrets'],
                        blocks: ['golem_enemy']
                    }
                };
                
                const ruleKey = `${choiceRecord.sceneId}_${choiceRecord.choiceId}`;
                const rule = unlockRules[ruleKey];
                
                if (rule) {
                    if (rule.unlocks) {
                        rule.unlocks.forEach(scene => {
                            consequenceSystem.unlockedScenes.add(scene);
                            console.log(`Scena sbloccata per scelta: ${scene}`);
                        });
                    }
                    if (rule.blocks) {
                        rule.blocks.forEach(scene => {
                            consequenceSystem.blockedScenes.add(scene);
                            console.log(`Scena bloccata per scelta: ${scene}`);
                        });
                    }
                }
            },
            
            // Aggiorna dialoghi NPC basati su scelte
            updateNPCDialogs: function(choiceRecord) {
                const dialogChanges = {
                    'cellaIniziale_explore_cell': {
                        'veggente': 'friendly',
                        'guardiano': 'friendly'
                    },
                    'esploraCella_study_runes': {
                        'veggente': 'neutral',
                        'guardiano': 'neutral'
                    },
                    'salaGolem_communicate': {
                        'veggente': 'friendly',
                        'guardiano': 'friendly'
                    }
                };
                
                const changeKey = `${choiceRecord.sceneId}_${choiceRecord.choiceId}`;
                const changes = dialogChanges[changeKey];
                
                if (changes) {
                    Object.keys(changes).forEach(npc => {
                        consequenceSystem.updateNPCDialog(npc, changes[npc]);
                    });
                }
            },
            
            // Evolvi oggetti basati su uso
            evolveItems: function(choiceRecord) {
                const itemEvolutions = {
                    'frammento_specchio_use': {
                        item: 'Frammento di Specchio',
                        evolution: 'Frammento di Specchio Risplendente',
                        effect: 'Evoca flashback più intensi'
                    },
                    'rune_study': {
                        item: 'Conoscenza delle Rune',
                        evolution: 'Maestria delle Rune',
                        effect: 'Decifra rune più complesse'
                    }
                };
                
                const evolutionKey = `${choiceRecord.sceneId}_${choiceRecord.choiceId}`;
                const evolution = itemEvolutions[evolutionKey];
                
                if (evolution && inventory.includes(evolution.item)) {
                    const index = inventory.indexOf(evolution.item);
                    inventory[index] = evolution.evolution;
                    showNotification(`✨ ${evolution.item} si è evoluto in ${evolution.evolution}!`, 'achievement', 4000);
                    console.log(`Oggetto evoluto: ${evolution.item} -> ${evolution.evolution}`);
                }
            },
            
            // Ottieni statistiche delle scelte
            getChoiceStats: function() {
                const stats = {
                    totalChoices: this.choiceHistory.length,
                    positiveKarmaChoices: 0,
                    negativeKarmaChoices: 0,
                    neutralChoices: 0,
                    mostFrequentScene: null,
                    averageKarmaEffect: 0
                };
                
                let totalKarma = 0;
                const sceneCounts = {};
                
                this.choiceHistory.forEach(choice => {
                    totalKarma += choice.karmaEffect;
                    
                    if (choice.karmaEffect > 0) stats.positiveKarmaChoices++;
                    else if (choice.karmaEffect < 0) stats.negativeKarmaChoices++;
                    else stats.neutralChoices++;
                    
                    sceneCounts[choice.sceneId] = (sceneCounts[choice.sceneId] || 0) + 1;
                });
                
                stats.averageKarmaEffect = this.choiceHistory.length > 0 ? totalKarma / this.choiceHistory.length : 0;
                
                // Trova la scena più frequente
                let maxCount = 0;
                Object.keys(sceneCounts).forEach(scene => {
                    if (sceneCounts[scene] > maxCount) {
                        maxCount = sceneCounts[scene];
                        stats.mostFrequentScene = scene;
                    }
                });
                
                return stats;
            }
        };

        // ============================================================================
        // SISTEMA DI SCENE EVOLUTIVE - PRIORITÀ CRITICA
        // ============================================================================
        
        const evolvingScenes = {
            // Stati delle scene che cambiano nel tempo
            sceneStates: new Map(),
            
            // Regole di evoluzione per ogni scena
            evolutionRules: {
                'cellaIniziale': {
                    states: {
                        'initial': {
                            description: "Ti risvegli su un giaciglio di paglia putrescente, il corpo indolenzito da un sonno che sembra essere durato un'eternità. Le pareti di pietra grezza della cella sono ricoperte di rune antiche che pulsano di una luce sinistra, e l'aria è pesante dell'odore di morte e disperazione.\n\nUn piccolo spiraglio in alto lascia filtrare una luce grigia e malaticcia, l'unico segno che esiste ancora un mondo al di fuori di queste mura. Ma è la sensazione più strana che ti tormenta: un vuoto nel petto, come se qualcosa di fondamentale ti fosse stato strappato via.\n\nI tuoi occhi si posano su una parete dove, tra le rune, riconosci il tuo nome inciso con mano tremante: \"Aric\". È tutto quello che ricordi di te stesso.",
                            choices: ['explore_cell', 'concentrate_memories', 'cry_for_help']
                        },
                        'after_flashback': {
                            description: "La cella ora ti sembra diversa. Le rune sulle pareti non sono più solo decorazioni sinistre, ma portatrici di un messaggio che solo tu puoi comprendere. Il tuo nome \"Aric\" inciso sulla parete risplende con una luce interiore, come se stesse cercando di comunicare con te.\n\nIl vuoto nel petto ora ha un nome: è la mancanza della tua anima completa, strappata via dalla maledizione che tu stesso hai creato. Ogni respiro ti porta più vicino alla verità, anche se quella verità potrebbe distruggerti.",
                            choices: ['explore_cell_deep', 'accept_truth', 'deny_memory']
                        },
                        'after_rune_discovery': {
                            description: "Le rune ora danzano davanti ai tuoi occhi, raccontando la storia di Eldoria e del tuo ruolo come Guardiano delle Anime. La cella non è più una prigione, ma un luogo sacro dove hai iniziato il tuo viaggio di redenzione.\n\nIl nome \"Aric\" sulla parete ora brilla con l'energia delle anime che hai protetto, e le rune circostanti formano un pattern che riconosci: è il sigillo della maledizione che hai creato cento anni fa.",
                            choices: ['embrace_power', 'seek_redemption', 'study_deeper']
                        },
                        'after_acceptance': {
                            description: "La cella si è trasformata completamente. Le rune pulsano con la tua energia di Guardiano, e l'aria stessa sembra vibrare con il potere delle anime che hai protetto. Questo non è più il luogo del tuo risveglio confuso, ma il sacrario dove hai accettato il tuo destino.\n\nIl nome \"Aric\" ora risplende come una stella, e le pareti sono ricoperte di simboli che solo un Guardiano delle Anime può comprendere. La cella è diventata il tuo punto di potere.",
                            choices: ['channel_energy', 'plan_redemption', 'commune_spirits']
                        }
                    },
                    triggers: {
                        'memory_flashback': 'after_flashback',
                        'rune_study': 'after_rune_discovery',
                        'truth_acceptance': 'after_acceptance'
                    }
                },
                'salaGolem': {
                    states: {
                        'initial': {
                            description: "Il ronzio si fa più forte. Entri in una grande sala. Al centro, un imponente Golem di pietra, ricoperto di muschio, blocca il passaggio principale. I suoi occhi di giada si accendono al tuo arrivo.",
                            choices: ['attack_golem', 'find_weakness', 'try_bypass']
                        },
                        'after_communication': {
                            description: "Il Golem non è più un nemico, ma un custode antico che riconosce in te un Guardiano delle Anime. I suoi occhi di giada brillano con intelligenza, e le rune sul suo petto pulsano in risposta alla tua presenza.\n\nAttraverso le rune, riesci a comunicare con lui. È stato creato per proteggere i segreti di Eldoria, e ora che ha riconosciuto la tua vera natura, è disposto ad aiutarti nel tuo viaggio di redenzione.",
                            choices: ['commune_golem', 'learn_secrets', 'request_help']
                        },
                        'after_alliance': {
                            description: "Il Golem è ora il tuo alleato più fedele. Le rune sul suo petto brillano con l'energia delle anime che protegge, e la sala stessa sembra risuonare con il potere antico dei Guardiani.\n\nAttraverso la connessione runica, il Golem ti rivela i segreti più profondi di Eldoria e ti guida verso la comprensione della maledizione che hai creato.",
                            choices: ['receive_wisdom', 'plan_liberation', 'strengthen_bond']
                        },
                        'after_corruption': {
                            description: "Il Golem è stato corrotto dal tuo karma negativo. I suoi occhi di giada ora brillano di una luce sinistra, e le rune sul suo petto pulsano con energia oscura.\n\nRiconosce in te un Guardiano delle Anime, ma la tua corruzione lo ha trasformato in un guardiano del male. È ancora potente, ma ora serve il lato oscuro della maledizione.",
                            choices: ['fight_corrupted', 'embrace_darkness', 'attempt_purification']
                        }
                    },
                    triggers: {
                        'communicate_golem': 'after_communication',
                        'ally_golem': 'after_alliance',
                        'corrupt_golem': 'after_corruption'
                    }
                },
                'terreSelvagge': {
                    states: {
                        'initial': {
                            description: "Il vento ti accarezza il viso mentre esci all'aperto. Ti trovi in un vasto altopiano roccioso, costellato di arbusti secchi e imponenti formazioni rocciose. All'orizzonte, vedi le luci di quella che sembra una piccola città.",
                            choices: ['go_to_city', 'explore_ruins', 'search_resources']
                        },
                        'karma_high': {
                            description: "Le Terre Selvagge si sono trasformate sotto l'influenza del tuo karma positivo. I fiori selvatici sbocciano tra le rocce, e l'aria stessa sembra più pura e vivificante. Le creature che incontri non sono più ostili, ma guardano con rispetto la tua aura di Guardiano delle Anime.\n\nIl mondo risponde alla tua bontà, e anche le rovine sembrano meno sinistre, come se la speranza stesse tornando a Eldoria.",
                            choices: ['bless_land', 'heal_creatures', 'spread_hope']
                        },
                        'karma_low': {
                            description: "Le Terre Selvagge si sono corrotte sotto l'influenza del tuo karma negativo. L'aria è pesante di energia oscura, e le creature che incontri sono più aggressive e corrotte. Le rovine sembrano più sinistre, e l'atmosfera è carica di male.\n\nIl mondo risponde alla tua corruzione, e anche la natura sembra piegarsi al potere oscuro che hai abbracciato.",
                            choices: ['corrupt_further', 'dominate_creatures', 'spread_fear']
                        },
                        'karma_neutral': {
                            description: "Le Terre Selvagge mantengono il loro equilibrio naturale. Non sono né benedette né corrotte, ma riflettono la tua saggezza e comprensione. Le creature ti rispettano per la tua saggezza, e le rovine custodiscono i loro segreti in attesa di essere scoperti.\n\nIl mondo risponde alla tua saggezza, e l'equilibrio tra bene e male si mantiene perfetto.",
                            choices: ['seek_balance', 'study_nature', 'maintain_harmony']
                        }
                    },
                    triggers: {
                        'karma_positive': 'karma_high',
                        'karma_negative': 'karma_low',
                        'karma_neutral': 'karma_neutral'
                    }
                }
            },
            
            // Aggiorna lo stato di una scena
            updateSceneState: function(sceneId, newState) {
                this.sceneStates.set(sceneId, newState);
                console.log(`Stato scena ${sceneId} aggiornato a: ${newState}`);
            },
            
            // Ottieni lo stato corrente di una scena
            getSceneState: function(sceneId) {
                return this.sceneStates.get(sceneId) || 'initial';
            },
            
            // Verifica se una scena è cambiata
            hasSceneChanged: function(sceneId) {
                return this.sceneStates.has(sceneId);
            },
            
            // Ottieni la descrizione evoluta di una scena
            getEvolvedDescription: function(sceneId) {
                const rule = this.evolutionRules[sceneId];
                if (!rule) return null;
                
                const currentState = this.getSceneState(sceneId);
                const stateData = rule.states[currentState];
                
                return stateData ? stateData.description : null;
            },
            
            // Ottieni le scelte evolute di una scena
            getEvolvedChoices: function(sceneId) {
                const rule = this.evolutionRules[sceneId];
                if (!rule) return null;
                
                const currentState = this.getSceneState(sceneId);
                const stateData = rule.states[currentState];
                
                return stateData ? stateData.choices : null;
            },
            
            // Controlla trigger di evoluzione
            checkEvolutionTriggers: function(sceneId, action) {
                const rule = this.evolutionRules[sceneId];
                if (!rule || !rule.triggers) return;
                
                const trigger = rule.triggers[action];
                if (trigger) {
                    this.updateSceneState(sceneId, trigger);
                    console.log(`Trigger attivato per ${sceneId}: ${action} -> ${trigger}`);
                }
            },
            
            // Applica evoluzione basata su karma
            applyKarmaEvolution: function(sceneId) {
                const currentKarma = karmaSystem.currentKarma;
                let karmaState = 'karma_neutral';
                
                if (currentKarma > 30) karmaState = 'karma_positive';
                else if (currentKarma < -30) karmaState = 'karma_negative';
                
                this.checkEvolutionTriggers(sceneId, karmaState);
            }
        };

        function showNotification(message, type = 'info', duration = 3000) {
            notificationQueue.push({ message, type, duration });
            if (!isShowingNotification) {
                processNotificationQueue();
            }
        }

        function processNotificationQueue() {
            if (notificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }
            
            isShowingNotification = true;
            const notification = notificationQueue.shift();
            displayNotification(notification.message, notification.type, notification.duration);
        }

        function displayNotification(message, type, duration) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            notification.className = `game-notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Animazione di entrata
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Rimozione automatica
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                    processNotificationQueue();
                }, 500);
            }, duration);
        }

        // Funzioni specifiche per tipo di notifica
        function showSimpleAchievement(achievementName) {
            // Usa il sistema di notifiche in-game per achievement semplici
            const message = `🏆 ACHIEVEMENT: ${achievementName}`;
            showNotification(message, 'achievement', 4000);
        }

        // Funzione per achievement complessi con descrizione
        function showDetailedAchievement(title, description) {
            achievementQueue.push({ title, description });
            if (!isShowingAchievement) {
                processAchievementQueue();
            }
        }

        function processAchievementQueue() {
            if (achievementQueue.length === 0) {
                isShowingAchievement = false;
                return;
            }
            
            isShowingAchievement = true;
            const achievement = achievementQueue.shift();
            displayDetailedAchievement(achievement.title, achievement.description);
        }

        function displayDetailedAchievement(title, description) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">🏆 ${title}</div>
                <div style="font-size: 0.9em;">${description}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi la notifica dopo 3 secondi
            setTimeout(() => {
                notification.style.animation = 'achievementSlide 0.5s ease-in reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    processAchievementQueue();
                }, 500);
            }, 3000);
        }

        // Funzione di validazione per i danni
        function validateDamage(damage, defaultDamage = 10) {
            if (typeof damage === 'undefined' || isNaN(damage) || damage < 0) {
                return defaultDamage;
            }
            return damage;
        }

        function showDamageNotification(damage, enemyType = '') {
            const safeDamage = validateDamage(damage, 10);
            const message = `⚔️ Hai subito ${safeDamage} danni${enemyType ? ` da ${enemyType}` : ''}`;
            showNotification(message, 'damage', 2500);
        }

        function showHealNotification(healAmount) {
            const message = `💚 Hai recuperato ${healAmount} HP`;
            showNotification(message, 'heal', 2500);
        }

        function showItemNotification(itemName, isNew = true) {
            const prefix = isNew ? '🎁 Nuovo oggetto:' : '📦 Oggetto:';
            const message = `${prefix} ${itemName}`;
            showNotification(message, 'item', 3000);
        }

        function showSoulsNotification(soulsAmount) {
            const message = `💀 +${soulsAmount} anime`;
            showNotification(message, 'souls', 2000);
        }

        // NUOVE FUNZIONI SPECIFICHE PER TIPI DI NOTIFICHE
        function showCraftingNotification(itemName) {
            const message = `⚒️ CRAFTING COMPLETATO: ${itemName}!`;
            showNotification(message, 'achievement', 3000);
        }

        function showEscapeNotification(success, damage = 0) {
            if (success) {
                const message = damage > 0 ? `🏃 Fuga riuscita! Hai subito ${damage} danni durante la fuga.` : '🏃 Fuga riuscita!';
                showNotification(message, 'heal', 3000);
            } else {
                const message = `❌ Fuga fallita! Hai subito ${damage} danni aggiuntivi.`;
                showNotification(message, 'damage', 3000);
            }
        }

        function showHealthWarningNotification() {
            const message = '⚠️ Sei troppo debole per fuggire! Salute insufficiente.';
            showNotification(message, 'damage', 4000);
        }

        function showMemoryNotification(memoryType) {
            const messages = {
                'frammento': '🧠 Hai ottenuto un Frammento di Memoria!',
                'conoscenza': '📚 Hai ottenuto la Conoscenza del Passato!',
                'ricordi': '💭 Hai recuperato ricordi parziali!',
                'verità': '🔮 I sogni ti hanno rivelato la verità!'
            };
            const message = messages[memoryType] || '🧠 Nuova memoria scoperta!';
            showNotification(message, 'achievement', 4000);
        }

        function showLocationNotification(locationName, action = 'scoperto') {
            const message = `🗺️ ${locationName} ${action}!`;
            showNotification(message, 'achievement', 3000);
        }

        function showCombatNotification(enemyName, result, damage = 0) {
            let message;
            if (result === 'victory') {
                message = `⚔️ Hai sconfitto ${enemyName}!`;
            } else if (result === 'damage') {
                message = `⚔️ ${enemyName} ti ha attaccato! Hai subito ${damage} danni.`;
            } else if (result === 'weakened') {
                message = `⚔️ ${enemyName} è stato indebolito!`;
            }
            showNotification(message, result === 'victory' ? 'achievement' : 'damage', 3000);
        }

        // SISTEMA ACHIEVEMENT MIGLIORATO
        const achievementSystem = {
            achievements: {
                'soul_liberator': {
                    title: 'Liberatore di Anime',
                    description: 'Hai liberato 100 anime perdute',
                    karmaBonus: 20,
                    soulsReward: 50
                },
                'rune_scholar': {
                    title: 'Studioso delle Rune',
                    description: 'Hai decifrato 5 rune antiche',
                    karmaBonus: 15,
                    soulsReward: 30
                },
                'golem_friend': {
                    title: 'Amico del Golem',
                    description: 'Hai fatto pace con il Golem di Pietra Antica',
                    karmaBonus: 25,
                    soulsReward: 40
                },
                'memory_keeper': {
                    title: 'Custode della Memoria',
                    description: 'Hai recuperato tutti i frammenti di memoria',
                    karmaBonus: 30,
                    soulsReward: 60
                },
                'curse_breaker': {
                    title: 'Spezzatore di Maledizioni',
                    description: 'Hai rotto il ciclo della maledizione',
                    karmaBonus: 50,
                    soulsReward: 100
                },
                'dark_ascension': {
                    title: 'Ascensione delle Tenebre',
                    description: 'Hai abbracciato il potere oscuro',
                    karmaBonus: -30,
                    soulsReward: 80
                },
                'survival_sage': {
                    title: 'Saggio della Sopravvivenza',
                    description: 'Hai trovato l\'equilibrio tra luce e ombra',
                    karmaBonus: 10,
                    soulsReward: 40
                },
                'explorer': {
                    title: 'Esploratore Infaticabile',
                    description: 'Hai visitato tutti i luoghi principali',
                    karmaBonus: 15,
                    soulsReward: 35
                },
                'craftsman': {
                    title: 'Artigiano Abile',
                    description: 'Hai completato 5 crafting',
                    karmaBonus: 10,
                    soulsReward: 25
                },
                'guardian': {
                    title: 'Guardiano Riconosciuto',
                    description: 'Hai accettato il tuo ruolo di Guardiano delle Anime',
                    karmaBonus: 20,
                    soulsReward: 45
                }
            },

            unlockedAchievements: new Set(),

            unlockAchievement: function(achievementId) {
                const achievement = this.achievements[achievementId];
                if (achievement && !this.unlockedAchievements.has(achievementId)) {
                    this.unlockedAchievements.add(achievementId);
                    
                    // Applica bonus
                    if (achievement.karmaBonus) {
                        karmaSystem.addKarma(achievement.karmaBonus);
                    }
                    if (achievement.soulsReward) {
                        souls += achievement.soulsReward;
                        updateUI();
                    }

                    // Mostra notifica achievement
                    showDetailedAchievement(achievement.title, achievement.description);
                    
                    console.log(`Achievement sbloccato: ${achievement.title}`);
                }
            },

            checkAchievements: function() {
                // Controlla achievement basati su statistiche
                if (souls >= 100 && !this.unlockedAchievements.has('soul_liberator')) {
                    this.unlockAchievement('soul_liberator');
                }
                
                // Altri controlli achievement...
            },

            getAchievementProgress: function(achievementId) {
                const achievement = this.achievements[achievementId];
                if (!achievement) return 0;
                
                // Logica per calcolare progresso achievement
                return this.unlockedAchievements.has(achievementId) ? 100 : 0;
            }
        };

        // Sostituisce la funzione showAchievementNotification esistente
        function showAchievementNotification(achievementName) {
            showDetailedAchievement(achievementName, 'Hai completato un obiettivo importante!');
        }

        // Sistema barre stato avanzate
        function updateHealthBar() {
            const healthBar = document.getElementById('health-bar');
            if (healthBar) {
                const healthPercentage = (playerHealth / maxHealth) * 100;
                
                healthBar.style.width = healthPercentage + '%';
                
                if (healthPercentage < 25) {
                    healthBar.style.backgroundColor = 'var(--ds-blood)';
                    healthBar.style.boxShadow = '0 0 10px var(--ds-blood-glow)';
                } else if (healthPercentage < 50) {
                    healthBar.style.backgroundColor = 'var(--ds-gold-dark)';
                    healthBar.style.boxShadow = '0 0 5px var(--ds-gold-glow)';
                } else {
                    healthBar.style.backgroundColor = 'var(--ds-gold)';
                    healthBar.style.boxShadow = 'none';
                }
            }
        }

        function updateSoulsBar() {
            const soulsBar = document.getElementById('souls-bar');
            if (soulsBar) {
                const soulsPercentage = Math.min((souls / 1000) * 100, 100); // Max 1000 anime
                soulsBar.style.width = soulsPercentage + '%';
                
                if (soulsPercentage > 80) {
                    soulsBar.style.backgroundColor = 'var(--ds-gold-light)';
                    soulsBar.style.boxShadow = '0 0 15px var(--ds-gold-glow)';
                } else if (soulsPercentage > 50) {
                    soulsBar.style.backgroundColor = 'var(--ds-gold)';
                    soulsBar.style.boxShadow = '0 0 8px var(--ds-gold-glow)';
                } else {
                    soulsBar.style.backgroundColor = 'var(--ds-gold-dark)';
                    soulsBar.style.boxShadow = 'none';
                }
            }
        }

        function updateKarmaDisplay() {
            const karmaDisplay = document.getElementById('karma-display');
            if (karmaDisplay && typeof karmaSystem !== 'undefined') {
                const karma = karmaSystem.currentKarma;
                const maxKarma = karmaSystem.maxKarma;
                
                // Formatta il karma con segno
                const karmaText = karma >= 0 ? `+${karma}` : `${karma}`;
                karmaDisplay.textContent = `${karmaText}/${maxKarma}`;
                
                // Colori basati sul karma
                if (karma > 20) {
                    karmaDisplay.style.color = 'var(--ds-gold)';
                    karmaDisplay.style.textShadow = '0 0 5px var(--ds-gold-glow)';
                } else if (karma < -20) {
                    karmaDisplay.style.color = 'var(--ds-blood)';
                    karmaDisplay.style.textShadow = '0 0 5px var(--ds-blood-glow)';
                } else {
                    karmaDisplay.style.color = 'var(--ds-stone-light)';
                    karmaDisplay.style.textShadow = 'none';
                }
            }
        }

        // Effetti combattimento avanzati
        function showCombatEffect(type, damage) {
            const effect = document.createElement('div');
            effect.className = `combat-effect ${type}`;
            effect.textContent = type === 'damage' ? `-${damage}` : `+${damage}`;
            
            // Posizione casuale sullo schermo
            effect.style.left = Math.random() * 80 + 10 + '%';
            effect.style.top = Math.random() * 60 + 20 + '%';
            
            document.body.appendChild(effect);
            
            // Animazione di entrata
            setTimeout(() => {
                effect.style.opacity = '1';
                effect.style.transform = 'translateY(-50px) scale(1.2)';
            }, 100);
            
            // Rimozione automatica
            setTimeout(() => {
                effect.style.opacity = '0';
                effect.style.transform = 'translateY(-100px) scale(0.8)';
                setTimeout(() => {
                    if (document.body.contains(effect)) {
                        document.body.removeChild(effect);
                    }
                }, 500);
            }, 1500);
        }

        function showScreenShake(intensity = 5) {
            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                gameContainer.style.animation = `screenShake ${intensity * 0.1}s ease-in-out`;
                setTimeout(() => {
                    gameContainer.style.animation = '';
                }, intensity * 100);
            }
        }

        // Sistema difficoltà dinamico
        let gameDifficulty = 1.0; // Moltiplicatore di difficoltà
        let difficultyLevel = 'Normale';

        function updateDifficulty() {
            // La difficoltà aumenta con il progresso del giocatore
            const progressFactor = (souls / 100) + (inventory.length * 0.1);
            gameDifficulty = Math.min(2.0, 1.0 + (progressFactor * 0.1));
            
            if (gameDifficulty >= 1.8) {
                difficultyLevel = 'Estrema';
            } else if (gameDifficulty >= 1.5) {
                difficultyLevel = 'Difficile';
            } else if (gameDifficulty >= 1.2) {
                difficultyLevel = 'Media';
            } else {
                difficultyLevel = 'Normale';
            }
            
            // Aggiorna l'UI con la difficoltà
            const difficultyDisplay = document.getElementById('difficulty-display');
            if (difficultyDisplay) {
                difficultyDisplay.textContent = `Difficoltà: ${difficultyLevel}`;
                difficultyDisplay.style.color = gameDifficulty >= 1.5 ? 'var(--ds-blood)' : 'var(--ds-gold)';
            }
        }

        function calculateDamage(baseDamage, enemyType = '') {
            let finalDamage = baseDamage * gameDifficulty;
            
            // Bonus di difficoltà per nemici specifici
            if (enemyType.includes('Golem')) {
                finalDamage *= 1.2;
            } else if (enemyType.includes('mummia')) {
                finalDamage *= 1.1;
            }
            
            return Math.floor(finalDamage);
        }

        // Flag per eventi specifici
        let hasKey = false;
        let hasMap = false;
        let foundSecretTunnel = false;
        let foughtGolem = false;
        let exploredDeepCrypt = false; // Nuovo flag per l'esplorazione profonda della cripta
        let hasPartialMemory = false; // Nuovo flag per ricordi parziali
        let hasAlertedGuards = false; // Nuovo flag per guardie allertate
        let hasDefeatedMummy = false; // Nuovo flag per mummia sconfitta
        
        // Variabili per Multiple Ending
        let playerChoices = {
            hasHelpedAlchemist: false,
            hasCollectedAllArtifacts: false,
            hasUsedDarkMagic: false,
            hasEscapedWithoutCure: false,
            hasAcceptedCurse: false
        };
        
        // Sistema Achievement
        let achievements = {
            firstDeath: false,
            golemSlayer: false,
            treasureHunter: false,
            memoryRecovery: false,
            curseBreaker: false,
            alchemistHelper: false,
            libraryScholar: false,
            secretExplorer: false
        };

        // Oggetto che definisce le scene del gioco
        const scenes = {
            cellaIniziale: {
                title: "Il Risveglio di Aric",
                text: "Ti risvegli su un giaciglio di paglia putrescente, il corpo indolenzito da un sonno che sembra essere durato un'eternità. Le pareti di pietra grezza della cella sono ricoperte di rune antiche che pulsano di una luce sinistra, e l'aria è pesante dell'odore di morte e disperazione.\n\nUn piccolo spiraglio in alto lascia filtrare una luce grigia e malaticcia, l'unico segno che esiste ancora un mondo al di fuori di queste mura. Ma è la sensazione più strana che ti tormenta: un vuoto nel petto, come se qualcosa di fondamentale ti fosse stato strappato via.\n\nI tuoi occhi si posano su una parete dove, tra le rune, riconosci il tuo nome inciso con mano tremante: \"Aric Valenheart\". Il cognome ti suona familiare, come un'eco di un passato che non riesci a ricordare. Le rune intorno al tuo nome sembrano pulsare con una luce più intensa, come se riconoscessero qualcosa in te che tu stesso hai dimenticato.",
                onEnter: function() {
                    // Inizializza il sistema di karma se non esiste
                    if (typeof karmaSystem === 'undefined') {
                        console.log('Sistema karma non trovato, inizializzazione...');
                    }
                },
                choices: [
                    { 
                        text: "Esplora la cella con attenzione", 
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('explore_cell_initial', function() {
                                if (typeof memorySystem !== 'undefined') {
                                    memorySystem.triggerMemory('cella_iniziale');
                                }
                                // Sblocca scene positive della FASE 3
                                if (typeof consequenceSystem !== 'undefined') {
                                    consequenceSystem.unlockedScenes.add('spirito_alleato');
                                    consequenceSystem.unlockedScenes.add('veggente_friendly');
                                }
                            });
                        }
                    },
                    { 
                        text: "Concentrati sui frammenti di memoria", 
                        nextScene: "ricordaPassato",
                        onSelect: function() {
                            executeActionOnce('concentrate_memories_initial', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    playerHealth -= 5; // Sforzo mentale
                                    karmaSystem.addKarma(5);
                                    updateUI();
                                }
                            });
                        }
                    },
                    { 
                        text: "Grida per aiuto, disperato", 
                        nextScene: "gridaAiuto",
                        onSelect: function() {
                            executeActionOnce('cry_for_help_initial', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-5);
                                }
                            });
                        }
                    }
                ]
            },
            esploraCella: {
                title: "Esplorazione della Cella",
                text: "Scivoli lungo le pareti come un'ombra in cerca di risposte, sentendo la pietra fredda e scivolosa sotto le dita. Ogni runa incisa sembra pulsare con una vita propria, raccontando storie di un passato che non riesci a ricordare.\n\nIn un angolo, dietro un mucchio di detriti che sembrano i resti di un'antica battaglia, noti una fessura nel muro, quasi impercettibile. Ma è l'oggetto accanto che cattura la tua attenzione: un frammento di specchio, così piccolo da sembrare insignificante, eppure qualcosa in esso ti chiama.\n\nQuando lo raccogli, il frammento si riscalda tra le tue dita e per un momento vedi riflessa una donna dai capelli scuri e gli occhi verdi. Il suo volto ti è familiare, ma il nome sfugge alla tua memoria. L'aria qui è ancora più pesante, satura di memorie che non sono tue, eppure ti appartengono. Ogni respiro ti porta più vicino alla verità, anche se quella verità potrebbe distruggerti.",
                onEnter: function() {
                    // Inizializza il sistema di karma se non esiste
                    if (typeof karmaSystem === 'undefined') {
                        console.log('Sistema karma non trovato, inizializzazione...');
                    }
                },
                choices: [
                    { 
                        text: "Esamina il frammento di specchio con attenzione", 
                        nextScene: "frammentoSpecchio",
                        onSelect: function() {
                            executeActionOnce('examine_mirror_fragment', function() {
                                if (typeof memorySystem !== 'undefined') {
                                    memorySystem.triggerMemory('frammento_specchio');
                                }
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(10); // Scoperta importante
                                }
                                // Trigger flashback di Lyra
                                showMemoryNotification('frammento');
                            });
                        }
                    },
                    { 
                        text: "Tenta di allargare la fessura nel muro", 
                        nextScene: "tunnelSegreto",
                        onSelect: function() {
                            executeActionOnce('widen_crack_wall', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(5); // Azione determinata
                                }
                                playerHealth -= 3; // Sforzo fisico
                                updateUI();
                            });
                        }
                    },
                    { 
                        text: "Studia le rune sulle pareti", 
                        nextScene: "studiareRune",
                        onSelect: function() {
                            executeActionOnce('study_wall_runes', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(15); // Approccio intellettuale
                                }
                                playerHealth -= 2; // Concentrazione mentale
                                updateUI();
                            });
                        }
                    },
                    { 
                        text: "Cerca altri oggetti nella cella", 
                        nextScene: "cercaNellaCella",
                        onSelect: function() {
                            executeActionOnce('search_cell_objects', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(5); // Esplorazione completa
                                }
                            });
                        }
                    }
                ]
            },
            tunnelSegreto: {
                title: "Tunnel Segreto",
                text: "Con fatica, riesci ad allargare la fessura quel tanto che basta per passarci attraverso. Ti ritrovi in un tunnel buio e stretto. L'aria è ancora più viziata.",
                onEnter: () => {
                    if (!foundSecretTunnel) {
                        foundSecretTunnel = true;
                        saveGame(); // Salva dopo aver trovato il tunnel
                        showSimpleAchievement("Tunnel Segreto Scoperto");
                        showNotification("Progressi salvati!", "achievement", 3000);
                    }
                },
                choices: [
                    { text: "Procedi nel tunnel", nextScene: "cunicoloBuio" },
                    { text: "Torna alla cella", nextScene: "esploraCella" } // Aggiunta opzione di ritorno
                ]
            },
            cercaNellaCella: {
                title: "Cerca nella Cella",
                text: "Rovisti tra i detriti e la paglia. Tra la sporcizia, i tuoi occhi si posano su qualcosa che luccica debolmente. Una chiave arrugginita!",
                onEnter: () => {
                    if (!inventory.includes("Chiave Arrugginita")) {
                        inventory.push("Chiave Arrugginita");
                        hasKey = true;
                        updateUI();
                        showItemNotification("Chiave Arrugginita", true);
                    } else {
                        showNotification("Non trovi nulla di nuovo qui.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Tenta di aprire la porta con la chiave", nextScene: "tentativoPorta" },
                    { text: "Torna a esplorare la fessura", nextScene: "esploraCella" }
                ]
            },
            tentativoPorta: {
                title: "La Porta della Cella",
                text: "La vecchia porta di ferro è massiccia e arrugginita.",
                requiredItems: ["Chiave Arrugginita"],
                choices: [
                    { text: "Avanza nel corridoio", nextScene: "corridoioOscuro" }
                ],
                failedText: "La porta è chiusa a chiave. Ti serve qualcosa per aprirla."
            },
            corridoioOscuro: {
                title: "Corridoio Oscuro",
                text: "Il corridoio si estende davanti a te, illuminato solo da sporadiche fiaccole morenti. L'aria è ferma. Senti un debole ronzio provenire da una direzione.",
                choices: [
                    { text: "Segui il ronzio", nextScene: "salaGolem" },
                    { text: "Procedi cautamente in avanti", nextScene: "biforcazione" }
                ]
            },
            biforcazione: { // Nuova scena per spezzare il ciclo e dare più scelte
                title: "Bivio nel Corridoio",
                text: "Il corridoio si biforca. A sinistra, senti un leggero fruscio d'acqua e un sentore di umidità. A destra, il buio è più denso e profondo.",
                onEnter: () => {
                    // 35% di probabilità di scelta sbagliata
                    if (Math.random() < 0.35) {
                        const damage = Math.floor(Math.random() * 16) + 10; // Danno 10-25 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "percorso pericoloso");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Prendi il passaggio a sinistra", nextScene: "passaggioUmidito" },
                    { text: "Prendi il passaggio a destra", nextScene: "passaggioProfondo" },
                    { text: "Torna indietro", nextScene: "corridoioOscuro" }
                ]
            },
            passaggioUmidito: {
                title: "Pozza d'Acqua",
                text: "Il passaggio conduce a una piccola pozza d'acqua sotterranea. L'acqua è fresca e potabile. Trovi alcune vecchie monete sul bordo.",
                onEnter: () => {
                    executeActionOnce('visit_passaggio_umidito', function() {
                        // 50% di probabilità di malattia
                        if (Math.random() < 0.5) {
                            const damage = Math.floor(Math.random() * 8) + 3; // Danno 3-10 HP
                            playerHealth -= damage;
                            // Riduzione temporanea della salute massima
                            maxHealth = Math.max(80, maxHealth - 5);
                            showDamageNotification(damage, "acqua contaminata");
                            showNotification("Salute massima ridotta!", "damage", 3000);
                            updateUI();
                            if (playerHealth <= 0) {
                                loadScene("deathScreen");
                                return;
                            }
                        } else {
                            souls += 10;
                            playerHealth = Math.min(maxHealth, playerHealth + 10); // Piccolo recupero salute
                            updateUI();
                            showHealNotification(10);
                            showSoulsNotification(10);
                        }
                    });
                },
                choices: [
                    { text: "Torna al bivio", nextScene: "biforcazione" }
                ]
            },
            passaggioProfondo: {
                title: "Nido di Ratti",
                text: "Il passaggio buio porta a un piccolo nido di ratti giganti. Ti attaccano non appena ti avvicini!",
                onEnter: () => {
                    executeActionOnce('visit_passaggio_profondo', function() {
                        const damage = Math.floor(Math.random() * 10) + 5; // Danno tra 5 e 14
                        playerHealth -= damage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(damage, "ratti");
                        }
                    });
                },
                choices: [
                    { text: "Scappa e torna al bivio", nextScene: "biforcazione" },
                    { text: "Continua ad esplorare", nextScene: "nidoRattiProfondo" }
                ]
            },
            nidoRattiProfondo: { // Nuova scena di progressione
                title: "Dietro il Nido",
                text: "Con cautela, superi il nido. Dietro di esso, trovi una piccola nicchia con una vecchia Sacca di Cuoio.",
                onEnter: () => {
                    executeActionOnce('visit_nido_ratti', function() {
                        if (!inventory.includes("Sacca di Cuoio")) {
                            inventory.push("Sacca di Cuoio");
                            souls += 20; // Contiene 20 anime
                            updateUI();
                            showItemNotification("Sacca di Cuoio", true);
                            showSoulsNotification(20);
                        } else {
                            showNotification("Non c'è più nulla da trovare qui.", "info", 2000);
                        }
                    });
                },
                choices: [
                    { text: "Torna indietro al bivio", nextScene: "biforcazione" }
                ]
            },
            salaGolem: {
                title: "La Sala del Golem",
                text: "Il ronzio si fa più forte. Entri in una grande sala. Al centro, un imponente Golem di pietra, ricoperto di muschio, blocca il passaggio principale. I suoi occhi di giada si accendono al tuo arrivo.",
                onEnter: () => {
                    if (!foughtGolem) {
                        text.textContent += "\nIl Golem ti carica!";
                        const initialDamage = Math.floor(Math.random() * 10) + 5; // Danno tra 5 e 14
                        playerHealth -= initialDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(initialDamage, "Golem");
                        }
                    } else {
                        text.textContent = "Il Golem sconfitto giace inerte, il passaggio è libero.";
                    }
                },
                choices: [
                    { text: "Attacca il Golem", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Cerca un punto debole", nextScene: "cercaPuntoDebole", condition: () => !foughtGolem },
                    { text: "Tenta di aggirarlo", nextScene: "tentaAggiramento", condition: () => !foughtGolem },
                    { text: "Prosegui oltre il Golem", nextScene: "dopoGolem", condition: () => foughtGolem }
                ]
            },
            combattiGolem: {
                title: "Scontro con il Golem",
                text: "Il Golem carica con un ruggito roccioso. È un colosso di pietra, ogni suo pugno è come un macigno. Continui a combattere.",
                onEnter: () => {
                    if (!foughtGolem) {
                        executeActionOnce('fight_golem_round', function() {
                            // Aumento danni da 10-24 a 15-34
                            const damage = Math.floor(Math.random() * 20) + 15; // Danno tra 15 e 34
                            
                            // 30% di probabilità di attacco speciale (danno extra)
                            const specialAttack = Math.random() < 0.3;
                            let totalDamage = damage;
                            let message = `Hai subito ${damage} danni.`;
                            
                            if (specialAttack) {
                                const extraDamage = Math.floor(Math.random() * 10) + 5; // Danno extra 5-14
                                totalDamage += extraDamage;
                                message = `Il Golem sferra un attacco speciale! Hai subito ${damage} + ${extraDamage} = ${totalDamage} danni totali.`;
                            }
                            
                            playerHealth -= totalDamage;
                            updateUI();
                            if (playerHealth <= 0) {
                                showDeathScreen();
                            } else {
                                showDamageNotification(totalDamage, "Golem");
                            }
                        });
                    }
                },
                choices: [
                    { text: "Colpisci ancora", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Usa Mappa Rudimentale", onSelect: () => useItem("Mappa Rudimentale", "sconfiggiGolem", "Non hai la Mappa Rudimentale."), condition: () => !foughtGolem && inventory.includes("Mappa Rudimentale") },
                    { text: "Cerca di fuggire", nextScene: "corridoioOscuro", condition: () => !foughtGolem && playerHealth > 25 }
                ]
            },
            cercaPuntoDebole: {
                title: "Ricerca del Punto Debole",
                text: "Studi i movimenti del Golem, cercando una falla nella sua corazza di pietra. Noti una crepa nel suo braccio destro e un'anomalia nel suo petto, dove una runa brilla debolmente.",
                choices: [
                    { text: "Attacca il braccio", nextScene: "attaccaBraccioGolem", condition: () => !foughtGolem },
                    { text: "Tocca la runa sul petto", nextScene: "toccaRunaGolem", condition: () => !foughtGolem },
                    { text: "Torna a combattere", nextScene: "combattiGolem", condition: () => !foughtGolem }
                ]
            },
            attaccaBraccioGolem: {
                title: "Attacco al Braccio",
                text: "Sferri un colpo deciso al braccio crepato del Golem. Con un sonoro 'CRACK', il braccio si stacca parzialmente, rallentando le sue mosse. È il momento di finirlo!",
                onEnter: () => {
                    if (!foughtGolem) {
                        showNotification("Il Golem è stato indebolito!", "achievement", 3000);
                    }
                },
                choices: [
                    { text: "Sferra il colpo finale!", nextScene: "sconfiggiGolem" }
                ]
            },
            toccaRunaGolem: {
                title: "La Runa sul Petto",
                text: "Con audacia, allunghi la mano e tocchi la runa brillante sul petto del Golem. Una scarica di energia ti attraversa, ma il Golem barcolla e la sua aura si affievolisce. Sembra un punto vitale!",
                onEnter: () => {
                    if (!foughtGolem) {
                        showSimpleAchievement("Golem Indebolito");
                    }
                },
                choices: [
                    { text: "Sferra il colpo finale!", nextScene: "sconfiggiGolem" }
                ]
            },
            sconfiggiGolem: {
                title: "Vittoria sul Golem",
                text: "Il Golem, indebolito, crolla a terra con un boato che fa tremare la sala. La runa sul suo petto si spegne. Il passaggio è libero. Trovi anche un piccolo sacchetto di tela con alcune anime.",
                onEnter: () => {
                    if (!foughtGolem) {
                        souls += 50;
                        foughtGolem = true;
                        updateUI();
                        saveGame();
                        showSimpleAchievement("Golem Sconfitto");
                        showSoulsNotification(50);
                    }
                },
                choices: [
                    { text: "Prosegui oltre il Golem", nextScene: "dopoGolem" }
                ]
            },
            tentaAggiramento: {
                title: "Tenta di Aggirare",
                text: "Cerchi di muoverti furtivamente lungo le pareti della sala, sperando di non attirare l'attenzione del Golem. Ma fa un rumore, e il Golem si gira!",
                onEnter: () => {
                    const damage = Math.floor(Math.random() * 15) + 5; // Danno minore
                    playerHealth -= damage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(damage, "Golem");
                    }
                },
                choices: [
                    { text: "Attacca il Golem", nextScene: "combattiGolem", condition: () => !foughtGolem },
                    { text: "Cerca un punto debole", nextScene: "cercaPuntoDebole", condition: () => !foughtGolem },
                    { text: "Prova a fuggire", nextScene: "corridoioOscuro", condition: () => !foughtGolem }
                ]
            },
            dopoGolem: {
                title: "Passaggio Libero",
                text: "Oltre la sala del Golem, il corridoio prosegue, rivelando un'uscita verso l'esterno. La luce fioca del crepuscolo filtra attraverso le rocce. Sei libero dalla prigione!",
                onEnter: () => {
                    updateSacredFire("fuocoSacroPrigione");
                },
                choices: [
                    { text: "Esci nella natura selvaggia", nextScene: "terreSelvagge" }
                ]
            },
            terreSelvagge: {
                title: "Terre Selvagge",
                text: "Il vento ti accarezza il viso mentre esci all'aperto. Ti trovi in un vasto altopiano roccioso, costellato di arbusti secchi e imponenti formazioni rocciose. All'orizzonte, vedi le luci di quella che sembra una piccola città.",
                onEnter: () => {
                    executeActionOnce('visit_terre_selvagge', function() {
                        // 40% di probabilità di incontro con predatori
                        if (Math.random() < 0.4) {
                            const damage = Math.floor(Math.random() * 13) + 8; // Danno 8-20 HP
                            playerHealth -= damage;
                            showDamageNotification(damage, "predatori");
                            updateUI();
                            if (playerHealth <= 0) {
                                loadScene("deathScreen");
                                return;
                            }
                        }
                    });
                    
                    if (lastSacredFire !== "fuocoSacroTerre") {
                        updateSacredFire("fuocoSacroTerre");
                    }
                },
                choices: [
                    { text: "Dirigiti verso la città", nextScene: "ingressoCitta" },
                    { text: "Esplora le rovine vicine", nextScene: "rovineTempio" },
                    { text: "Cerca risorse nelle terre selvagge", nextScene: "cercaRisorseSelvaggie" } // Nuova opzione
                ]
            },
            cercaRisorseSelvaggie: { // Nuova scena
                title: "Cerca Risorse",
                text: "Rovisti tra gli arbusti e le rocce. Trovi alcune bacche commestibili e un piccolo gruppo di anime.",
                onEnter: () => {
                    executeActionOnce('search_wild_resources', function() {
                        // 25% di probabilità di piante velenose
                        if (Math.random() < 0.25) {
                            const damage = Math.floor(Math.random() * 8) + 5; // Danno 5-12 HP
                            playerHealth -= damage;
                            showDamageNotification(damage, "piante velenose");
                            updateUI();
                            if (playerHealth <= 0) {
                                loadScene("deathScreen");
                                return;
                            }
                        }
                        
                        souls += 15;
                        playerHealth = Math.min(maxHealth, playerHealth + 5); // Piccolo recupero salute
                        
                        // Possibilità di trovare ingredienti di crafting
                        const randomChance = Math.random();
                        if (randomChance < 0.3 && !inventory.includes("Erba Curativa")) {
                            inventory.push("Erba Curativa");
                            showItemNotification("Erba Curativa", true);
                            showHealNotification(5);
                            showSoulsNotification(15);
                        } else if (randomChance < 0.5 && !inventory.includes("Erba di Forza")) {
                            inventory.push("Erba di Forza");
                            showItemNotification("Erba di Forza", true);
                            showHealNotification(5);
                            showSoulsNotification(15);
                        } else if (randomChance < 0.7 && !inventory.includes("Acqua Pura")) {
                            inventory.push("Acqua Pura");
                            showItemNotification("Acqua Pura", true);
                            showHealNotification(5);
                            showSoulsNotification(15);
                        } else {
                            showSoulsNotification(15);
                            showHealNotification(5);
                        }
                        
                        updateUI();
                    });
                },
                choices: [
                    { text: "Continua a esplorare le terre selvagge", nextScene: "terreSelvagge" },
                    { text: "Dirigiti verso la città", nextScene: "ingressoCitta" }
                ]
            },
            ingressoCitta: {
                title: "Ingresso della Città",
                text: "Ti avvicini a quella che sembra una città di frontiera, circondata da un muro di legno. Dalle strade, senti le voci della gente e il rumore di attrezzi. Sembra un luogo sicuro.",
                onEnter: () => {
                    executeActionOnce('visit_ingresso_citta', function() {
                        // 20% di probabilità di guardie sospettose
                        if (Math.random() < 0.2) {
                            const damage = Math.floor(Math.random() * 6) + 3; // Danno 3-8 HP
                            playerHealth -= damage;
                            showDamageNotification(damage, "guardie sospettose");
                            updateUI();
                            if (playerHealth <= 0) {
                                loadScene("deathScreen");
                                return;
                            }
                        }
                    });
                },
                choices: [
                    { text: "Entra in città", nextScene: "distrettoMercantile" },
                    { text: "Cerca un Fuoco Sacro", nextScene: "cercaFuocoSacro" },
                    { text: "Torna alle Terre Selvagge", nextScene: "terreSelvagge" }
                ]
            },
            distrettoMercantile: {
                title: "Distretto Mercantile",
                text: "Le strade sono affollate di mercanti che espongono le loro merci. L'odore di spezie e cuoio riempie l'aria. Vedi bancarelle di armi, armature, pozioni e curiosità.",
                choices: [
                    { text: "Visita il mercante di pozioni", nextScene: "mercantePozioni" },
                    { text: "Cerca informazioni", nextScene: "informazioniMercantili" },
                    { text: "Torna all'ingresso della città", nextScene: "ingressoCitta" }
                ]
            },
            informazioniMercantili: {
                title: "Informazioni dal Mercato",
                text: "Parlare con i mercanti ti rivela informazioni preziose. Un vecchio mercante ti racconta di un alchimista che vive nelle Terre Selvagge, mentre un altro menziona un antico tempio con tesori nascosti. 'Se cerchi conoscenza antica', dice uno, 'dovresti visitare la biblioteca della città.'",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    showSoulsNotification(20);
                },
                choices: [
                    { text: "Cerca l'alchimista nelle Terre Selvagge", nextScene: "laboratorioAlchimista" },
                    { text: "Visita la biblioteca della città", nextScene: "bibliotecaAntica" },
                    { text: "Torna al distretto mercantile", nextScene: "distrettoMercantile" }
                ]
            },
            mercantePozioni: {
                title: "Mercante di Pozioni",
                text: "Un anziano con un naso aquilino e occhi acuti ti accoglie dietro un tavolo pieno di fiale luccicanti. 'Salute, straniero! Cosa ti serve?'",
                choices: [
                    { text: "Compra Pozione di Salute (35 anime)", onSelect: () => buyItem("Pozione di Salute", 35, "mercantePozioni") },
                    { text: "Lascia il negozio", nextScene: "distrettoMercantile" }
                ]
            },
            ricordaPassato: {
                title: "Tentativo di Ricordo Fallito",
                text: "Chiudi gli occhi e ti concentri. Immagini sfocate di una foresta, un simbolo su una lapide, un volto sconosciuto. Nulla di chiaro, solo frustrazione.",
                onEnter: () => {
                    if (!hasPartialMemory) {
                        hasPartialMemory = true;
                        souls += 5; // Piccola ricompensa per il tentativo
                        updateUI();
                        showSimpleAchievement("Frammento di Memoria");
                        showSoulsNotification(5);
                    }
                },
                choices: [
                    { text: "Continua a concentrarti", nextScene: "ricordoParziale" },
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            ricordoParziale: {
                title: "Frammenti di Memoria",
                text: "Concentrandoti ulteriormente, alcuni frammenti emergono dalla nebbia della tua mente. Vedi una foresta di alberi giganti, un antico tempio in rovina, e una figura vestita di nero che ti guarda. Il ricordo è doloroso ma illuminante.",
                onEnter: () => {
                    if (hasPartialMemory && !inventory.includes("Frammento di Memoria")) {
                        inventory.push("Frammento di Memoria");
                        souls += 15;
                        updateUI();
                        showItemNotification("Frammento di Memoria", true);
                        showSoulsNotification(15);
                    }
                },
                choices: [
                    { text: "Segui il ricordo del tempio", nextScene: "sogniRicordi" },
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            gridaAiuto: {
                title: "Grida Inascoltate",
                text: "Le tue grida echeggiano nella cella, ma nessuno risponde. Solo il silenzio e il gocciolio dell'acqua. La solitudine ti avvolge.",
                onEnter: () => {
                    if (!hasAlertedGuards) {
                        hasAlertedGuards = true;
                        const damage = Math.floor(Math.random() * 5) + 1; // Danno minore per il rumore
                        playerHealth -= damage;
                        updateUI();
                        showDamageNotification(damage, "rumore");
                    }
                },
                choices: [
                    { text: "Aspetta una risposta", nextScene: "guardieArrivano" },
                    { text: "Riprova a esplorare", nextScene: "esploraCella" }
                ]
            },
            sogniRicordi: {
                title: "Sogni del Passato",
                text: "Il ricordo ti porta in un sogno vivido. Sei nel tempio che hai visto, ma è intatto e splendente. Una figura vestita di nero ti guarda con occhi che brillano di energia arcana. 'La maledizione ti lega a questo luogo', dice la voce. 'Solo gli antichi artefatti possono spezzarla.'",
                onEnter: () => {
                    if (!inventory.includes("Conoscenza del Passato")) {
                        inventory.push("Conoscenza del Passato");
                        souls += 25;
                        updateUI();
                        showItemNotification("Conoscenza del Passato", true);
                        showSoulsNotification(25);
                    }
                },
                choices: [
                    { text: "Torna alla realtà", nextScene: "cellaIniziale" }
                ]
            },
            cunicoloBuio: {
                title: "Nel Cunicolo",
                text: "Strisci nel buio per quello che sembra un'eternità. Il tunnel si apre in una piccola grotta. Sul fondo, vedi una luce flebile e un oggetto che luccica.",
                onEnter: () => {
                    // 30% di probabilità di danno casuale
                    if (Math.random() < 0.3) {
                        const damage = Math.floor(Math.random() * 5) + 1; // Danno 1-5 HP
                        playerHealth -= damage;
                        
                        // 20% di probabilità di perdere oggetti casuali
                        if (Math.random() < 0.2 && inventory.length > 0) {
                            const lostItem = inventory[Math.floor(Math.random() * inventory.length)];
                            inventory = inventory.filter(item => item !== lostItem);
                            showDamageNotification(damage, "cunicolo pericoloso");
                            showNotification(`Oggetto perso: ${lostItem}`, "damage", 3000);
                        } else {
                            showDamageNotification(damage, "cunicolo pericoloso");
                        }
                        
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Raggiungi la luce", nextScene: "grottaLuminosa" },
                    { text: "Torna indietro", nextScene: "tunnelSegreto" }
                ]
            },
            grottaLuminosa: {
                title: "Grotta della Luce",
                text: "La luce proviene da un cristallo incastonato nella roccia. Accanto ad esso, trovi una Mappa Rudimentale, disegnata su una pergamena invecchiata.",
                onEnter: () => {
                    // 20% di probabilità di incontro con creature
                    if (Math.random() < 0.2) {
                        const damage = Math.floor(Math.random() * 11) + 5; // Danno 5-15 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "creature oscure");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                    
                    if (!inventory.includes("Mappa Rudimentale")) {
                        inventory.push("Mappa Rudimentale");
                        hasMap = true;
                        updateUI();
                        showItemNotification("Mappa Rudimentale", true);
                    } else {
                        showNotification("Hai già preso la mappa. Il cristallo brilla.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Cerca un'altra uscita", nextScene: "uscitaGrotta" },
                    { text: "Torna nel cunicolo", nextScene: "cunicoloBuio" } // Opzione di ritorno
                ]
            },
            uscitaGrotta: {
                title: "Uscita della Grotta",
                text: "Seguendo un'altra galleria, emergi in un'area più ampia, che sembra una vecchia sezione delle prigioni, ma in disuso. Vedi una porta in legno che sembra portare all'esterno.",
                onEnter: () => {
                    // 15% di probabilità di trappola
                    if (Math.random() < 0.15) {
                        const damage = Math.floor(Math.random() * 6) + 3; // Danno 3-8 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "trappola");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Apri la porta", nextScene: "uscitaPrigione" },
                    { text: "Torna alla grotta", nextScene: "grottaLuminosa" } // Opzione di ritorno
                ]
            },
            uscitaPrigione: {
                title: "Uscita dalle Prigioni",
                text: "Apri la porta con cautela. Ti ritrovi in un cortile diroccato, con alte mura. Un sentiero sterrato si snoda verso l'orizzonte. Finalmente libero!",
                choices: [
                    { text: "Prendi il sentiero", nextScene: "terreSelvagge" }
                ]
            },
            rovineTempio: {
                title: "Rovine del Tempio",
                text: "Un antico tempio in rovina sorge maestoso contro il cielo. Colonne spezzate e muri coperti di edera raccontano storie di un'epoca passata. Senti una strana energia emanare dalle rovine.",
                onEnter: () => {
                    // 30% di probabilità di crollo
                    if (Math.random() < 0.3) {
                        const damage = Math.floor(Math.random() * 16) + 15; // Danno 15-30 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "crollo");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Entra nel tempio", nextScene: "internoTempio" },
                    { text: "Cerca manufatti tra le macerie", nextScene: "cercaManufatti" },
                    { text: "Torna alle Terre Selvagge", nextScene: "terreSelvagge" }
                ]
            },
            internoTempio: {
                title: "Interno del Tempio",
                text: "L'interno è silenzioso, rotto solo dal fruscio del vento tra le pietre. Al centro, un altare scheggiato reca incisioni indecifrabili. Una luce fioca illumina un'apertura nel pavimento.",
                onEnter: () => {
                    // 40% di probabilità di trappole antiche
                    if (Math.random() < 0.4) {
                        const damage = Math.floor(Math.random() * 11) + 10; // Danno 10-20 HP
                        playerHealth -= damage;
                        showDamageNotification(damage, "trappola antica");
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Scendi nell'apertura", nextScene: "criptaAntica" },
                    { text: "Esamina l'altare", nextScene: "esaminaAltare" },
                    { text: "Esci dal tempio", nextScene: "rovineTempio" }
                ]
            },
            criptaAntica: {
                title: "Cripta Antica",
                text: "Un'atmosfera gelida ti accoglie nella cripta. Le pareti sono decorate con affreschi sbiaditi di figure spettrali. Al centro, un sarcofago di pietra sembra emanare un'aura maligna.",
                onEnter: () => {
                    // 60% di probabilità di maledizione
                    if (Math.random() < 0.6) {
                        const damage = Math.floor(Math.random() * 11) + 5; // Danno 5-15 HP
                        playerHealth -= damage;
                        // Effetti negativi permanenti
                        maxHealth = Math.max(70, maxHealth - 10);
                        showDamageNotification(damage, "maledizione antica");
                        showNotification("Salute massima ridotta!", "damage", 3000);
                        updateUI();
                        if (playerHealth <= 0) {
                            loadScene("deathScreen");
                            return;
                        }
                    }
                },
                choices: [
                    { text: "Apri il sarcofago", nextScene: "apriSarcofago" },
                    { text: "Cerca tesori nascosti", nextScene: "cercaTesoriCripta" },
                    { text: "Prosegui più in profondità", nextScene: "criptaProfonda", condition: () => !exploredDeepCrypt },
                    { text: "Torna all'ingresso del tempio", nextScene: "internoTempio" }
                ]
            },
            criptaProfonda: { // Nuova scena di progressione
                title: "Passaggio Segreto della Cripta",
                text: "Trovi un passaggio nascosto dietro un falso muro. Ti porta a una stanza più profonda della cripta, dove l'aria è densa di magia. C'è un pilastro con una runa brillante e un'antica pergamena.",
                onEnter: () => {
                    if (!exploredDeepCrypt) {
                        exploredDeepCrypt = true;
                        if (!inventory.includes("Pergamena di Rune")) {
                            inventory.push("Pergamena di Rune");
                            showItemNotification("Pergamena di Rune", true);
                        }
                        souls += 40;
                        lastSacredFire = "fuocoSacroTempio";
                        updateUI();
                        saveGame();
                        showSoulsNotification(40);
                        showSimpleAchievement("Cripta Profonda Esplorata");
                        showNotification("Salvato al Fuoco Sacro del Tempio!", "achievement", 3000);
                    } else {
                        showNotification("Sei già stato qui. La runa brilla fiocamente.", "info", 2000);
                    }
                },
                choices: [
                    { text: "Tocca la runa", onSelect: () => touchRune("criptaProfonda") },
                    { text: "Torna alla cripta principale", nextScene: "criptaAntica" }
                ]
            },
            apriSarcofago: {
                title: "Il Sarcofago",
                text: "Sollevi il pesante coperchio del sarcofago. All'interno, un'antica mummia giace, con un amuleto luccicante stretto nella mano scheletrica. Mentre lo afferri, la mummia si anima!",
                onEnter: () => {
                    if (!hasDefeatedMummy) {
                        const mummyDamage = Math.floor(Math.random() * 20) + 10; // Danno tra 10 e 29
                        playerHealth -= mummyDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            if (!inventory.includes("Amuleto Antico")) {
                                inventory.push("Amuleto Antico");
                                updateUI();
                                showDamageNotification(mummyDamage, "mummia");
                                showItemNotification("Amuleto Antico", true);
                            } else {
                                showDamageNotification(mummyDamage, "mummia");
                            }
                        }
                    }
                },
                choices: [
                    { text: "Combatti la mummia", nextScene: "combattiMummia", condition: () => !hasDefeatedMummy },
                    { text: "Fuggi dalla cripta", nextScene: "criptaAntica", condition: () => !hasDefeatedMummy },
                    { text: "Esamina il sarcofago vuoto", nextScene: "criptaAntica", condition: () => hasDefeatedMummy }
                ]
            },
            combattiMummia: {
                title: "Combattimento con la Mummia",
                text: "La mummia si alza dal sarcofago con movimenti innaturali. I suoi occhi brillano di energia maligna. Devi combattere per sopravvivere!",
                onEnter: () => {
                    if (!hasDefeatedMummy) {
                        // Aumento danni da 10-24 a 12-28
                        const mummyDamage = Math.floor(Math.random() * 17) + 12; // Danno tra 12 e 28
                        
                        // 25% di probabilità di maledizione (riduzione salute massima)
                        const curse = Math.random() < 0.25;
                        let message = `La mummia ti attacca! Hai subito ${mummyDamage} danni.`;
                        
                        if (curse) {
                            maxHealth = Math.max(50, maxHealth - 5); // Riduzione salute massima di 5 punti
                            message = `La mummia ti attacca con una maledizione! Hai subito ${mummyDamage} danni e la tua salute massima è stata ridotta di 5 punti.`;
                        }
                        
                        playerHealth -= mummyDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(mummyDamage, "mummia");
                            if (curse) {
                                showNotification("Salute massima ridotta!", "damage", 3000);
                            }
                        }
                    }
                },
                choices: [
                    { text: "Attacca con la spada", nextScene: "combattiMummia", condition: () => !hasDefeatedMummy && inventory.includes("Spada Arrugginita") },
                    { text: "Usa l'Amuleto Antico", onSelect: () => useAmulet("combattiMummia"), condition: () => !hasDefeatedMummy && inventory.includes("Amuleto Antico") },
                    { text: "Tenta di fuggire", nextScene: "fugaMummia", condition: () => !hasDefeatedMummy && playerHealth > 30 },
                    { text: "Finisci la mummia", nextScene: "sconfiggiMummia", condition: () => !hasDefeatedMummy && playerHealth > 20 }
                ]
            },
            cercaTesoriCripta: {
                title: "Tesori Nascosti",
                text: "Rovistando negli angoli bui della cripta, trovi un piccolo forziere di legno. Contiene 30 anime e una pergamena con rune misteriose.",
                onEnter: () => {
                    if (!inventory.includes("Pergamena di Rune")) { // Assicurati di non aggiungerla due volte se trovata altrove
                        inventory.push("Pergamena di Rune");
                        souls += 30;
                        updateUI();
                        showSoulsNotification(30);
                        showItemNotification("Pergamena di Rune", true);
                    } else {
                        souls += 30; // Solo anime se hai già la pergamena
                        updateUI();
                        showSoulsNotification(30);
                    }
                },
                choices: [
                    { text: "Torna all'apertura", nextScene: "criptaAntica" }
                ]
            },
            fugaMummia: {
                title: "Fuga dalla Mummia",
                text: "Decidi di fuggire dalla mummia. Corri attraverso la cripta mentre la creatura ti insegue con movimenti innaturali. La fuga è rischiosa!",
                onEnter: () => {
                    // Fuga disponibile solo con salute > 20 e 50% di probabilità di fallimento
                    if (playerHealth <= 20) {
                        showHealthWarningNotification();
                        loadScene("criptaAntica");
                        return;
                    }
                    
                    const escapeSuccess = Math.random();
                    if (escapeSuccess < 0.5) {
                        // Fuga fallita
                        const failedDamage = Math.floor(Math.random() * 15) + 10;
                        playerHealth -= failedDamage;
                        showDamageNotification(failedDamage, "fuga fallita");
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            loadScene("criptaAntica");
                        }
                    } else {
                        // Fuga riuscita
                        const escapeDamage = Math.floor(Math.random() * 8) + 3;
                        playerHealth -= escapeDamage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(escapeDamage, "fuga");
                        }
                    }
                },
                choices: [
                    { text: "Torna alla cripta", nextScene: "criptaAntica" },
                    { text: "Esci dal tempio", nextScene: "internoTempio" }
                ]
            },
            sconfiggiMummia: {
                title: "Vittoria sulla Mummia",
                text: "Con un ultimo sforzo, riesci a sconfiggere la mummia! La creatura crolla a terra, tornando polvere. Il sarcofago è ora sicuro da esplorare.",
                onEnter: () => {
                    hasDefeatedMummy = true;
                    souls += 40;
                    updateUI();
                    saveGame();
                    showSoulsNotification(40);
                    showSimpleAchievement("Mummia Sconfitta");
                },
                choices: [
                    { text: "Esplora il sarcofago", nextScene: "criptaAntica" },
                    { text: "Torna alla cripta", nextScene: "criptaAntica" }
                ]
            },
            esaminaAltare: {
                title: "Esamina Altare",
                text: "Le incisioni sull'altare sono complesse e aliene. Senti un debole richiamo, come un sussurro nella tua mente. Potrebbe essere legato alla maledizione.",
                choices: [
                    { text: "Medita sull'altare", onSelect: () => meditateAltare("internoTempio") },
                    { text: "Torna indietro", nextScene: "internoTempio" }
                ]
            },
            cercaManufatti: {
                title: "Ricerca di Manufatti",
                text: "Cerchi tra le rovine all'esterno. Tra le macerie, trovi 10 anime. Una vecchia spada arrugginita giace rotta a terra, ma noti che potrebbe essere riparata.",
                onEnter: () => {
                    souls += 10;
                    if (!inventory.includes("Spada Arrugginita")) {
                        inventory.push("Spada Arrugginita");
                        updateUI();
                        showItemNotification("Spada Arrugginita", true);
                        showSoulsNotification(10);
                    } else {
                        showSoulsNotification(10);
                    }
                    
                    // Possibilità di trovare ingredienti di crafting
                    const randomChance = Math.random();
                    if (randomChance < 0.4 && !inventory.includes("Cristallo di Potenza")) {
                        inventory.push("Cristallo di Potenza");
                        showItemNotification("Cristallo di Potenza", true);
                    } else if (randomChance < 0.6 && !inventory.includes("Cristallo di Anima")) {
                        inventory.push("Cristallo di Anima");
                        showItemNotification("Cristallo di Anima", true);
                    }
                    
                    updateUI();
                },
                choices: [
                    { text: "Esamina la spada più da vicino", nextScene: "manufattiTrovati" },
                    { text: "Torna alle Terre Selvagge", nextScene: "rovineTempio" }
                ]
            },
            manufattiTrovati: {
                title: "Manufatti Trovati",
                text: "Esamini la spada arrugginita più da vicino. Nonostante l'aspetto trasandato, riconosci i segni di un'antica forgiatura. Potrebbe essere riparata da un fabbro esperto. Inoltre, trovi un passaggio nascosto dietro una colonna crollata.",
                onEnter: () => {
                    if (!inventory.includes("Spada Arrugginita")) {
                        showNotification("Non hai la spada da esaminare.", "damage", 3000);
                        return;
                    }
                    souls += 15;
                    updateUI();
                    showSoulsNotification(15);
                    showSimpleAchievement("Passaggio Segreto");
                },
                choices: [
                    { text: "Esplora il passaggio segreto", nextScene: "passaggioSegreto" },
                    { text: "Torna alle rovine", nextScene: "rovineTempio" }
                ]
            },
            cercaFuocoSacro: {
                title: "Cerca Fuoco Sacro",
                text: "Mentre cerchi un luogo per riposare, trovi un antico Fuoco Sacro, le cui fiamme danzano pigramente. Tuttavia, noti che le fiamme sembrano più deboli del solito e richiedono un'offerta per essere attivate.",
                onEnter: () => {
                    // Il fuoco sacro della città è stato rimosso per aumentare la sfida
                    showNotification("Questo Fuoco Sacro è stato spento. Devi trovare un altro punto di riposo.", "info", 3000);
                },
                choices: [
                    { text: "Continua a esplorare", nextScene: "ingressoCitta" },
                    { text: "Cerca un altro rifugio", nextScene: "distrettoMercantile" }
                ]
            },
            // Sistema avanzato per i finali multipli
            santuarioFinale: {
                title: "Santuario della Maledizione",
                text: "Giungi in un santuario nascosto, dove l'aria vibra di energia arcana. Al centro, un'antica maledizione si manifesta come una nebbia oscura e pulsante. La tua scelta qui determinerà il destino della tua anima.",
                onEnter: () => {
                    // Sistema avanzato di controllo requisiti
                    const requiredArtifacts = ["Amuleto Antico", "Pergamena di Rune", "Gemma Preziosa", "Corona dell'Anima"];
                    playerChoices.hasCollectedAllArtifacts = requiredArtifacts.every(item => inventory.includes(item));
                    
                    // Tracking scelte per finali
                    playerChoices.hasVisitedSanctuary = true;
                    
                    souls += 50;
                    updateUI();
                    showSoulsNotification(50);
                    showSimpleAchievement("Santuario della Maledizione");
                    
                    // Feedback per scelte mancanti
                    if (!playerChoices.hasCollectedAllArtifacts) {
                        const missingItems = requiredArtifacts.filter(item => !inventory.includes(item));
                        showNotification(`⚠️ Ti mancano ${missingItems.length} artefatti per il finale buono: ${missingItems.join(', ')}`, 'info', 4000);
                    }
                },
                choices: [
                    { text: "Spezza la maledizione", nextScene: "finaleBuono", condition: () => playerChoices.hasCollectedAllArtifacts },
                    { text: "Accetta la maledizione per potere", nextScene: "sceltaOscura" },
                    { text: "Fuggi senza spezzare la maledizione", nextScene: "sceltaNeutrale" },
                    { text: "Torna indietro", nextScene: "terreSelvagge" }
                ]
            },
            passaggioSegreto: {
                title: "Passaggio Segreto",
                text: "Il passaggio nascosto ti porta in una stanza segreta delle rovine. L'aria è densa di polvere antica. Su un altare di pietra, trovi un antico amuleto che brilla di energia arcana.",
                onEnter: () => {
                    if (!inventory.includes("Amuleto delle Rovine")) {
                        inventory.push("Amuleto delle Rovine");
                        souls += 30;
                        updateUI();
                        showItemNotification("Amuleto delle Rovine", true);
                        showSoulsNotification(30);
                    }
                },
                choices: [
                    { text: "Torna alle rovine", nextScene: "rovineTempio" },
                    { text: "Esplora ulteriormente", nextScene: "cameraTesori" }
                ]
            },
            finaleBuono: {
                title: "La Redenzione Completa - Finale Buono",
                text: "Un silenzio sacro avvolge il santuario mentre posizioni gli antichi artefatti nei loro luoghi sacri. L'Amuleto Antico brilla con luce purificatrice, la Pergamena di Rune si illumina con rune dorate, la Gemma Preziosa pulsa di energia vitale, e la Corona dell'Anima emana un'aura di saggezza millenaria.\n\nUn coro di voci antiche risuona dalle pareti del santuario mentre la maledizione si dissolve in una cascata di luce cristallina. Ogni frammento della tua memoria perduta ritorna, non come un'inondazione caotica, ma come un fiume di consapevolezza che ti riempie di pace profonda.\n\nLa nebbia oscura si trasforma in una pioggia di stelle dorate che danzano nell'aria. Il santuario stesso sembra respirare, liberato dal peso della maledizione. La tua anima, ora completamente integra, risplende di una luce interiore che non si spegnerà mai più.\n\nHai non solo spezzato la maledizione, ma hai anche guarito le ferite che aveva inflitto al mondo. Il tuo viaggio è compiuto con onore, saggezza e un amore profondo per la vita che hai riconquistato.",
                onEnter: () => {
                    playerChoices.hasHelpedAlchemist = true;
                    playerChoices.hasAchievedGoodEnding = true;
                    achievements.curseBreaker = true;
                    achievements.goodEnding = true;
                    showAchievementNotification("Redenzione Completa");
                    showVictoryScreen("BUONO");
                },
                choices: []
            },
            finaleOscuro: {
                title: "L'Ascensione delle Tenebre - Finale Oscuro",
                text: "La maledizione ti parla con una voce che sembra provenire dalle profondità del tempo stesso. 'Accettami,' sussurra, 'e diventerai più di quello che sei mai stato.' Il suo potere oscuro fluisce attraverso di te come un fiume di ombra liquida, trasformando ogni cellula del tuo essere.\n\nLa nebbia non ti avvolge più - tu DIVENTI la nebbia. La tua memoria ritorna, ma ora è filtrata attraverso la lente della maledizione, rivelando verità che gli altri non possono vedere. Il dolore del mondo, la futilità della speranza, la bellezza del caos - tutto ti è chiaro.\n\nIl santuario trema mentre il tuo nuovo potere si manifesta. Le pareti si ricoprono di rune oscure che pulsano al ritmo del tuo cuore trasformato. La maledizione non ti controlla più - tu la controlli, la modelli, la espandi.\n\nHai ottenuto un potere immenso, accesso a conoscenze proibite che risalgono all'alba del tempo. La tua anima è ora una fusione di luce e ombra, umano e divino, mortale e immortale. Sei diventato qualcosa di nuovo, qualcosa di terribilmente bello.",
                onEnter: () => {
                    playerChoices.hasAcceptedCurse = true;
                    playerChoices.hasUsedDarkMagic = true;
                    playerChoices.hasAchievedDarkEnding = true;
                    achievements.darkEnding = true;
                    showAchievementNotification("Ascensione delle Tenebre");
                    showVictoryScreen("OSCURO");
                },
                choices: []
            },
            sceltaOscura: {
                title: "La Scelta Oscura",
                text: "La maledizione ti parla direttamente nella mente, la sua voce un sussurro che risuona nelle profondità della tua anima: 'Vedi la tua essenza, viaggiatore. Sei più di quello che credi di essere. Accettami, e ti rivelerò i segreti che gli dei stessi hanno dimenticato. Diventerai parte di me, e io parte di te - una fusione perfetta di potere e conoscenza. La tua anima sarà trasformata, ma avrai accesso a verità che risalgono all'alba del tempo, a poteri arcani che pochi hanno osato sognare.'\n\nIl suo richiamo è come una melodia ipnotica che risuona in ogni fibra del tuo essere, promettendo non solo potere, ma comprensione assoluta.",
                onEnter: () => {
                    souls += 100;
                    updateUI();
                    showSoulsNotification(100);
                    showNotification("La maledizione ti offre potere in cambio della tua anima!", 'damage', 3000);
                    
                    // Tracking per finale oscuro
                    playerChoices.hasEncounteredDarkChoice = true;
                },
                choices: [
                    { text: "Accetta il potere della maledizione", nextScene: "finaleOscuro" },
                    { text: "Rifiuta e torna indietro", nextScene: "santuarioFinale" }
                ]
            },
            sceltaNeutrale: {
                title: "La Scelta di Fuggire",
                text: "Guardando la maledizione pulsante nel santuario, una realizzazione profonda ti travolge. Non è paura quella che senti, ma una saggezza antica che parla attraverso i secoli. La sfida che ti si presenta non è solo fisica o magica - è filosofica.\n\nA volte la vera forza non sta nell'affrontare ogni battaglia con spada in pugno, ma nel sapere quale battaglia vale la pena combattere e quando è il momento di ritirarsi per prepararsi meglio. La maledizione continuerà a esistere, ma forse non è il tuo destino combatterla ora.\n\nForse la vera saggezza sta nel riconoscere i propri limiti, nel comprendere che ogni scelta ha il suo momento, e che la pazienza può essere la più grande delle virtù.",
                onEnter: () => {
                    souls += 25;
                    updateUI();
                    showSoulsNotification(25);
                    showNotification("Decidi che la sopravvivenza è più importante della gloria.", 'info', 3000);
                    
                    // Tracking per finale neutrale
                    playerChoices.hasChosenWisdom = true;
                },
                choices: [
                    { text: "Conferma la fuga", nextScene: "finaleNeutrale" },
                    { text: "Ripensa e torna indietro", nextScene: "santuarioFinale" }
                ]
            },
            finaleNeutrale: {
                title: "La Saggezza della Sopravvivenza - Finale Neutrale",
                text: "Guardando la maledizione pulsante nel santuario, una realizzazione profonda ti travolge. Non è codardia quella che senti, ma saggezza antica. A volte la vera forza non sta nell'affrontare ogni battaglia, ma nel sapere quale battaglia vale la pena combattere.\n\nLa maledizione continua a pulsare, ma ora la guardi con occhi diversi. Non è più una minaccia da sconfiggere o un potere da conquistare, ma semplicemente una parte del mondo, come la pioggia o il vento. La tua memoria ritorna parzialmente, ma è sufficiente per comprendere che la perfezione non esiste.\n\nMentre ti allontani dal santuario, senti la nebbia che si dissolve alle tue spalle, ma non come una sconfitta. È come se il mondo stesso ti stesse dando il permesso di scegliere il tuo destino. La maledizione rimane, ma ora la vedi per quello che è: una sfida da affrontare quando sarai pronto, non una prigione da cui fuggire.\n\nHai scelto la via della saggezza, della pazienza, della comprensione. Il tuo viaggio non è finito - è solo iniziato in modo diverso. A volte la vera vittoria sta nel sapere quando è il momento di ritirarsi e prepararsi per la prossima battaglia.",
                onEnter: () => {
                    playerChoices.hasEscapedWithoutCure = true;
                    playerChoices.hasAchievedNeutralEnding = true;
                    achievements.neutralEnding = true;
                    showAchievementNotification("Saggezza della Sopravvivenza");
                    showVictoryScreen("NEUTRALE");
                },
                choices: []
            },
            finaleVittoria: {
                title: "La Maledizione Spezzata!",
                text: "Con gli antichi artefatti al loro posto, un'onda di luce purificatrice esplode dal santuario, disperdendo la nebbia. La maledizione è spezzata. La tua memoria ritorna, e con essa, un senso di pace. Il viaggio è compiuto.",
                onEnter: () => {
                    showVictoryScreen();
                },
                choices: []
            },
            // NUOVE SCENE FASE 2 - ESPANSIONE CONTENUTI
            ricordoParziale: {
                title: "Ricordi Frammentari",
                text: "Un'ondata di ricordi frammentari ti travolge. Vedi immagini confuse: una torre antica, un rituale, una maledizione. I pezzi del puzzle iniziano a combaciare, ma manca ancora qualcosa di fondamentale.",
                onEnter: () => {
                    hasPartialMemory = true;
                    souls += 25;
                    updateUI();
                    showSoulsNotification(25);
                    showSimpleAchievement("Ricordi Parziali");
                },
                choices: [
                    { text: "Continua a meditare", nextScene: "sogniRicordi" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            sogniRicordi: {
                title: "Sogni e Ricordi",
                text: "I tuoi sogni si mescolano con i ricordi. Vedi un antico alchimista che lavora su una pozione, un rituale che va male, e la nascita della maledizione. Ora capisci meglio la tua missione.",
                onEnter: () => {
                    souls += 30;
                    updateUI();
                    showSoulsNotification(30);
                    showSimpleAchievement("Verità nei Sogni");
                },
                choices: [
                    { text: "Cerca l'alchimista", nextScene: "laboratorioAlchimista" },
                    { text: "Torna alle terre selvagge", nextScene: "terreSelvagge" }
                ]
            },
            guardieArrivano: {
                title: "Le Guardie Arrivano",
                text: "Le tue grida hanno attirato l'attenzione delle guardie! Sentono rumori di passi pesanti che si avvicinano. Devi decidere rapidamente cosa fare.",
                onEnter: () => {
                    hasAlertedGuards = true;
                    const guardDamage = Math.floor(Math.random() * 10) + 5;
                    playerHealth -= guardDamage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(guardDamage, "guardie");
                    }
                },
                choices: [
                    { text: "Combatti le guardie", nextScene: "combattiGuardie" },
                    { text: "Fuggi rapidamente", nextScene: "fugaGuardie" },
                    { text: "Nasconditi", nextScene: "nasconditiGuardie" }
                ]
            },
            combattiGuardie: {
                title: "Combattimento con le Guardie",
                text: "Tre guardie in armatura pesante ti circondano. Sono ben addestrate e coordinate. Il combattimento sarà difficile!",
                onEnter: () => {
                    // Aumento danni da 5-14 a 8-18
                    const guardDamage = Math.floor(Math.random() * 11) + 8; // Danno tra 8 e 18
                    
                    // 20% di probabilità di chiamata rinforzi (danno extra)
                    const reinforcements = Math.random() < 0.2;
                    let totalDamage = guardDamage;
                    let message = `Le guardie ti attaccano! Hai subito ${guardDamage} danni.`;
                    
                    if (reinforcements) {
                        const extraDamage = Math.floor(Math.random() * 8) + 3; // Danno extra 3-10
                        totalDamage += extraDamage;
                        message = `Le guardie chiamano rinforzi! Hai subito ${guardDamage} + ${extraDamage} = ${totalDamage} danni totali.`;
                    }
                    
                    playerHealth -= totalDamage;
                    updateUI();
                    if (playerHealth <= 0) {
                        showDeathScreen();
                    } else {
                        showDamageNotification(totalDamage, "guardie");
                    }
                },
                choices: [
                    { text: "Attacca con la spada", nextScene: "combattiGuardie", condition: () => inventory.includes("Spada Arrugginita") },
                    { text: "Usa l'Amuleto Antico", onSelect: () => useAmulet("combattiGuardie"), condition: () => inventory.includes("Amuleto Antico") },
                    { text: "Tenta di fuggire", nextScene: "fugaGuardie" }
                ]
            },
            fugaGuardie: {
                title: "Fuga dalle Guardie",
                text: "Decidi di fuggire! Corri attraverso i corridoi bui, sentendo le grida delle guardie dietro di te. La fuga è rischiosa!",
                onEnter: () => {
                    // Fuga disponibile solo con salute > 20 e 50% di probabilità di fallimento
                    if (playerHealth <= 20) {
                        showHealthWarningNotification();
                        loadScene("combattiGuardie");
                        return;
                    }
                    
                    const escapeSuccess = Math.random();
                    if (escapeSuccess < 0.5) {
                        // Fuga fallita
                        const failedDamage = Math.floor(Math.random() * 12) + 8;
                        playerHealth -= failedDamage;
                        showDamageNotification(failedDamage, "fuga fallita");
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            loadScene("combattiGuardie");
                        }
                    } else {
                        // Fuga riuscita
                        const escapeDamage = Math.floor(Math.random() * 8) + 2;
                        playerHealth -= escapeDamage;
                        souls += 15;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(escapeDamage, "fuga");
                            showSoulsNotification(15);
                        }
                    }
                },
                choices: [
                    { text: "Torna alla cella", nextScene: "cellaIniziale" },
                    { text: "Esplora nuovi corridoi", nextScene: "corridoiNascosti" }
                ]
            },
            nasconditiGuardie: {
                title: "Nascondersi dalle Guardie",
                text: "Ti nascondi abilmente in un angolo buio. Le guardie passano di corsa senza notarti. Hai evitato il combattimento, ma ora devi essere più cauto.",
                onEnter: () => {
                    // 40% di probabilità di essere scoperti
                    const discovered = Math.random() < 0.4;
                    
                    if (discovered) {
                        const damage = Math.floor(Math.random() * 10) + 5; // Danno 5-14
                        playerHealth -= damage;
                        updateUI();
                        if (playerHealth <= 0) {
                            showDeathScreen();
                        } else {
                            showDamageNotification(damage, "guardie");
                        }
                    } else {
                        souls += 10;
                        updateUI();
                        showSoulsNotification(10);
                    showSimpleAchievement("Nascondiglio Sicuro");
                    }
                },
                choices: [
                    { text: "Torna alla cella", nextScene: "cellaIniziale" },
                    { text: "Esplora silenziosamente", nextScene: "corridoiNascosti" }
                ]
            },
            corridoiNascosti: {
                title: "Corridoi Nascosti",
                text: "Hai scoperto una rete di corridoi nascosti nella prigione. Sono bui e pericolosi, ma potrebbero portarti a luoghi interessanti. L'aria è densa di mistero.",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    showSoulsNotification(20);
                    showSimpleAchievement("Corridoi Nascosti");
                },
                choices: [
                    { text: "Esplora più a fondo", nextScene: "cameraSegreta" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            cameraSegreta: {
                title: "Camera Segreta",
                text: "In una camera segreta trovi un antico libro di incantesimi e una pozione misteriosa. Sembrano essere stati lasciati qui da un prigioniero precedente.",
                onEnter: () => {
                    // Riduzione disponibilità pozioni del 50%
                    const potionChance = Math.random();
                    if (potionChance < 0.5 && !inventory.includes("Pozione di Forza")) {
                        inventory.push("Pozione di Forza");
                        souls += 25;
                        updateUI();
                        showItemNotification("Pozione di Forza", true);
                        showSoulsNotification(25);
                    } else {
                        souls += 25;
                        updateUI();
                        showSoulsNotification(25);
                    }
                },
                choices: [
                    { text: "Torna ai corridoi", nextScene: "corridoiNascosti" },
                    { text: "Torna alla cella", nextScene: "cellaIniziale" }
                ]
            },
            laboratorioAlchimista: {
                title: "Laboratorio dell'Alchimista",
                text: "Trovi un antico laboratorio alchemico. Bottiglie, alambicchi e ingredienti strani riempiono gli scaffali. Un vecchio alchimista sta lavorando su una pozione.",
                onEnter: () => {
                    souls += 30;
                    updateUI();
                    showSoulsNotification(30);
                    showSimpleAchievement("Laboratorio Alchemico");
                },
                choices: [
                    { text: "Parla con l'alchimista", nextScene: "dialogoAlchimista" },
                    { text: "Esamina le pozioni", nextScene: "esaminaPozioni" },
                    { text: "Usa il laboratorio per crafting", nextScene: "craftingMenu" },
                    { text: "Torna indietro", nextScene: "sogniRicordi" }
                ]
            },
            dialogoAlchimista: {
                title: "Dialogo con l'Alchimista",
                text: "L'alchimista ti riconosce! 'Sei tu quello della maledizione...' dice. 'Ho lavorato per anni per trovare una cura. Posso aiutarti, ma avrò bisogno di ingredienti rari.'",
                onEnter: () => {
                    souls += 20;
                    updateUI();
                    showSoulsNotification(20);
                    showSimpleAchievement("Alchimista Alleato");
                },
                choices: [
                    { text: "Accetta l'aiuto", nextScene: "ricettaCura" },
                    { text: "Chiedi informazioni", nextScene: "infoMaledizione" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            ricettaCura: {
                title: "La Ricetta della Cura",
                text: "L'alchimista ti mostra una ricetta complessa. 'Avrai bisogno di: 3 erbe rare, 50 anime, e l'Amuleto Antico. Se riesci a trovare questi ingredienti, posso creare la pozione che spezzerà la maledizione.'",
                onEnter: () => {
                    souls += 15;
                    updateUI();
                    showSoulsNotification(15);
                    showSimpleAchievement("Ricetta della Cura");
                },
                choices: [
                    { text: "Cerca le erbe rare", nextScene: "cercaErbe" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            infoMaledizione: {
                title: "Informazioni sulla Maledizione",
                text: "L'alchimista ti racconta: 'La maledizione fu creata da un antico culto. Colpisce la memoria e l'anima. Solo con gli artefatti giusti e la pozione corretta può essere spezzata.'",
                onEnter: () => {
                    souls += 25;
                    updateUI();
                    showSoulsNotification(25);
                    showSimpleAchievement("Informazioni Preziose");
                },
                choices: [
                    { text: "Chiedi della ricetta", nextScene: "ricettaCura" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            cercaErbe: {
                title: "Cerca delle Erbe Rare",
                text: "L'alchimista ti indica dove trovare le erbe rare: nelle Terre Selvagge, vicino alle rovine del tempio. Dovrai essere attento, sono ben nascoste.",
                onEnter: () => {
                    souls += 10;
                    updateUI();
                    showSoulsNotification(10);
                    showSimpleAchievement("Conoscenza delle Erbe");
                },
                choices: [
                    { text: "Vai alle Terre Selvagge", nextScene: "terreSelvagge" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            esaminaPozioni: {
                title: "Esamina le Pozioni",
                text: "Esamini le pozioni dell'alchimista. Molte sono pericolose, ma alcune potrebbero essere utili. Vedi una 'Pozione di Forza' che sembra sicura.",
                onEnter: () => {
                    // Riduzione disponibilità pozioni del 50%
                    const potionChance = Math.random();
                    if (potionChance < 0.5 && !inventory.includes("Pozione di Forza")) {
                        inventory.push("Pozione di Forza");
                        souls += 20;
                        updateUI();
                        showItemNotification("Pozione di Forza", true);
                        showSoulsNotification(20);
                    } else {
                        souls += 20;
                        updateUI();
                        showSoulsNotification(20);
                    }
                },
                choices: [
                    { text: "Parla con l'alchimista", nextScene: "dialogoAlchimista" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftingMenu: {
                title: "Menu di Crafting",
                text: "L'alchimista ti permette di usare il suo laboratorio per creare pozioni e oggetti magici. Hai bisogno di ingredienti specifici e anime per ogni ricetta.",
                onEnter: () => {
                    souls += 10;
                    updateUI();
                    showCraftingMenu();
                },
                choices: [
                    { text: "Crea Pozione di Salute", nextScene: "craftPozioneSalute" },
                    { text: "Crea Pozione di Forza", nextScene: "craftPozioneForza" },
                    { text: "Crea Amuleto Potenziato", nextScene: "craftAmuletoPotenziato" },
                    { text: "Crea Pozione della Cura", nextScene: "craftPozioneCura" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            bibliotecaAntica: {
                title: "Biblioteca Antica",
                text: "Una vasta biblioteca piena di tomi polverosi. I libri contengono conoscenze antiche sulla maledizione e sui rituali per spezzarla. Potresti trovare informazioni preziose.",
                onEnter: () => {
                    souls += 35;
                    updateUI();
                    showSoulsNotification(35);
                    showSimpleAchievement("Biblioteca Antica");
                },
                choices: [
                    { text: "Cerca informazioni sulla maledizione", nextScene: "ricercaMaledizione" },
                    { text: "Esplora i libri di incantesimi", nextScene: "libriIncantesimi" },
                    { text: "Torna indietro", nextScene: "terreSelvagge" }
                ]
            },
            craftPozioneSalute: {
                title: "Crea Pozione di Salute",
                text: "Preparati a creare una Pozione di Salute. Hai bisogno di Erba Curativa e Acqua Pura.",
                onEnter: () => {
                    if (craftItem("Pozione di Salute")) {
                        showCraftingNotification("Pozione di Salute");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftPozioneForza: {
                title: "Crea Pozione di Forza",
                text: "Preparati a creare una Pozione di Forza. Hai bisogno di Erba di Forza e Cristallo di Potenza.",
                onEnter: () => {
                    if (craftItem("Pozione di Forza")) {
                        showCraftingNotification("Pozione di Forza");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftAmuletoPotenziato: {
                title: "Crea Amuleto Potenziato",
                text: "Preparati a creare un Amuleto Potenziato. Hai bisogno di Amuleto Antico, Pergamena di Rune e Gemma Preziosa.",
                onEnter: () => {
                    if (craftItem("Amuleto Potenziato")) {
                        showCraftingNotification("Amuleto Potenziato");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            craftPozioneCura: {
                title: "Crea Pozione della Cura",
                text: "Preparati a creare la Pozione della Cura. Hai bisogno di Erba Rara, Amuleto Antico e Cristallo di Anima.",
                onEnter: () => {
                    if (craftItem("Pozione della Cura")) {
                        showCraftingNotification("Pozione della Cura");
                    }
                },
                choices: [
                    { text: "Torna al menu crafting", nextScene: "craftingMenu" },
                    { text: "Torna al laboratorio", nextScene: "laboratorioAlchimista" }
                ]
            },
            ricercaMaledizione: {
                title: "Ricerca sulla Maledizione",
                text: "Nei libri antichi trovi informazioni cruciali: la maledizione fu creata usando l'Amuleto Antico e la Pergamena di Rune. Per spezzarla, devi usare gli stessi artefatti in un rituale inverso.",
                onEnter: () => {
                    souls += 40;
                    updateUI();
                    showSoulsNotification(40);
                    showSimpleAchievement("Informazioni Cruciali");
                },
                choices: [
                    { text: "Cerca il rituale inverso", nextScene: "ritualeInverso" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            ritualeInverso: {
                title: "Il Rituale Inverso",
                text: "Hai trovato la descrizione del rituale inverso! Richiede: l'Amuleto Antico, la Pergamena di Rune, 100 anime, e deve essere eseguito nel Santuario della Maledizione.",
                onEnter: () => {
                    souls += 50;
                    updateUI();
                    showSoulsNotification(50);
                    showSimpleAchievement("Rituale Inverso");
                },
                choices: [
                    { text: "Vai al Santuario", nextScene: "santuarioFinale" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            libriIncantesimi: {
                title: "Libri di Incantesimi",
                text: "I libri di incantesimi contengono formule complesse. Alcune potrebbero essere utili per il tuo viaggio. Trovi anche una mappa del tempio antico.",
                onEnter: () => {
                    if (!inventory.includes("Mappa del Tempio")) {
                        inventory.push("Mappa del Tempio");
                        souls += 30;
                        updateUI();
                        showItemNotification("Mappa del Tempio", true);
                        showSoulsNotification(30);
                    } else {
                        souls += 30;
                        updateUI();
                        showSoulsNotification(30);
                    }
                },
                choices: [
                    { text: "Cerca informazioni sulla maledizione", nextScene: "ricercaMaledizione" },
                    { text: "Torna alla biblioteca", nextScene: "bibliotecaAntica" }
                ]
            },
            cameraTesori: {
                title: "Camera dei Tesori",
                text: "Una camera segreta piena di tesori! Oro, gemme e artefatti antichi riempiono la stanza. Al centro, un forziere dorato attira la tua attenzione.",
                onEnter: () => {
                    souls += 100;
                    if (!inventory.includes("Gemma Preziosa")) {
                        inventory.push("Gemma Preziosa");
                        updateUI();
                        showItemNotification("Gemma Preziosa", true);
                        showSoulsNotification(100);
                    } else {
                        updateUI();
                        showSoulsNotification(100);
                    }
                },
                choices: [
                    { text: "Apri il forziere dorato", nextScene: "forziereDorato" },
                    { text: "Torna al passaggio segreto", nextScene: "passaggioSegreto" }
                ]
            },
            forziereDorato: {
                title: "Il Forziere Dorato",
                text: "Il forziere dorato contiene un antico artefatto: la 'Corona dell'Anima'. È un oggetto di potere immenso che potrebbe essere la chiave per spezzare definitivamente la maledizione.",
                onEnter: () => {
                    if (!inventory.includes("Corona dell'Anima")) {
                        inventory.push("Corona dell'Anima");
                        souls += 150;
                        updateUI();
                        showItemNotification("Corona dell'Anima", true);
                        showSoulsNotification(150);
                    }
                },
                choices: [
                    { text: "Torna alla camera dei tesori", nextScene: "cameraTesori" },
                    { text: "Vai al Santuario", nextScene: "santuarioFinale" }
                ]
            },
            santuarioIntermedio: {
                title: "Santuario Intermedio",
                text: "Un santuario più piccolo ma comunque sacro. Le fiamme del fuoco sacro danzano dolcemente. Tuttavia, noti che le fiamme sembrano più deboli e richiedono un'offerta per essere attivate.",
                onEnter: () => {
                    // Il santuario intermedio è stato disabilitato per aumentare la sfida
                    showNotification("Questo santuario è stato disabilitato. Devi trovare un altro punto di riposo.", "info", 3000);
                },
                choices: [
                    { text: "Continua il viaggio", nextScene: "terreSelvagge" },
                    { text: "Cerca un altro rifugio", nextScene: "rovineTempio" }
                ]
            },
            frammentoSpecchio: {
                title: "Il Frammento di Specchio - Il Volto di Lyra",
                text: "Il frammento di specchio è più di quello che sembra. Quando lo sollevi, la sua superficie non riflette la tua immagine attuale, ma qualcosa di molto più antico. Per un momento, vedi una donna dai capelli scuri e gli occhi verdi - Lyra Stormweaver, la tua amata.\n\nIl ricordo è così vivido che quasi ti fa male: sei in una sala maestosa, circondato da altri Guardiani delle Anime. Lyra ti guarda con amore e paura, sapendo che stai per fare qualcosa di terribile. 'Devo farlo,' dici a te stesso nel ricordo, 'anche se significa condannare tutti noi a questo ciclo infinito.'\n\nIl frammento si riscalda tra le tue mani, e senti una connessione profonda con quella donna. Era la tua amata, sacrificata per il potere necessario a creare la maledizione. Il dolore del ricordo è quasi insopportabile.",
                choices: [
                    {
                        text: "Concentrati sul ricordo, accetta la verità",
                        nextScene: "accettareVerita",
                        onSelect: function() {
                            executeActionOnce('accept_truth_mirror', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(20); // Accettazione della verità
                                }
                                playerHealth -= 15; // Dolore emotivo per Lyra
                                updateUI();
                                showMemoryNotification('frammento');
                            });
                        }
                    },
                    {
                        text: "Rifiuta il ricordo, è troppo doloroso",
                        nextScene: "rifiutareRicordo",
                        onSelect: function() {
                            executeActionOnce('reject_truth_mirror', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-10); // Rifiuto della verità
                                }
                                playerHealth -= 15; // Stress emotivo
                                updateUI();
                            });
                        }
                    },
                    {
                        text: "Cerca di capire di più, studia il frammento",
                        nextScene: "studiareFrammento",
                        onSelect: function() {
                            executeActionOnce('study_fragment_investigation', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(15); // Approccio investigativo
                                }
                                playerHealth -= 5; // Sforzo mentale
                                updateUI();
                            });
                        }
                    }
                ]
            },
            torreMemoria: {
                title: "La Torre della Memoria",
                text: "La Torre della Memoria si erge davanti a te come un monumento al passato. Le sue pareti sono ricoperte di rune che pulsano con una luce dorata, e l'aria è satura di magia antica. Questo è il luogo dove i Guardiani delle Anime conservavano i loro ricordi più preziosi.\n\nMentre sali le scale di pietra, ogni passo ti riporta un frammento di memoria più vivido del precedente. Vedi immagini di Theron, tuo padre, che ti insegna le rune. Vedi Lyra, la tua amata, che ti sorride con amore. Vedi il Consiglio dei Guardiani, dove hai preso la decisione più difficile della tua vita.\n\nIn cima alla torre, trovi una stanza circolare con un grande specchio al centro. È qui che potrai vedere la verità completa, se hai il coraggio di guardare.",
                onEnter: function() {
                    // Trigger achievement per aver raggiunto la Torre
                    if (typeof achievementSystem !== 'undefined') {
                        achievementSystem.unlockAchievement('memory_keeper');
                    }
                },
                choices: [
                    {
                        text: "Guarda nello specchio, affronta la verità completa",
                        nextScene: "veritaCompleta",
                        onSelect: function() {
                            executeActionOnce('face_complete_truth', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(30); // Coraggio di affrontare la verità
                                }
                                playerHealth -= 20; // Stress emotivo intenso
                                updateUI();
                                showMemoryNotification('verità');
                            });
                        }
                    },
                    {
                        text: "Studia le rune della torre per comprendere meglio",
                        nextScene: "studiareRuneTorre",
                        onSelect: function() {
                            executeActionOnce('study_tower_runes', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(15); // Approccio metodico
                                }
                                playerHealth -= 10; // Sforzo mentale
                                updateUI();
                            });
                        }
                    },
                    {
                        text: "Torna indietro, non sei pronto per la verità",
                        nextScene: "cellaIniziale",
                        onSelect: function() {
                            executeActionOnce('avoid_truth', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-10); // Paura della verità
                                }
                                playerHealth -= 5; // Stress emotivo
                                updateUI();
                            });
                        }
                    }
                ]
            },
            veritaCompleta: {
                title: "La Verità Completa - Il Sacrificio di Aric",
                text: "Lo specchio della Torre della Memoria ti mostra la verità completa, e il peso di quello che vedi ti schiaccia. Vedi te stesso, Aric Valenheart, in una sala maestosa circondato dal Consiglio dei Guardiani delle Anime.\n\nLa scena è vivida e dolorosa: stai per creare la maledizione che proteggerà Eldoria da L'Abisso, ma il prezzo è terribile. Vedi Lyra, la tua amata, che ti guarda con amore e paura. Vedi Theron, tuo padre, che ti sorride con orgoglio e tristezza. Vedi i tuoi compagni Guardiani che si preparano al sacrificio.\n\n'Devo farlo,' dici nel ricordo, 'anche se significa condannare tutti noi a questo ciclo infinito. È l'unico modo per salvare Eldoria da L'Abisso.'\n\nIl rituale inizia, e vedi le anime dei tuoi compagni, inclusa Lyra, che si dissolvono per fornire il potere necessario. Il dolore è insopportabile, ma la determinazione nel tuo volto è assoluta. Hai salvato Eldoria, ma hai condannato te stesso e i tuoi cari a un'esistenza di dolore.",
                onEnter: function() {
                    // Trigger achievement per aver visto la verità completa
                    if (typeof achievementSystem !== 'undefined') {
                        achievementSystem.unlockAchievement('guardian');
                    }
                    // Aggiungi l'Amuleto di Lyra all'inventario
                    if (!inventory.includes("Amuleto di Lyra")) {
                        inventory.push("Amuleto di Lyra");
                        showItemNotification("Amuleto di Lyra", true);
                        updateUI();
                    }
                },
                choices: [
                    {
                        text: "Accetta la responsabilità, è tempo di espiare",
                        nextScene: "accettareResponsabilita",
                        onSelect: function() {
                            executeActionOnce('accept_responsibility', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(50); // Accettazione completa
                                }
                                playerHealth += 25; // Pace interiore
                                souls += 100; // Comprensione del valore delle anime
                                updateUI();
                                showMemoryNotification('ricordi');
                            });
                        }
                    },
                    {
                        text: "Rifiuta il passato, non puoi essere quel mostro",
                        nextScene: "rifiutarePassato",
                        onSelect: function() {
                            executeActionOnce('reject_past', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-30); // Rifiuto della responsabilità
                                }
                                playerHealth -= 30; // Stress emotivo intenso
                                updateUI();
                            });
                        }
                    },
                    {
                        text: "Comprendi la necessità, ma cerca una via d'uscita",
                        nextScene: "cercareViaUscita",
                        onSelect: function() {
                            executeActionOnce('seek_alternative', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(20); // Approccio equilibrato
                                }
                                playerHealth -= 10; // Stress moderato
                                updateUI();
                            });
                        }
                    }
                ]
            },
            studiareRune: {
                title: "Le Rune Antiche",
                text: "Le rune sulle pareti non sono semplici decorazioni: sono una storia, la TUA storia. Mentre le studi, i simboli iniziano a brillare con una luce dorata, e le parole si formano nella tua mente come se fossero sempre state lì.\n\n'Guardiano delle Anime, Custode della Maledizione, Protettore di Eldoria.' Questi sono i tuoi titoli, i tuoi ruoli. Ma c'è di più: le rune raccontano di una decisione presa secoli fa, di un sacrificio fatto per salvare il mondo da qualcosa di molto più terribile.\n\nOgni runa che leggi ti riporta un frammento di memoria, e con ogni frammento, il peso della responsabilità diventa più pesante.",
                choices: [
                    {
                        text: "Continua a leggere, devi sapere tutto",
                        nextScene: "leggereTutto",
                        onSelect: function() {
                            executeActionOnce('read_all_runes', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(25); // Determinazione a conoscere
                                }
                                playerHealth -= 10; // Sforzo mentale intenso
                                updateUI();
                                // Sblocca la Torre della Memoria
                                if (typeof consequenceSystem !== 'undefined') {
                                    consequenceSystem.unlockedScenes.add('torreMemoria');
                                }
                            });
                        }
                    },
                    {
                        text: "Fermati, alcune verità sono troppo dolorose",
                        nextScene: "fermareLettura",
                        onSelect: function() {
                            executeActionOnce('stop_reading_runes', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-5); // Paura della verità
                                }
                                playerHealth -= 5; // Stress emotivo
                                updateUI();
                            });
                        }
                    },
                    {
                        text: "Cerca di decifrare solo le parti essenziali",
                        nextScene: "decifrareEssenziale",
                        onSelect: function() {
                            executeActionOnce('read_essential_runes', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(10); // Approccio equilibrato
                                }
                                playerHealth -= 3; // Sforzo moderato
                                updateUI();
                            });
                        }
                    }
                ]
            },
            accettareVerita: {
                title: "La Verità Accettata",
                text: "Con ogni respiro, la verità si insinua più profondamente nella tua anima. Non sei un semplice prigioniero: sei Aric, l'ultimo Guardiano delle Anime, e hai scelto volontariamente questa maledizione per salvare Eldoria.\n\nIl peso della responsabilità è immenso, ma ora che lo accetti, senti una strana pace. Le memorie tornano a poco a poco: la sala del consiglio, i tuoi compagni Guardiani, la decisione fatidica. Non è stato un errore, ma un sacrificio necessario.\n\nIl frammento di specchio ora brilla con una luce dorata, e senti che il tuo potere come Guardiano sta tornando. Ora che hai questa consapevolezza, puoi procedere con determinazione.",
                choices: [
                    {
                        text: "Continua a esplorare la cella",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('accept_truth_choice', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(15); // Determinazione rinnovata
                                }
                                playerHealth += 20; // Energia rinnovata
                                updateUI();
                            });
                        }
                    }
                ]
            },
            rifiutareRicordo: {
                title: "Il Ricordo Rifiutato",
                text: "Con un gesto brusco, getti via il frammento di specchio. Non vuoi sapere, non puoi sapere. Se quella persona dell'armatura dorata sei davvero tu, allora preferisci rimanere nell'ignoranza.\n\nMa il ricordo non se ne va così facilmente. Continua a tormentarti, come un'eco che non si placa. Ogni volta che chiudi gli occhi, vedi quella sala maestosa, quei volti familiari, quella decisione che ha cambiato tutto.\n\nL'aria della cella sembra più pesante ora, come se le pareti stesse ti giudicassero per la tua codardia. Devi trovare un modo per uscire da qui.",
                choices: [
                    {
                        text: "Continua a cercare una via d'uscita",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('reject_memory_choice', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-10); // Fuga dalla verità
                                }
                                playerHealth -= 10; // Stress persistente
                                updateUI();
                            });
                        }
                    }
                ]
            },
            studiareFrammento: {
                title: "Studio Approfondito",
                text: "Con attenzione meticolosa, esamini ogni dettaglio del frammento di specchio. Non è solo vetro: è un artefatto antico, inciso con rune microscopiche che raccontano una storia di potere e sacrificio.\n\nAttraverso lo studio, scopri che il frammento è parte di un oggetto più grande: lo Specchio delle Anime, un artefatto che permette ai Guardiani di vedere il passato e il futuro. Ma c'è di più: il frammento contiene anche un frammento della tua anima.\n\nQuesta scoperta ti dà un potere limitato ma prezioso: puoi usare il frammento per accedere a memorie specifiche quando ne hai bisogno.",
                choices: [
                    {
                        text: "Usa il frammento per accedere a più memorie",
                        nextScene: "accedereMemorie",
                        onSelect: function() {
                            executeActionOnce('use_fragment_memories', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(20); // Approccio metodico
                                }
                                playerHealth -= 5; // Sforzo mentale
                                updateUI();
                            });
                        }
                    },
                    {
                        text: "Conserva il frammento e continua a esplorare",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('keep_fragment_explore', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(10); // Saggezza
                                }
                                // Aggiungi il frammento all'inventario
                                if (typeof inventory !== 'undefined') {
                                    inventory.push("Frammento di Specchio");
                                    updateUI();
                                }
                            });
                        }
                    }
                ]
            },
            leggereTutto: {
                title: "La Storia Completa",
                text: "Le rune si aprono davanti a te come un libro infinito, e ogni parola che leggi ti riporta un frammento di memoria. La storia è completa ora: sei Aric, l'ultimo Guardiano delle Anime, e hai scelto di sacrificare la tua umanità per salvare Eldoria da una minaccia antica.\n\nIl 'Male Oscuro' che minacciava il mondo non poteva essere sconfitto con la forza, ma solo con un sacrificio: rinunciare alla propria umanità per diventare un custode immortale. Tu e i tuoi compagni avete accettato questa maledizione, ma il prezzo è stato alto.\n\nOra capisci: questa prigione non è una punizione, ma un test. Devi dimostrare di essere ancora degno del tuo ruolo di Guardiano.",
                choices: [
                    {
                        text: "Accetta il tuo ruolo di Guardiano",
                        nextScene: "accettareRuolo",
                        onSelect: function() {
                            executeActionOnce('accept_guardian_role', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(30); // Accettazione completa
                                }
                                playerHealth += 25; // Energia rinnovata
                                updateUI();
                            });
                        }
                    }
                ]
            },
            fermareLettura: {
                title: "La Lettura Interrotta",
                text: "Con un gesto brusco, distogli lo sguardo dalle rune. Non puoi continuare a leggere, non ora. La verità che stai scoprendo è troppo dolorosa, troppo opprimente.\n\nMa anche se hai smesso di leggere, le poche parole che hai visto continuano a tormentarti. 'Guardiano delle Anime', 'Custode della Maledizione', 'Protettore di Eldoria' - questi titoli ti appartengono, anche se non li ricordi.\n\nL'aria della cella sembra più pesante ora, come se le pareti stesse ti giudicassero per la tua debolezza. Devi trovare un'altra via d'uscita.",
                choices: [
                    {
                        text: "Continua a cercare una via d'uscita",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('reject_responsibility', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(-15); // Rifiuto della responsabilità
                                }
                                playerHealth -= 15; // Stress emotivo
                                updateUI();
                            });
                        }
                    }
                ]
            },
            decifrareEssenziale: {
                title: "Le Verità Essenziali",
                text: "Con un approccio metodico, ti concentri solo sulle rune più importanti. Non hai bisogno di sapere tutto, solo quello che ti serve per sopravvivere e capire la tua situazione.\n\nQuello che scopri è sufficiente: sei Aric, un Guardiano delle Anime, e questa prigione è parte di un test o di una prova. Le rune parlano di una 'maledizione necessaria' e di un 'sacrificio per il bene superiore'.\n\nNon hai tutti i dettagli, ma hai abbastanza informazioni per procedere con cautela e determinazione. A volte, la saggezza sta nel sapere quando fermarsi.",
                choices: [
                    {
                        text: "Continua a esplorare con le informazioni acquisite",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('continue_balanced_approach', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(15); // Approccio equilibrato
                                }
                                playerHealth += 5; // Pace interiore
                                updateUI();
                            });
                        }
                    }
                ]
            },
            accedereMemorie: {
                title: "Memorie Profonde",
                text: "Concentrando la tua volontà sul frammento di specchio, senti la sua energia pulsare tra le tue mani. Le memorie fluiscono come un fiume di luce dorata, e improvvisamente sei trasportato in un altro tempo.\n\nVedi te stesso in una sala maestosa, circondato da altri Guardiani delle Anime. La discussione è accesa, e tu stai parlando con passione: 'La maledizione è l'unica soluzione,' dici, 'ma il prezzo sarà alto. Tutti noi dovremo rinunciare alla nostra umanità per proteggere Eldoria.'\n\nIl ricordo si interrompe bruscamente, ma ora hai una comprensione più profonda del tuo ruolo. Non sei una vittima, ma un eroe che ha scelto il sacrificio.",
                choices: [
                    {
                        text: "Ritorna alla cella con nuova consapevolezza",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('deep_understanding_memories', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(25); // Comprensione profonda
                                }
                                playerHealth += 15; // Energia rinnovata
                                updateUI();
                            });
                        }
                    }
                ]
            },
            accettareRuolo: {
                title: "Il Guardiano Riconosciuto",
                text: "Con ogni fibra del tuo essere, accetti il tuo ruolo di Guardiano delle Anime. Non è una maledizione, ma un'onore: sei stato scelto per proteggere Eldoria, e ora che ricordi, sei pronto a servire di nuovo.\n\nLe rune sulle pareti brillano con una luce dorata, riconoscendo la tua accettazione. Senti il potere fluire di nuovo attraverso di te, non come una forza esterna, ma come parte integrante della tua essenza.\n\nLa cella non è più una prigione, ma un luogo di riflessione e preparazione. Ora sei pronto per affrontare le sfide che ti aspettano, con la piena consapevolezza del tuo destino.",
                choices: [
                    {
                        text: "Procedi come Guardiano delle Anime",
                        nextScene: "esploraCella",
                        onSelect: function() {
                            executeActionOnce('complete_guardian_acceptance', function() {
                                if (typeof karmaSystem !== 'undefined') {
                                    karmaSystem.addKarma(35); // Accettazione completa del ruolo
                                }
                                playerHealth += 30; // Energia massima
                                updateUI();
                            });
                        }
                    }
                ]
            },
            
            // ============================================================================
            // SCENE MIGLIORATE FASE 3 - SISTEMA CONSEQUENZIALE
            // ============================================================================
            
            // Scene che si sbloccano con scelte positive
            spiritoAlleato: {
                title: "L'Alleato Spirituale",
                text: "L'anima che hai liberato si materializza davanti a te come una figura luminosa, vestita con abiti antichi. I suoi occhi brillano di gratitudine e saggezza.\n\n'Grazie, Guardiano,' sussurra con una voce che sembra provenire da un altro mondo. 'Hai fatto la scelta giusta, anche se ti è costata caro. Ora sono libero di continuare il mio viaggio, ma prima posso aiutarti.'\n\nLo spirito ti porge un oggetto luminoso: una gemma che pulsa con energia sacra. 'Prendi questo. Ti aiuterà a ricordare chi sei veramente.'",
                onEnter: function() {
                    if (typeof consequenceSystem !== 'undefined' && consequenceSystem.isSceneUnlocked('spirito_alleato')) {
                        inventory.push('Gemma Spirituale');
                        updateUI();
                        showNotification('✨ Gemma Spirituale ottenuta!', 'item', 3000);
                    }
                },
                choices: [
                    {
                        text: "Accetta la gemma con gratitudine",
                        nextScene: "veggenteFriendly",
                        onSelect: function() {
                            consequenceSystem.applyChoice('libera_anima');
                        }
                    },
                    {
                        text: "Chiedi informazioni sul passato",
                        nextScene: "memoriaCompleta",
                        onSelect: function() {
                            karmaSystem.addKarma(10);
                            updateUI();
                        }
                    }
                ]
            },
            
            veggenteFriendly: {
                title: "Il Veggente Benevolo",
                text: "Entri in una stanza illuminata da candele antiche, dove un veggente con occhi che brillano di saggezza millenaria ti attende. Il suo volto si illumina quando ti vede.\n\n'Ah, un'anima pura!' esclama con gioia. 'Il tuo karma risplende come l'oro antico. Sei degno di conoscere i segreti più profondi di questo luogo.'\n\nIl veggente ti conduce a un tavolo coperto di pergamene antiche e oggetti misteriosi. 'Hai fatto la scelta giusta liberando quell'anima. Ora posso aiutarti a comprendere il tuo vero ruolo.'",
                choices: [
                    {
                        text: "Ascolta la saggezza del veggente",
                        nextScene: "conoscenzaAntica",
                        onSelect: function() {
                            karmaSystem.addKarma(15);
                            updateUI();
                        }
                    },
                    {
                        text: "Chiedi informazioni sui tuoi poteri",
                        nextScene: "poteriSacri",
                        onSelect: function() {
                            karmaSystem.addKarma(10);
                            updateUI();
                        }
                    }
                ]
            },
            
            conoscenzaAntica: {
                title: "La Conoscenza Proibita",
                text: "Il veggente spiega le rune antiche con una voce che sembra provenire da un altro tempo. 'Queste rune raccontano la storia di Eldoria, di come il mondo sia stato salvato da una catastrofe imminente attraverso un sacrificio collettivo.'\n\n'Tu, Aric, eri uno dei Guardiani scelti per mantenere la maledizione che protegge il mondo. Ma qualcosa è andato storto, e ora sei qui, dimentico del tuo ruolo.'\n\nLe pergamene mostrano immagini di un tempo passato: tu e altri Guardiani in una cerimonia sacra, il momento in cui la maledizione è stata creata per salvare tutti.",
                choices: [
                    {
                        text: "Studia le pergamene più da vicino",
                        nextScene: "veritaCompleta",
                        onSelect: function() {
                            consequenceSystem.applyChoice('studia_rune');
                        }
                    },
                    {
                        text: "Chiedi come ripristinare i tuoi poteri",
                        nextScene: "ripristinoPoteri",
                        onSelect: function() {
                            karmaSystem.addKarma(20);
                            updateUI();
                        }
                    }
                ]
            },
            
            // Scene che si sbloccano con scelte negative
            spiritiOstili: {
                title: "Gli Spiriti Ostili",
                text: "L'aria si riempie di presenze malevoli, spiriti che ti circondano con occhi pieni di rancore. Le loro voci sussurrano parole di odio e vendetta.\n\n'Sei come gli altri,' sibila uno spirito. 'Prendi quello che ti serve e abbandoni chi ti ha aiutato. Non meriti la nostra fiducia.'\n\nGli spiriti iniziano a tormentarti, causando dolore fisico e mentale. Il loro odio è palpabile, e senti la loro energia negativa che ti avvolge come una morsa.",
                choices: [
                    {
                        text: "Cerca di placare gli spiriti",
                        nextScene: "mercanteHostile",
                        onSelect: function() {
                            consequenceSystem.applyChoice('bevi_acqua');
                        }
                    },
                    {
                        text: "Fuggi dalla stanza",
                        nextScene: "corridoioOscuro",
                        onSelect: function() {
                            playerHealth -= 20;
                            karmaSystem.addKarma(-15);
                            updateUI();
                        }
                    }
                ]
            },
            
            mercanteHostile: {
                title: "Il Mercante Diffidente",
                text: "Il mercante ti guarda con sospetto, i suoi occhi stretti mentre valuta la tua persona. Il suo negozio sembra più buio e minaccioso ora.\n\n'Hmm... Il tuo karma è oscuro,' dice con cautela. 'Non so se dovrei fidarmi di te. Le tue azioni parlano più forte delle tue parole.'\n\nGli oggetti nel negozio sembrano meno invitanti, e alcuni addirittura sembrano pulsare con energia malevola. Il mercante tiene la mano vicino a un'arma nascosta.",
                choices: [
                    {
                        text: "Cerca di convincere il mercante",
                        nextScene: "negoziazioneDifficile",
                        onSelect: function() {
                            karmaSystem.addKarma(-10);
                            updateUI();
                        }
                    },
                    {
                        text: "Accetta la diffidenza e vai via",
                        nextScene: "corridoioOscuro",
                        onSelect: function() {
                            karmaSystem.addKarma(-5);
                            updateUI();
                        }
                    }
                ]
            },
            
            // Scene speciali per comunicazione con golem
            golemAlleato: {
                title: "Il Golem Amichevole",
                text: "Il golem di pietra si ferma davanti a te, i suoi occhi di cristallo che brillano con intelligenza antica. Invece di attaccare, si inchina leggermente in segno di rispetto.\n\n'Guardiano,' dice con una voce che risuona come pietra che si muove. 'Riconosco la tua aura. Sei uno di noi, un protettore di questo luogo sacro.'\n\nIl golem ti porge una mano aperta, rivelando una runa incisa nel palmo. 'Prendi questa conoscenza. Ti aiuterà a ricordare il tuo vero scopo.'",
                choices: [
                    {
                        text: "Accetta la conoscenza del golem",
                        nextScene: "runaGolem",
                        onSelect: function() {
                            consequenceSystem.applyChoice('comunica_golem');
                        }
                    },
                    {
                        text: "Chiedi informazioni sui tuoi poteri",
                        nextScene: "poteriGolem",
                        onSelect: function() {
                            karmaSystem.addKarma(15);
                            updateUI();
                        }
                    }
                ]
            },
            
            runaGolem: {
                title: "La Runa del Golem",
                text: "La runa che il golem ti ha donato brilla con una luce dorata, e improvvisamente la conoscenza fluisce nella tua mente come un fiume di ricordi.\n\nVedi te stesso in un laboratorio antico, circondato da golem come questo. Stai insegnando loro a proteggere i segreti di Eldoria, a mantenere l'equilibrio tra il mondo fisico e quello spirituale.\n\n'Sei stato un maestro dei golem,' dice il golem. 'Hai creato molti di noi per proteggere questo luogo. Ora che ricordi, puoi riprendere il tuo ruolo.'",
                choices: [
                    {
                        text: "Accetta il ruolo di maestro dei golem",
                        nextScene: "maestroGolem",
                        onSelect: function() {
                            karmaSystem.addKarma(25);
                            playerHealth += 20;
                            updateUI();
                        }
                    },
                    {
                        text: "Chiedi aiuto per ripristinare i tuoi poteri",
                        nextScene: "ripristinoPoteri",
                        onSelect: function() {
                            karmaSystem.addKarma(15);
                            updateUI();
                        }
                    }
                ]
            },
            
            // Scene per potere oscuro
            potereOscuro: {
                title: "Il Potere Oscuro",
                text: "Il sacrificio della memoria ti ha dato accesso a poteri che non dovresti possedere. L'energia oscura fluisce attraverso di te, dandoti forza ma corrompendo la tua anima.\n\nLe ombre sembrano rispondere ai tuoi comandi, e senti una connessione con le forze più oscure di questo mondo. Il potere è seducente, ma sai che ha un prezzo.\n\n'Il potere oscuro ti ha chiamato,' sussurra una voce nelle tue orecchie. 'Abraccialo, e diventerai più forte di quanto tu abbia mai immaginato.'",
                choices: [
                    {
                        text: "Abraccia il potere oscuro",
                        nextScene: "corruzioneCompleta",
                        onSelect: function() {
                            consequenceSystem.applyChoice('sacrifica_memoria');
                        }
                    },
                    {
                        text: "Resisti alla tentazione",
                        nextScene: "resistenzaOscurita",
                        onSelect: function() {
                            karmaSystem.addKarma(20);
                            playerHealth -= 10;
                            updateUI();
                        }
                    }
                ]
            },
            
            memoriaCompleta: {
                title: "La Memoria Completa",
                text: "Lo spirito ti tocca la fronte, e improvvisamente tutti i ricordi tornano in un torrente di immagini e sensazioni. Vedi la tua vita passata in dettaglio: la tua formazione come Guardiano, la decisione di creare la maledizione, il sacrificio che hai fatto per salvare Eldoria.\n\n'Ricordi ora?' chiede lo spirito. 'Sei Aric, Guardiano delle Anime, e questa non è una prigione ma un luogo di riflessione. La maledizione che hai creato protegge il mondo da una minaccia ancora più grande.'\n\nCon la memoria completa, senti il potere fluire di nuovo attraverso di te, non come una forza esterna ma come parte integrante della tua essenza.",
                choices: [
                    {
                        text: "Accetta completamente il tuo ruolo",
                        nextScene: "guardianoCompleto",
                        onSelect: function() {
                            karmaSystem.addKarma(50);
                            playerHealth += 50;
                            updateUI();
                        }
                    },
                    {
                        text: "Chiedi come rompere la maledizione",
                        nextScene: "rompereMaledizione",
                        onSelect: function() {
                            karmaSystem.addKarma(30);
                            updateUI();
                        }
                    }
                ]
            }
        };

        // Funzioni di gestione del gioco

        // ============================================================================
        // SISTEMA RESISTENZA FASE 4 - BILANCIAMENTO
        // ============================================================================
        
        // Sistema di resistenza basato su karma
        function calculateDamage(baseDamage) {
            const karmaResistance = Math.max(0, karmaSystem.currentKarma) / 10;
            const finalDamage = Math.max(1, baseDamage - karmaResistance);
            return Math.floor(finalDamage);
        }
        
        // ============================================================================
        // FUNZIONI SUPPORTO FASE 3 - SISTEMA CONSEQUENZIALE
        // ============================================================================
        
        function checkConsequenceSystem() {
            if (typeof consequenceSystem === 'undefined') {
                console.error('Sistema consequenziale non trovato!');
                return false;
            }
            return true;
        }
        
        function unlockScene(sceneId) {
            if (checkConsequenceSystem()) {
                consequenceSystem.unlockedScenes.add(sceneId);
                console.log(`Scena sbloccata: ${sceneId}`);
                showNotification(`🔓 Nuova area sbloccata!`, 'unlock', 3000);
            }
        }
        
        function blockScene(sceneId) {
            if (checkConsequenceSystem()) {
                consequenceSystem.blockedScenes.add(sceneId);
                console.log(`Scena bloccata: ${sceneId}`);
            }
        }
        
        function isSceneAvailable(sceneId) {
            if (checkConsequenceSystem()) {
                return consequenceSystem.isSceneUnlocked(sceneId) && 
                       !consequenceSystem.isSceneBlocked(sceneId);
            }
            return true; // Fallback se il sistema non è disponibile
        }
        
        function getNPCDialog(npcId) {
            if (checkConsequenceSystem()) {
                return consequenceSystem.getNPCDialog(npcId);
            }
            return null;
        }

        function showDeathScreen() {
            const deathScreen = document.getElementById('death-screen');
            deathScreen.style.display = 'flex';
            deathScreen.style.opacity = '0';
            deathScreen.style.transform = 'scale(0.9)';
            
            // Animazione di entrata per la schermata di morte
            setTimeout(() => {
                deathScreen.style.transition = 'all 0.5s ease-in-out';
                deathScreen.style.opacity = '1';
                deathScreen.style.transform = 'scale(1)';
                
                // Attiva particelle rosse
                addBloodParticles();
            }, 100);
            
            document.addEventListener('keydown', restartFromSacredFire, { once: true });
            checkAchievements(); // Controlla achievement per prima morte
        }

        function hideDeathScreen() {
            document.getElementById('death-screen').style.display = 'none';
            document.removeEventListener('keydown', restartFromSacredFire);
        }

        function restartFromSacredFire() {
            hideDeathScreen();
            playerHealth = maxHealth;
            loadScene(lastSacredFire);
            updateUI();
            showNotification("Sei rinato al tuo ultimo Fuoco Sacro!", "achievement", 3000);
        }

        function startGame() {
            console.log("Avvio del gioco...");
            hideDeathScreen();
            playerHealth = maxHealth;
            souls = 0;
            inventory = [];
            lastSacredFire = "cellaIniziale";
            hasKey = false;
            hasMap = false;
            foundSecretTunnel = false;
            foughtGolem = false;
            exploredDeepCrypt = false;
            hasPartialMemory = false;
            hasAlertedGuards = false;
            hasDefeatedMummy = false;
            achievements = {
                firstDeath: false,
                golemSlayer: false,
                treasureHunter: false,
                memoryRecovery: false,
                curseBreaker: false,
                alchemistHelper: false,
                libraryScholar: false,
                secretExplorer: false
            };
            currentScene = "cellaIniziale";
            
            // Reset dei flag per prevenire accumulo infinito
            visitedScenes = new Set();
            completedActions = new Set();
            updateUI();
            loadScene(currentScene);
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
        }

        function loadScene(sceneName) {
            const scene = scenes[sceneName];
            if (!scene) {
                console.error("Scena non trovata:", sceneName);
                return;
            }
            
            // Marca la scena come visitata
            markSceneVisited(sceneName);

            // Animazione di transizione avanzata
            const storyPanel = document.getElementById('story-panel');
            storyPanel.style.opacity = '0';
            storyPanel.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                currentScene = sceneName;
                document.getElementById('title').textContent = scene.title;
                
                // INTEGRAZIONE SISTEMI EVOLUTIVI - PRIORITÀ CRITICA
                // Controlla se la scena ha una descrizione evoluta
                let sceneText = scene.text;
                if (typeof evolvingScenes !== 'undefined') {
                    const evolvedDescription = evolvingScenes.getEvolvedDescription(sceneName);
                    if (evolvedDescription) {
                        sceneText = evolvedDescription;
                        console.log(`Descrizione evoluta caricata per: ${sceneName}`);
                    }
                }
                
                document.getElementById('text').textContent = sceneText;

                if (scene.onEnter) {
                    scene.onEnter();
                }

                const choicesDiv = document.getElementById('choices');
                choicesDiv.innerHTML = '';

                scene.choices.forEach((choice, index) => {
                    // Gestione delle condizioni per le scelte (es. item richiesti, flag)
                    if (choice.condition && !choice.condition()) {
                        return; // Salta questa scelta se la condizione non è soddisfatta
                    }

                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choice.text;

                    // Aggiungi animazione di delay per i pulsanti
                    button.style.animationDelay = `${index * 0.1}s`;
                    button.style.opacity = '0';
                    button.style.transform = 'translateY(10px)';

                    if (choice.requiredItems && !choice.requiredItems.every(item => inventory.includes(item))) {
                        button.disabled = true;
                        if (choice.failedText) {
                            button.title = choice.failedText;
                        }
                    }

                    button.onclick = () => {
                        // Aggiungi effetto ripple
                        const ripple = document.createElement('span');
                        ripple.classList.add('ripple');
                        button.appendChild(ripple);
                        
                        setTimeout(() => {
                            // INTEGRAZIONE SISTEMA MEMORIA SCELTE - PRIORITÀ CRITICA
                            // Registra la scelta nel sistema di memoria
                            if (typeof choiceMemory !== 'undefined') {
                                const choiceId = choice.text.toLowerCase().replace(/\s+/g, '_');
                                const karmaEffect = choice.karmaEffect || 0;
                                choiceMemory.recordChoice(sceneName, choiceId, karmaEffect, {
                                    choiceText: choice.text,
                                    nextScene: choice.nextScene
                                });
                            }
                            
                            // Controlla trigger di evoluzione per la scena
                            if (typeof evolvingScenes !== 'undefined') {
                                const choiceId = choice.text.toLowerCase().replace(/\s+/g, '_');
                                evolvingScenes.checkEvolutionTriggers(sceneName, choiceId);
                            }
                            
                            // Esegui onSelect se presente
                            if (choice.onSelect) {
                                choice.onSelect();
                            }
                            
                            // Carica la prossima scena se specificata
                            if (choice.nextScene) {
                                loadScene(choice.nextScene);
                            }
                        }, 150);
                    };
                    choicesDiv.appendChild(button);
                    
                    // Anima l'apparizione del pulsante
                    setTimeout(() => {
                        button.style.transition = 'all 0.3s ease';
                        button.style.opacity = '1';
                        button.style.transform = 'translateY(0)';
                    }, index * 100);
                });

                // Animazione di fade-in per il pannello
                storyPanel.style.transition = 'all 0.5s ease-in-out';
                storyPanel.style.opacity = '1';
                storyPanel.style.transform = 'translateY(0)';
                
                // Aggiungi effetti particellari per scene speciali
                if (sceneName.includes('fuoco') || sceneName.includes('sacro')) {
                    addSacredFireParticles();
                }
            }, 300);
        }

        function updateUI() {
            // Protezione contro variabili non inizializzate
            if (typeof playerHealth === 'undefined') playerHealth = maxHealth;
            if (typeof souls === 'undefined') souls = 0;
            if (typeof inventory === 'undefined') inventory = [];
            if (typeof lastSacredFire === 'undefined') lastSacredFire = "cellaIniziale";
            
            document.getElementById('health-display').textContent = `${playerHealth}/${maxHealth}`;
            document.getElementById('souls-display').textContent = souls;
            
            // Aggiorna visualizzazione karma
            updateKarmaDisplay();
            
            // Aggiorna visualizzazione difficoltà
            const difficultyDisplay = document.getElementById('difficulty-display');
            if (difficultyDisplay) {
                difficultyDisplay.textContent = difficultyLevel;
                difficultyDisplay.style.color = gameDifficulty >= 1.5 ? 'var(--ds-blood)' : 'var(--ds-gold)';
            }
            
            // Mappatura nomi fuochi sacri
            const fuochiSacroNomi = {
                "fuocoSacroPrigione": "Fuoco Sacro: Prigione",
                "fuocoSacroTempio": "Fuoco Sacro: Tempio",
                "fuocoSacroTerre": "Fuoco Sacro: Terre Selvagge",
                "cellaIniziale": "Inizio (Cella)"
            };
            document.getElementById('last-sacred-fire-display').textContent = fuochiSacroNomi[lastSacredFire] || "Nessuno";

            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            if (inventory.length === 0) {
                const li = document.createElement('li');
                li.textContent = "Nessun oggetto";
                inventoryList.appendChild(li);
            } else {
                inventory.forEach((item, index) => {
                    const li = document.createElement('li');
                    const itemInfo = itemDescriptions[item] || {
                        type: "Sconosciuto",
                        effect: "Effetto sconosciuto",
                        rarity: "Comune",
                        value: 0
                    };
                    
                    // Crea elemento con informazioni dettagliate
                    li.innerHTML = `
                        <div class="item-header">
                            <span class="item-name">${item}</span>
                            <span class="item-type">[${itemInfo.type}]</span>
                        </div>
                        <div class="item-details">
                            <span class="item-effect">${itemInfo.effect}</span>
                            <span class="item-rarity rarity-${itemInfo.rarity.toLowerCase()}">${itemInfo.rarity}</span>
                        </div>
                    `;
                    
                    // Aggiungi classe per oggetti importanti
                    if (item.includes("Amuleto") || item.includes("Corona") || item.includes("Gemma")) {
                        li.classList.add('important-item');
                    }
                    
                    // Aggiungi animazione per nuovi oggetti
                    if (index === inventory.length - 1 && inventory.length > 0) {
                        li.classList.add('new-item');
                        setTimeout(() => li.classList.remove('new-item'), 1000);
                    }
                    
                    // Aggiungi tooltip con informazioni complete
                    li.title = `${item}\nTipo: ${itemInfo.type}\nEffetto: ${itemInfo.effect}\nRarità: ${itemInfo.rarity}\nValore: ${itemInfo.value} anime`;
                    
                    inventoryList.appendChild(li);
                });
            }

            if (playerHealth <= 0) {
                showDeathScreen();
            } else {
                hideDeathScreen();
            }
            
            // Controlla achievement basati su inventario e flag
            checkAchievements();
        }

        function saveGame() {
            // SALVATAGGIO GENERALE: Salva tutto lo stato del gioco
            const gameState = {
                playerHealth,
                souls,
                inventory,
                currentScene,
                lastSacredFire,  // Punto di respawn quando muori
                hasKey,
                hasMap,
                foundSecretTunnel,
                foughtGolem,
                exploredDeepCrypt,
                hasPartialMemory,
                hasAlertedGuards,
                hasDefeatedMummy,
                achievements,
                visitedScenes: Array.from(visitedScenes),
                completedActions: Array.from(completedActions)
            };
            localStorage.setItem('soulJourneySave', JSON.stringify(gameState));
            updateUI(); // Aggiorna sempre la visualizzazione dopo il salvataggio
            document.getElementById('sacred-fire-status').textContent = "FUOCO SACRO ACCESO";
            setTimeout(() => document.getElementById('sacred-fire-status').textContent = "", 2000);
            console.log("Gioco salvato!");
        }

        // NUOVA FUNZIONE: Aggiorna solo il punto di respawn (fuoco sacro)
        function updateSacredFire(newFireLocation) {
            lastSacredFire = newFireLocation;
            saveGame(); // Salva automaticamente tutto quando si aggiorna il fuoco sacro
            updateUI(); // Aggiorna la visualizzazione
                            showSimpleAchievement("Fuoco Sacro Raggiunto");
            showNotification("Progressi salvati!", "achievement", 3000);
        }

        function loadGame() {
            const savedState = localStorage.getItem('soulJourneySave');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                playerHealth = gameState.playerHealth;
                souls = gameState.souls;
                inventory = gameState.inventory;
                currentScene = gameState.currentScene;
                lastSacredFire = gameState.lastSacredFire;
                hasKey = gameState.hasKey;
                hasMap = gameState.hasMap;
                foundSecretTunnel = gameState.foundSecretTunnel;
                foughtGolem = gameState.foughtGolem;
                exploredDeepCrypt = gameState.exploredDeepCrypt || false;
                hasPartialMemory = gameState.hasPartialMemory || false;
                hasAlertedGuards = gameState.hasAlertedGuards || false;
                hasDefeatedMummy = gameState.hasDefeatedMummy || false;
                achievements = gameState.achievements || {
                    firstDeath: false,
                    golemSlayer: false,
                    treasureHunter: false,
                    memoryRecovery: false,
                    curseBreaker: false,
                    alchemistHelper: false,
                    libraryScholar: false,
                    secretExplorer: false
                };
                
                // Ripristina i flag di scene visitate e azioni completate
                if (gameState.visitedScenes) {
                    visitedScenes = new Set(gameState.visitedScenes);
                }
                if (gameState.completedActions) {
                    completedActions = new Set(gameState.completedActions);
                }

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-container').style.display = 'flex';
                loadScene(currentScene);
                updateUI();
                hideDeathScreen();
                console.log("Gioco caricato!");
            } else {
                showNotification("Nessun salvataggio trovato!", "info", 3000);
            }
        }

        function confirmReset() {
            if (confirm("Sei sicuro di voler iniziare una nuova partita? Perderai tutti i progressi.")) {
                startGame();
            }
        }

        // Funzioni specifiche per azioni di gioco
        function buyItem(item, cost, currentSceneName) {
            if (souls >= cost) {
                souls -= cost;
                inventory.push(item);
                updateUI();
                showItemNotification(item, true);
                loadScene(currentSceneName);
            } else {
                showNotification("Non hai abbastanza anime!", "damage", 3000);
            }
        }

        function restAtSacredFire(returnScene) {
            // Richiede un'offerta per usare i fuochi sacri
            if (souls >= 15) {
                souls -= 15; // Costo per usare il fuoco sacro
                playerHealth = maxHealth;
                updateUI();
                showSoulsNotification(-15);
                showHealNotification(maxHealth - playerHealth);
                loadScene(returnScene);
            } else {
                showNotification("Non hai abbastanza anime (15 richieste) per attivare il Fuoco Sacro!", "damage", 3000);
                loadScene(returnScene);
            }
        }

        function meditateAltare(returnScene) {
            playerHealth = Math.min(maxHealth, playerHealth + 30);
            updateUI();
            showHealNotification(30);
            loadScene(returnScene);
        }

        function useItem(item, nextSceneIfUsed, messageIfNotFound) {
            if (inventory.includes(item)) {
                // Rimuovi l'oggetto dall'inventario se monouso, altrimenti no
                if (item === "Pozione di Salute") {
                    const index = inventory.indexOf(item);
                    if (index > -1) {
                        inventory.splice(index, 1);
                    }
                    playerHealth = Math.min(maxHealth, playerHealth + 50); // Cura la pozione
                    
                    // Effetto collaterale: 30% di probabilità di danno temporaneo
                    const sideEffect = Math.random();
                    if (sideEffect < 0.3) {
                        const damage = Math.floor(Math.random() * 10) + 5;
                        playerHealth -= damage;
                        showHealNotification(50);
                        showDamageNotification(damage, "effetto collaterale");
                    } else {
                        showHealNotification(50);
                    }
                } else if (item === "Mappa Rudimentale") {
                    showNotification("La Mappa Rudimentale ti ha rivelato un punto debole!", "achievement", 3000);
                    // La mappa non viene consumata
                }
                updateUI();
                loadScene(nextSceneIfUsed);
            } else {
                showNotification(messageIfNotFound, "damage", 3000);
            }
        }

        function touchRune(returnScene) {
            showNotification("La runa pulsa sotto il tuo tocco, rilasciando una scarica di energia arcana. Ti senti più forte!", "achievement", 4000);
            playerHealth = Math.min(maxHealth, playerHealth + 20);
            souls += 10;
            updateUI();
            loadScene(returnScene);
        }

        function useAmulet(returnScene) {
            if (inventory.includes("Amuleto Antico")) {
                showHealNotification(20);
                playerHealth = Math.min(maxHealth, playerHealth + 20);
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai l'Amuleto Antico!", "damage", 3000);
            }
        }

        function readScroll(returnScene) {
            if (inventory.includes("Pergamena di Rune")) {
                showSoulsNotification(15);
                souls += 15;
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai la Pergamena di Rune!", "damage", 3000);
            }
        }

        function useSack(returnScene) {
            if (inventory.includes("Sacca di Cuoio")) {
                showNotification("Usi la Sacca di Cuoio per aumentare la tua capacità di trasporto!", "achievement", 3000);
                // Implementazione simbolica - in un gioco reale si aumenterebbe il limite inventario
                souls += 10;
                showSoulsNotification(10);
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai la Sacca di Cuoio!", "damage", 3000);
            }
        }

        function useStrengthPotion(returnScene) {
            if (inventory.includes("Pozione di Forza")) {
                const index = inventory.indexOf("Pozione di Forza");
                if (index > -1) {
                    inventory.splice(index, 1);
                }
                playerHealth = Math.min(maxHealth, playerHealth + 30);
                
                // Effetto collaterale: 40% di probabilità di danno temporaneo
                const sideEffect = Math.random();
                if (sideEffect < 0.4) {
                    const damage = Math.floor(Math.random() * 15) + 10;
                    playerHealth -= damage;
                    showHealNotification(30);
                    showDamageNotification(damage, "effetto collaterale");
                    showNotification(`Salute attuale: ${playerHealth}`, "info", 2000);
                } else {
                    showHealNotification(30);
                    showNotification(`Salute attuale: ${playerHealth}`, "info", 2000);
                }
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai una Pozione di Forza!", "damage", 3000);
            }
        }

        function useGem(returnScene) {
            if (inventory.includes("Gemma Preziosa")) {
                souls += 50;
                showSoulsNotification(50);
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai una Gemma Preziosa!", "damage", 3000);
            }
        }

        function useCrown(returnScene) {
            if (inventory.includes("Corona dell'Anima")) {
                showHealNotification(50);
                showNotification("Potere della Corona attivato!", "achievement", 3000);
                playerHealth = Math.min(maxHealth, playerHealth + 50);
                updateUI();
                loadScene(returnScene);
            } else {
                showNotification("Non hai la Corona dell'Anima!", "damage", 3000);
            }
        }

        // Sistema di Crafting
        let craftingRecipes = {
            "Pozione di Salute": {
                ingredients: ["Erba Curativa", "Acqua Pura"],
                soulsCost: 10,
                description: "Ripristina 50 HP"
            },
            "Pozione di Forza": {
                ingredients: ["Erba di Forza", "Cristallo di Potenza"],
                soulsCost: 20,
                description: "Aumenta temporaneamente la forza"
            },
            "Amuleto Potenziato": {
                ingredients: ["Amuleto Antico", "Pergamena di Rune", "Gemma Preziosa"],
                soulsCost: 50,
                description: "Protezione arcana potenziata"
            },
            "Pozione della Cura": {
                ingredients: ["Erba Rara", "Amuleto Antico", "Cristallo di Anima"],
                soulsCost: 100,
                description: "Cura la maledizione (finale)"
            }
        };

        function canCraft(recipeName) {
            const recipe = craftingRecipes[recipeName];
            if (!recipe) return false;
            
            // Controlla se hai tutti gli ingredienti
            for (let ingredient of recipe.ingredients) {
                if (!inventory.includes(ingredient)) {
                    return false;
                }
            }
            
            // Controlla se hai abbastanza anime
            if (souls < recipe.soulsCost) {
                return false;
            }
            
            return true;
        }

        function craftItem(recipeName) {
            const recipe = craftingRecipes[recipeName];
            if (!recipe) {
                showNotification("Ricetta non trovata!", "damage", 3000);
                return false;
            }
            
            if (!canCraft(recipeName)) {
                showNotification("Non hai gli ingredienti necessari o abbastanza anime!", "damage", 3000);
                return false;
            }
            
            // Rimuovi gli ingredienti
            for (let ingredient of recipe.ingredients) {
                const index = inventory.indexOf(ingredient);
                if (index > -1) {
                    inventory.splice(index, 1);
                }
            }
            
            // Rimuovi le anime
            souls -= recipe.soulsCost;
            
            // Aggiungi l'oggetto craftato
            inventory.push(recipeName);
            
            // Effetti speciali per oggetti craftati con animazioni
            switch(recipeName) {
                case "Pozione della Cura":
                    showCraftingSuccess("Hai creato la Pozione della Cura! Questa può spezzare la maledizione!");
                    break;
                case "Amuleto Potenziato":
                    showCraftingSuccess("Hai creato l'Amuleto Potenziato! Protezione arcana aumentata!");
                    break;
                default:
                    showCraftingSuccess("Hai creato " + recipeName + "!");
            }
            
            updateUI();
            return true;
        }

        function showCraftingSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">⚗️ Crafting Completato!</div>
                <div style="font-size: 0.9em;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi la notifica dopo 3 secondi
            setTimeout(() => {
                notification.style.animation = 'achievementSlide 0.5s ease-in reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        function showCraftingMenu() {
            // Controllo di sicurezza per le variabili
            if (typeof craftingRecipes === 'undefined') {
                showNotification("Errore: Sistema crafting non disponibile", "damage", 3000);
                return;
            }
            
            if (typeof inventory === 'undefined') {
                inventory = [];
            }
            
            if (typeof souls === 'undefined') {
                souls = 0;
            }
            
            // Rimuovi menu esistenti
            const existingMenu = document.querySelector('.crafting-menu-overlay');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menuContainer = document.createElement('div');
            menuContainer.className = 'crafting-menu-overlay';
            menuContainer.style.opacity = '0';
            menuContainer.style.transition = 'opacity 0.3s ease';
            
            menuContainer.innerHTML = `
                <div class="crafting-menu">
                    <div class="crafting-header">
                        <h2>⚗️ Laboratorio Alchemico</h2>
                        <button class="close-button" onclick="closeCraftingMenu()">✕</button>
                    </div>
                    <div class="crafting-content">
                        <div class="crafting-recipes">
                            ${Object.keys(craftingRecipes).map(recipeName => {
                                const recipe = craftingRecipes[recipeName];
                                const canCraftRecipe = canCraft(recipeName);
                                const missingIngredients = recipe.ingredients.filter(ing => !inventory.includes(ing));
                                const missingSouls = recipe.soulsCost - souls;
                                
                                return `
                                    <div class="recipe-item ${canCraftRecipe ? 'available' : 'unavailable'}">
                                        <div class="recipe-header">
                                            <h3>${recipeName}</h3>
                                            <span class="recipe-cost">💀 ${recipe.soulsCost} anime</span>
                                        </div>
                                        <div class="recipe-ingredients">
                                            <strong>Ingredienti:</strong>
                                            ${recipe.ingredients.map(ing => {
                                                const hasIngredient = inventory.includes(ing);
                                                return `<span class="ingredient ${hasIngredient ? 'available' : 'missing'}">${ing}</span>`;
                                            }).join(' + ')}
                                        </div>
                                        <div class="recipe-effect">
                                            <strong>Effetto:</strong> ${recipe.description}
                                        </div>
                                        ${canCraftRecipe ? 
                                            `<button class="craft-button" onclick="craftItem('${recipeName}')">Crea</button>` : 
                                            `<div class="crafting-requirements">
                                                ${missingIngredients.length > 0 ? `Mancano: ${missingIngredients.join(', ')}` : ''}
                                                ${missingSouls > 0 ? `Anime insufficienti: -${missingSouls}` : ''}
                                            </div>`
                                        }
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="crafting-stats">
                            <h3>📊 Statistiche Crafting</h3>
                            <p>Anime disponibili: <span class="souls-available">${souls}</span></p>
                            <p>Ingredienti unici: <span class="unique-ingredients">${new Set(inventory).size}</span></p>
                            <p>Ricette disponibili: <span class="available-recipes">${Object.keys(craftingRecipes).filter(r => canCraft(r)).length}</span></p>
                            <p>Inventario: <span class="inventory-count">${inventory.length} oggetti</span></p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menuContainer);
            
            // Animazione di entrata
            setTimeout(() => {
                menuContainer.style.opacity = '1';
            }, 10);
        }

        function closeCraftingMenu() {
            const menu = document.querySelector('.crafting-menu-overlay');
            if (menu) {
                menu.style.opacity = '0';
                setTimeout(() => {
                    if (menu.parentNode) {
                        menu.parentNode.removeChild(menu);
                    }
                }, 300);
            }
        }



        // Funzioni per il sistema Achievement
        function checkAchievements() {
            // Achievement: Prima Morte
            if (!achievements.firstDeath && playerHealth <= 0) {
                achievements.firstDeath = true;
                showAchievementNotification("Sopravvissuto", "Hai subito la tua prima morte e sei rinato!");
            }
            
            // Achievement: Cacciatore di Golem
            if (!achievements.golemSlayer && foughtGolem) {
                achievements.golemSlayer = true;
                showAchievementNotification("Cacciatore di Golem", "Hai sconfitto il Golem!");
            }
            
            // Achievement: Cacciatore di Tesori
            if (!achievements.treasureHunter && inventory.length >= 5) {
                achievements.treasureHunter = true;
                showAchievementNotification("Cacciatore di Tesori", "Hai trovato 5 oggetti!");
            }
            
            // Achievement: Ricordi Recuperati
            if (!achievements.memoryRecovery && hasPartialMemory) {
                achievements.memoryRecovery = true;
                showAchievementNotification("Ricordi Recuperati", "Hai recuperato ricordi parziali!");
            }
            
            // Achievement: Spezzamaledizioni
            if (!achievements.curseBreaker && inventory.includes("Amuleto Antico") && inventory.includes("Pergamena di Rune")) {
                achievements.curseBreaker = true;
                showAchievementNotification("Spezzamaledizioni", "Hai trovato gli artefatti per spezzare la maledizione!");
            }
            
            // Achievement: Aiutante dell'Alchimista
            if (!achievements.alchemistHelper && inventory.includes("Pozione di Forza")) {
                achievements.alchemistHelper = true;
                showAchievementNotification("Aiutante dell'Alchimista", "Hai ottenuto una pozione dall'alchimista!");
            }
            
            // Achievement: Studioso della Biblioteca
            if (!achievements.libraryScholar && inventory.includes("Mappa del Tempio")) {
                achievements.libraryScholar = true;
                showAchievementNotification("Studioso della Biblioteca", "Hai trovato la mappa del tempio!");
            }
            
            // Achievement: Esploratore Segreto
            if (!achievements.secretExplorer && foundSecretTunnel) {
                achievements.secretExplorer = true;
                showAchievementNotification("Esploratore Segreto", "Hai scoperto un passaggio segreto!");
            }
        }

        function showAchievementNotification(title, description) {
            // Usa la nuova funzione per achievement dettagliati
            showDetailedAchievement(title, description);
        }

        function showAchievements() {
            // Crea una schermata dedicata per gli achievement
            const achievementScreen = document.createElement('div');
            achievementScreen.id = 'achievement-screen';
            achievementScreen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: 'Cinzel', serif;
            `;

            let achievementText = "<h2 style='color: var(--ds-gold); text-align: center; margin-bottom: 30px;'>🏆 ACHIEVEMENT SBLOCATI</h2>";
            let count = 0;
            
            // Achievement del sistema migliorato
            const allAchievements = {
                'soul_liberator': { title: 'Liberatore di Anime', description: 'Hai liberato 100 anime perdute', unlocked: souls >= 100 },
                'rune_scholar': { title: 'Studioso delle Rune', description: 'Hai decifrato 5 rune antiche', unlocked: inventory.includes('Pergamena di Rune') },
                'golem_friend': { title: 'Amico del Golem', description: 'Hai fatto pace con il Golem di Pietra Antica', unlocked: false },
                'memory_keeper': { title: 'Custode della Memoria', description: 'Hai recuperato tutti i frammenti di memoria', unlocked: inventory.includes('Frammento di Memoria') },
                'curse_breaker': { title: 'Spezzatore di Maledizioni', description: 'Hai rotto il ciclo della maledizione', unlocked: achievements.curseBreaker },
                'dark_ascension': { title: 'Ascensione delle Tenebre', description: 'Hai abbracciato il potere oscuro', unlocked: achievements.darkEnding },
                'survival_sage': { title: 'Saggio della Sopravvivenza', description: 'Hai trovato l\'equilibrio tra luce e ombra', unlocked: achievements.neutralEnding },
                'explorer': { title: 'Esploratore Infaticabile', description: 'Hai visitato tutti i luoghi principali', unlocked: achievements.explorer },
                'craftsman': { title: 'Artigiano Abile', description: 'Hai completato 5 crafting', unlocked: false },
                'guardian': { title: 'Guardiano Riconosciuto', description: 'Hai accettato il tuo ruolo di Guardiano delle Anime', unlocked: false }
            };

            // Achievement legacy
            const legacyAchievements = {
                'firstDeath': { title: 'Prima Morte', description: 'Morire per la prima volta', unlocked: achievements.firstDeath },
                'golemSlayer': { title: 'Cacciatore di Golem', description: 'Sconfiggere il Golem', unlocked: achievements.golemSlayer },
                'treasureHunter': { title: 'Cacciatore di Tesori', description: 'Trovare 5 oggetti', unlocked: achievements.treasureHunter },
                'memoryRecovery': { title: 'Ricordi Recuperati', description: 'Completare sequenza ricordi', unlocked: achievements.memoryRecovery },
                'alchemistHelper': { title: 'Aiutante dell\'Alchimista', description: 'Ottenere pozione dall\'alchimista', unlocked: achievements.alchemistHelper },
                'libraryScholar': { title: 'Studioso della Biblioteca', description: 'Trovare la mappa del tempio', unlocked: achievements.libraryScholar },
                'secretExplorer': { title: 'Esploratore Segreto', description: 'Scoprire passaggio segreto', unlocked: achievements.secretExplorer }
            };

            // Combina tutti gli achievement
            const allAchievementList = { ...allAchievements, ...legacyAchievements };

            achievementText += "<div style='max-height: 400px; overflow-y: auto; padding: 20px;'>";
            
            Object.entries(allAchievementList).forEach(([id, achievement]) => {
                if (achievement.unlocked) {
                    achievementText += `
                        <div style='margin-bottom: 15px; padding: 10px; border: 2px solid var(--ds-gold); border-radius: 8px; background: rgba(212, 175, 55, 0.1);'>
                            <div style='color: var(--ds-gold-light); font-weight: bold;'>✅ ${achievement.title}</div>
                            <div style='color: #ccc; font-size: 0.9em;'>${achievement.description}</div>
                        </div>
                    `;
                    count++;
                }
            });

            if (count === 0) {
                achievementText += "<div style='text-align: center; color: #666;'>Nessun achievement sbloccato ancora.</div>";
            }

            achievementText += "</div>";
            achievementText += "<button onclick='closeAchievementScreen()' style='margin-top: 20px; padding: 10px 20px; background: var(--ds-gold); color: black; border: none; border-radius: 5px; cursor: pointer;'>CHIUDI</button>";

            achievementScreen.innerHTML = achievementText;
            document.body.appendChild(achievementScreen);
        }

        function closeAchievementScreen() {
            const achievementScreen = document.getElementById('achievement-screen');
            if (achievementScreen) {
                achievementScreen.remove();
            }
        }

        // Funzione per verificare lo stato delle route
        function checkRouteStatus() {
            const routeStatus = {
                ricordaPassato: scenes.ricordaPassato && scenes.ricordoParziale && scenes.sogniRicordi,
                gridaAiuto: scenes.gridaAiuto && scenes.guardieArrivano,
                cercaManufatti: scenes.cercaManufatti && scenes.manufattiTrovati,
                apriSarcofago: scenes.apriSarcofago && scenes.combattiMummia && scenes.sconfiggiMummia,
                fuochiSacri: scenes.cercaFuocoSacro && scenes.santuarioIntermedio
            };
            
            console.log("Stato delle route:", routeStatus);
            return routeStatus;
        }

        function showVictoryScreen(endingType = "DEFAULT") {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            
            // Aggiorna statistiche finali avanzate
            document.getElementById('final-souls').textContent = souls;
            document.getElementById('final-items').textContent = inventory.length;
            document.getElementById('final-fires').textContent = "3"; // Fuochi sacri implementati
            
            // Statistiche specifiche per finale
            let endingStats = "";
            switch(endingType) {
                case "BUONO":
                    endingStats = `\n🏆 Finale Buono: Redenzione Completa\n✨ Artefatti raccolti: ${inventory.filter(item => ["Amuleto Antico", "Pergamena di Rune", "Gemma Preziosa", "Corona dell'Anima"].includes(item)).length}/4`;
                    break;
                case "OSCURO":
                    endingStats = `\n⚫ Finale Oscuro: Ascensione delle Tenebre\n💀 Potere oscuro abbracciato`;
                    break;
                case "NEUTRALE":
                    endingStats = `\n⚪ Finale Neutrale: Saggezza della Sopravvivenza\n🧠 Saggezza acquisita`;
                    break;
                default:
                    endingStats = `\n🎉 Finale Standard: Vittoria`;
            }
            
            // Aggiungi statistiche al testo della schermata
            const statsElement = document.getElementById('victory-stats');
            if (statsElement) {
                const statsText = statsElement.querySelector('p:last-child');
                if (statsText) {
                    statsText.textContent += endingStats;
                }
            }
            
            // Personalizza TUTTO in base al finale
            const victoryScreen = document.getElementById('victory-screen');
            const title = victoryScreen.querySelector('h1');
            const description = victoryScreen.querySelector('p');
            const particles = victoryScreen.querySelector('#victory-particles');
            
            // Reset stili di base
            victoryScreen.style.background = '';
            title.style.color = '';
            
            switch(endingType) {
                case "BUONO":
                    title.textContent = "🎉 VITTORIA - La Redenzione Completa";
                    title.style.color = "#8aff8a";
                    description.textContent = "Hai spezzato la maledizione con saggezza e coraggio. La tua anima è stata purificata e hai riportato la pace nel mondo. La luce che hai acceso non si spegnerà mai più.";
                    victoryScreen.style.background = "linear-gradient(135deg, #1a4d1a 0%, #2d5a2d 50%, #1a4d1a 100%)";
                    // Particelle dorate per finale buono
                    if (particles) {
                        particles.querySelectorAll('.particle').forEach(particle => {
                            particle.style.background = 'var(--ds-gold-light)';
                            particle.style.boxShadow = '0 0 15px var(--ds-gold-light)';
                        });
                    }
                    break;
                    
                case "OSCURO":
                    title.textContent = "⚫ VITTORIA - L'Ascensione delle Tenebre";
                    title.style.color = "#ff6b6b";
                    description.textContent = "Hai abbracciato il potere della maledizione. La tua anima è stata trasformata e ora possiedi conoscenze che risalgono all'alba del tempo. Sei diventato qualcosa di nuovo e terribilmente potente.";
                    victoryScreen.style.background = "linear-gradient(135deg, #4d1a1a 0%, #5a2d2d 50%, #4d1a1a 100%)";
                    // Particelle rosse per finale oscuro
                    if (particles) {
                        particles.querySelectorAll('.particle').forEach(particle => {
                            particle.style.background = 'var(--ds-blood)';
                            particle.style.boxShadow = '0 0 15px var(--ds-blood)';
                        });
                    }
                    break;
                    
                case "NEUTRALE":
                    title.textContent = "⚪ VITTORIA - La Saggezza della Sopravvivenza";
                    title.style.color = "#cccccc";
                    description.textContent = "Hai scelto la via della saggezza. A volte la vera forza sta nel sapere quando ritirarsi. La maledizione rimane, ma ora la vedi per quello che è: una sfida da affrontare quando sarai pronto.";
                    victoryScreen.style.background = "linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 50%, #2d2d2d 100%)";
                    // Particelle grigie per finale neutrale
                    if (particles) {
                        particles.querySelectorAll('.particle').forEach(particle => {
                            particle.style.background = '#cccccc';
                            particle.style.boxShadow = '0 0 15px #cccccc';
                        });
                    }
                    break;
                    
                default:
                    title.textContent = "🎉 VITTORIA!";
                    title.style.color = "#8aff8a";
                    description.textContent = "Hai spezzato la maledizione che ti legava a questo luogo! La tua memoria ritorna, e con essa, un senso di pace e libertà. Il viaggio è compiuto.";
                    // Particelle dorate per finale default
                    if (particles) {
                        particles.querySelectorAll('.particle').forEach(particle => {
                            particle.style.background = 'var(--ds-gold-light)';
                            particle.style.boxShadow = '0 0 15px var(--ds-gold-light)';
                        });
                    }
            }
            
            victoryScreen.style.display = 'flex';
            victoryScreen.style.opacity = '0';
            victoryScreen.style.transform = 'scale(0.9)';
            
            // Animazione di entrata per la schermata di vittoria
            setTimeout(() => {
                victoryScreen.style.transition = 'all 0.8s ease-in-out';
                victoryScreen.style.opacity = '1';
                victoryScreen.style.transform = 'scale(1)';
                
                // Attiva particelle specifiche per il finale
                addVictoryParticles();
            }, 100);
        }

        function newGame() {
            document.getElementById('victory-screen').style.display = 'none';
            startGame();
        }

        function returnToMenu() {
            document.getElementById('victory-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Pulisci TUTTI i salvataggi per sicurezza
            localStorage.removeItem('soulJourneySave');
            console.log("Tutti i salvataggi rimossi per sicurezza");
            
            // Inizializza le variabili di base per evitare errori
            if (typeof inventory === 'undefined') {
                inventory = [];
            }
            if (typeof souls === 'undefined') {
                souls = 0;
            }
            if (typeof playerHealth === 'undefined') {
                playerHealth = maxHealth;
            }
            
            // Assicurati che la schermata iniziale sia visibile
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('victory-screen').style.display = 'none';
            document.getElementById('death-screen').style.display = 'none';
            
            updateUI();
            hideDeathScreen();
            
            // Aggiungi effetti sonori (simulati con vibrazione su mobile)
            if ('vibrate' in navigator) {
                // Vibrazione per azioni importanti
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('choice-button')) {
                        navigator.vibrate(50);
                    }
                });
            }
            
            // Migliora l'esperienza mobile
            if (window.innerWidth <= 768) {
                // Aumenta la dimensione dei pulsanti su mobile
                const buttons = document.querySelectorAll('.choice-button');
                buttons.forEach(button => {
                    button.style.minHeight = '60px';
                    button.style.fontSize = '1.1em';
                });
            }
            
            // Aggiungi scorciatoie da tastiera
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                        const choiceIndex = parseInt(e.key) - 1;
                        const buttons = document.querySelectorAll('.choice-button');
                        if (buttons[choiceIndex]) {
                            buttons[choiceIndex].click();
                        }
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            saveGame();
                        }
                        break;
                    case 'Escape':
                        // Torna al menu principale
                        if (document.getElementById('game-container').style.display === 'flex') {
                            document.getElementById('start-screen').style.display = 'flex';
                            document.getElementById('game-container').style.display = 'none';
                        }
                        break;
                }
            });
        });

        // ============================================================================
        // FUNZIONI DI SUPPORTO PER I SISTEMI NARRATIVI
        // ============================================================================
        
        // Funzione per gestire azioni una sola volta
        function executeActionOnce(actionId, callback) {
            if (!completedActions.has(actionId)) {
                completedActions.add(actionId);
                callback();
                return true; // Azione eseguita
            }
            return false; // Azione già eseguita
        }
        
        // Funzione per verificare se una scena è già stata visitata
        function isSceneVisited(sceneId) {
            return visitedScenes.has(sceneId);
        }
        
        // Funzione per marcare una scena come visitata
        function markSceneVisited(sceneId) {
            visitedScenes.add(sceneId);
        }

        function showMemoryScene(flashback) {
            // Mostra una scena di flashback
            const gameContainer = document.getElementById('game-container');
            const storyText = document.getElementById('story-text');
            const choicesContainer = document.getElementById('choices-container');
            
            // Controlli di sicurezza per evitare errori
            if (!gameContainer || !storyText || !choicesContainer) {
                console.error('Elementi DOM non trovati per il flashback');
                return;
            }
            
            if (!flashback || !flashback.title || !flashback.text || !flashback.choices) {
                console.error('Flashback non valido:', flashback);
                return;
            }
            
            // Salva lo stato corrente
            if (!window.sceneHistory) {
                window.sceneHistory = [];
            }
            window.sceneHistory.push({
                text: storyText.innerHTML,
                choices: Array.from(choicesContainer.children).map(btn => btn.textContent)
            });
            
            // Mostra il flashback
            storyText.innerHTML = `
                <div class="memory-flashback">
                    <h2 style="color: var(--ds-gold); text-align: center; margin-bottom: 20px;">
                        ${flashback.title}
                    </h2>
                    <p style="font-style: italic; color: var(--ds-gold-light); line-height: 1.6;">
                        ${flashback.text}
                    </p>
                </div>
            `;
            
            // Mostra le scelte del flashback
            choicesContainer.innerHTML = '';
            flashback.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-button memory-choice';
                button.textContent = choice.text;
                button.onclick = choice.action;
                choicesContainer.appendChild(button);
            });
            
            // Aggiungi stili speciali per i flashback
            gameContainer.classList.add('memory-mode');
            
            console.log('Flashback mostrato:', flashback.title);
        }

        function restoreChoices(choices) {
            // Ripristina le scelte precedenti (da implementare in base al tuo sistema)
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            // Qui dovrai implementare la logica per ricreare i pulsanti delle scelte
            console.log('Ripristinando scelte:', choices);
        }

        // Aggiungi stili CSS per i nuovi elementi
        const additionalStyles = `
            <style>
                .memory-flashback {
                    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(0, 0, 0, 0.8) 100%);
                    border: 2px solid var(--ds-gold);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                }
                
                .memory-choice {
                    background: linear-gradient(135deg, var(--ds-gold) 0%, var(--ds-gold-dark) 100%);
                    color: var(--ds-black);
                    border: 2px solid var(--ds-gold-light);
                    font-weight: bold;
                }
                
                .memory-choice:hover {
                    background: linear-gradient(135deg, var(--ds-gold-light) 0%, var(--ds-gold) 100%);
                    box-shadow: 0 0 15px var(--ds-gold-glow);
                }
                
                .memory-mode {
                    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(0, 0, 0, 0.95) 100%);
                }
                
                .karma-change {
                    animation: fadeInOut 2s ease-in-out;
                }
                
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(-20px); }
                    20% { opacity: 1; transform: translateY(0); }
                    80% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
            </style>
        `;

        // Inserisci gli stili nel documento
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // Cache DOM per ottimizzazione FASE 4
        const domCache = {
            storyText: null,
            choicesContainer: null,
            healthDisplay: null,
            karmaDisplay: null,
            
            init: function() {
                this.storyText = document.getElementById('story-text');
                this.choicesContainer = document.getElementById('choices-container');
                this.healthDisplay = document.getElementById('health-display');
                this.karmaDisplay = document.getElementById('karma-display');
                console.log('Cache DOM inizializzata');
            },
            
            updateStory: function(text) {
                if (this.storyText) {
                    this.storyText.innerHTML = text;
                }
            },
            
            updateChoices: function(choices) {
                if (this.choicesContainer) {
                    this.choicesContainer.innerHTML = '';
                    choices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice.text;
                        button.onclick = choice.action;
                        this.choicesContainer.appendChild(button);
                    });
                }
            }
        };
        
        // Cleanup automatico per ottimizzazione memoria
        function cleanupMemory() {
            // Rimuovi event listeners non necessari
            if (window.sceneHistory && window.sceneHistory.length > 10) {
                window.sceneHistory = window.sceneHistory.slice(-5);
            }
            
            // Cleanup flashback
            if (window.currentFlashback) {
                window.currentFlashback = null;
            }
            
            console.log('Cleanup memoria eseguito');
        }
        
        // Inizializza i sistemi quando il documento è caricato
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistemi narrativi inizializzati');
            console.log('Memory System:', memorySystem);
            console.log('Karma System:', karmaSystem);
            console.log('Consequence System:', consequenceSystem);
            
            // Inizializza cache DOM
            domCache.init();
            
            // Avvia cleanup periodico
            setInterval(cleanupMemory, 30000); // Ogni 30 secondi
        });

        // Esporta i sistemi per uso globale
        window.memorySystem = memorySystem;
        window.karmaSystem = karmaSystem;
        window.consequenceSystem = consequenceSystem;

        // Sistema di descrizioni oggetti
        let itemDescriptions = {
            "Chiave Arrugginita": {
                type: "Chiave",
                effect: "Apre porte chiuse",
                rarity: "Comune",
                value: 5
            },
            "Mappa Rudimentale": {
                type: "Mappa",
                effect: "Rivela passaggi nascosti",
                rarity: "Comune",
                value: 10
            },
            "Sacca di Cuoio": {
                type: "Contenitore",
                effect: "Contiene 20 anime",
                rarity: "Comune",
                value: 20
            },
            "Erba Curativa": {
                type: "Ingrediente",
                effect: "Cura 25 HP",
                rarity: "Comune",
                value: 15
            },
            "Erba di Forza": {
                type: "Ingrediente",
                effect: "Aumenta forza temporaneamente",
                rarity: "Raro",
                value: 25
            },
            "Acqua Pura": {
                type: "Ingrediente",
                effect: "Disintossica e cura",
                rarity: "Comune",
                value: 10
            },
            "Frammento di Memoria": {
                type: "Artefatto",
                effect: "Rivela ricordi del passato",
                rarity: "Raro",
                value: 50
            },
            "Conoscenza del Passato": {
                type: "Artefatto",
                effect: "Conoscenza antica",
                rarity: "Epico",
                value: 100
            },
            "Pozione di Salute": {
                type: "Pozione",
                effect: "Ripristina 50 HP",
                rarity: "Comune",
                value: 35
            },
            "Pozione di Forza": {
                type: "Pozione",
                effect: "Aumenta forza temporaneamente",
                rarity: "Raro",
                value: 50
            },
            "Cristallo di Potenza": {
                type: "Ingrediente",
                effect: "Potenziamento magico",
                rarity: "Raro",
                value: 40
            },
            "Cristallo di Anima": {
                type: "Ingrediente",
                effect: "Energia spirituale",
                rarity: "Epico",
                value: 80
            },
            "Spada Arrugginita": {
                type: "Arma",
                effect: "Danno fisico aumentato",
                rarity: "Comune",
                value: 30
            },
            "Amuleto Antico": {
                type: "Artefatto",
                effect: "Protezione arcana",
                rarity: "Leggendario",
                value: 200
            },
            "Pergamena di Rune": {
                type: "Artefatto",
                effect: "Conoscenza delle rune",
                rarity: "Epico",
                value: 150
            },
            "Gemma Preziosa": {
                type: "Artefatto",
                effect: "Potere magico puro",
                rarity: "Leggendario",
                value: 300
            },
            "Corona dell'Anima": {
                type: "Artefatto",
                effect: "Controllo dell'anima",
                rarity: "Mito",
                value: 500
            },
            "Mappa del Tempio": {
                type: "Mappa",
                effect: "Rivela segreti del tempio",
                rarity: "Raro",
                value: 60
            },
            "Amuleto delle Rovine": {
                type: "Artefatto",
                effect: "Protezione dalle rovine",
                rarity: "Epico",
                value: 120
            }
        };
    </script>
</body>
</html>
